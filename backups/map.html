<!DOCTYPE html>
<html>

<head>
    <title>DCS Mission Planner</title>
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@joergdietrich/leaflet.terminator/L.Terminator.js"></script>
    <script src="https://unpkg.com/milsymbol@2.0.0/dist/milsymbol.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        /* --- DYNAMIC MAP FILTERS --- */
        /* These variables will be updated by JS per map type */
        .leaflet-tile-pane {
            filter: brightness(var(--map-br, 1.0)) contrast(var(--map-con, 1.0)) opacity(var(--map-op, 1.0)) !important;
        }

        /* --- DYNAMIC NVG MODES --- */
        body.nvg-red {
            filter: sepia(var(--nvg-sepia)) hue-rotate(var(--nvg-hue)) saturate(var(--nvg-saturate)) contrast(var(--nvg-con)) brightness(var(--nvg-br)) !important;
        }

        body.nvg-green {
            filter: sepia(var(--nvg-sepia)) hue-rotate(var(--nvg-hue)) saturate(var(--nvg-saturate)) contrast(var(--nvg-con)) brightness(var(--nvg-br)) !important;
        }

        /* --- CORE STYLES --- */

        :root {
            --bg-dark: #151d21;
            --bg-panel: #2b3a41;
            --bg-hover: #4a6069;
            --text-main: #d1e3ea;
            --accent: #78aabc;
            --red-for: #e74c3c;
            --active-leg: #00ff00;
        }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            font-size: var(--font-size-base);
            touch-action: none;
        }

        #map-wrapper {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
        }

        /* HUD OVERLAY */
        #hud-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            pointer-events: none;
            border: none;
            display: none;
            background: transparent !important;
        }

        #hud-overlay.visible {
            display: block;
        }

        /* VIRTUAL CURSOR CONTAINER */
        #virtual-cursor {
            pointer-events: none;
            z-index: 9999;
            width: 32px;
            height: 32px;
            position: fixed;
            display: none;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* BOTTOM STATUS BAR */
        #bottom-bar {
            min-height: calc(30px * var(--ui-scale));
            background: #0f1518;
            border-top: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 calc(15px * var(--ui-scale));
            font-family: 'Consolas', monospace;
            font-size: var(--font-size-base);
            font-weight: bold;
            z-index: 3000;
        }

        .bar-section {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .bar-item {
            display: flex;
            gap: 8px;
            align-items: center;
            color: #888;
        }

        .bar-val {
            color: var(--accent);
        }

        .bar-item i {
            font-size: 11px;
        }

        /* Sidebar Visibility Logic */
        .info-pill {
            display: none;
            align-items: center;
            gap: 5px;
        }

        .info-pill.visible {
            display: flex;
        }

        /* SIDEBARS */
        .sidebar {
            position: absolute;
            top: 0;
            bottom: var(--bottom-bar-height);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
            pointer-events: auto;
            overflow-y: auto;
            width: fit-content;
            justify-content: center;
        }

        .sidebar>* {
            pointer-events: auto;
        }

        #sidebar-left {
            left: 0;
            padding-bottom: calc(var(--btn-size) + 5px);
        }

        #sidebar-right {
            right: 0;
            align-items: flex-end;
        }

        .sidebar.hidden-left {
            transform: translateX(-150%);
        }

        .sidebar.hidden-right {
            transform: translateX(150%);
        }

        /* LAYOUT MENU */
        #layout-menu {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 2500;
        }

        #layout-dropdown {
            position: absolute;
            top: 40px;
            left: 0;
            background: var(--bg-panel);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 5px;
            display: none;
            flex-direction: column;
            gap: 5px;
            min-width: 100px;
        }

        #layout-menu:hover #layout-dropdown {
            display: flex;
        }

        .chk-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            cursor: pointer;
            padding: 4px;
        }

        .chk-row:hover {
            background: var(--bg-hover);
        }

        /* BUTTONS */
        .btn-square {
            width: var(--btn-size);
            height: var(--btn-size);
            min-width: var(--btn-size);
            min-height: var(--btn-size);
            flex-shrink: 0;
            background-color: var(--bg-panel);
            color: var(--text-main);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
            position: relative;
            font-size: calc(16px * var(--ui-scale));
        }

        .btn-square:hover {
            background-color: var(--bg-hover);
            transform: scale(1.05);
            z-index: 2001;
        }

        .btn-square.active {
            border: 2px solid var(--accent);
            color: var(--accent);
            background: rgba(120, 170, 188, 0.2);
        }

        /* --- DRAG & DROP STYLES --- */
        .draggable-row {
            cursor: grab;
        }

        .draggable-row.dragging {
            opacity: 0.5;
            background: var(--bg-hover) !important;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .drag-handle {
            cursor: grab;
            color: #777;
            padding: 0 5px;
        }

        .drag-handle:hover {
            color: #fff;
        }

        /* DRAWERS */
        .drawer-panel {
            position: absolute;
            left: 70px;
            top: 10px;
            bottom: calc(var(--bottom-bar-height) + 10px);
            width: min(380px, calc(100vw - 90px));
            background: rgba(21, 29, 33, 0.95);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 1500;
            overflow-y: auto;
        }

        .drawer-panel.open {
            display: flex;
        }

        .panel-header {
            font-size: 18px;
            font-weight: bold;
            border-bottom: 1px solid var(--accent);
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .route-view {
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 100%;
        }

        /* --- UPDATED LIST STYLES (FLEXBOX) --- */
        .saved-route-item,
        .route-item {
            display: flex;
            /* Flexbox fixes the "gap" and alignment */
            align-items: center;
            gap: 8px;
            /* Consistent spacing */
            padding: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border-left: 3px solid transparent;
            transition: background 0.2s, transform 0.1s;
            /* Adds subtle feel */
            cursor: grab;
            margin-bottom: 4px;
        }

        /* CRUCIAL: Prevents children from breaking the drag detection */
        .saved-route-item>*,
        .route-item>* {
            pointer-events: none;
        }

        /* Re-enable clicks for buttons/inputs */
        .saved-route-item button,
        .saved-route-item input,
        .saved-route-item select,
        .route-item button,
        .route-item input,
        .route-item select {
            pointer-events: auto;
        }

        .saved-route-item:hover,
        .route-item:hover {
            background: var(--bg-hover);
        }

        .saved-route-item.is-active {
            background: rgba(46, 204, 113, 0.15);
            border-left-color: #2ecc71;
        }

        /* Visual feedback when dragging */
        .saved-route-item.dragging,
        .route-item.dragging {
            opacity: 0.5;
            background: #000;
            border: 1px dashed #555;
        }

        .list-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 30px;
        }

        .list-btn:hover {
            color: #fff;
        }

        .list-btn.active {
            color: var(--accent);
        }

        .list-btn.delete:hover {
            color: var(--red-for);
        }

        input.color-picker-mini {
            width: 25px;
            height: 25px;
            border: none;
            padding: 0;
            background: none;
            cursor: pointer;
        }

        .seq-toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #111;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #444;
        }

        .seq-status {
            font-weight: bold;
            color: #555;
        }

        .seq-status.on {
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }

        .route-list-container {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .route-footer {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            font-family: 'Consolas';
            border-top: 1px solid #555;
        }

        .form-row {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin-bottom: 3px;
        }

        label {
            font-size: 11px;
            color: #aaa;
            text-transform: uppercase;
        }

        input,
        select {
            background: #111;
            border: 1px solid #555;
            color: #fff;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
        }

        .input-group {
            display: flex;
            gap: 5px;
        }

        /* THREAT RINGS UI */
        .threat-row {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            margin-top: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .threat-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .threat-input-group label {
            width: 80px;
            font-size: 10px;
            color: #aaa;
            text-transform: uppercase;
        }

        .threat-input-group input[type="number"] {
            flex-grow: 1;
            height: 25px;
            padding: 2px 5px;
            background: #111;
            border: 1px solid #555;
            color: #fff;
        }

        .threat-input-group input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        /* TACTICAL BUTTONS */
        .btn-full {
            background-color: var(--bg-panel);
            color: var(--text-main);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            font-family: 'Consolas', monospace;
            text-transform: uppercase;
            font-size: 12px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-full:hover {
            background-color: var(--bg-hover);
            border-color: var(--accent);
            color: #fff;
            box-shadow: 0 0 8px rgba(120, 170, 188, 0.3);
        }

        /* Button Variants */
        .btn-action {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-action:hover {
            background-color: rgba(120, 170, 188, 0.15);
        }

        .btn-alert {
            border-color: #e67e22;
            color: #e67e22;
        }

        .btn-alert:hover {
            background-color: rgba(230, 126, 34, 0.15);
            border-color: #e67e22;
            box-shadow: 0 0 8px rgba(230, 126, 34, 0.3);
        }

        .btn-success {
            border-color: var(--active-leg);
            color: var(--active-leg);
        }

        .btn-success:hover {
            background-color: rgba(0, 255, 0, 0.1);
            border-color: var(--active-leg);
            box-shadow: 0 0 8px rgba(0, 255, 0, 0.3);
        }

        .btn-danger {
            border-color: var(--red-for);
            color: var(--red-for);
        }

        .btn-danger:hover {
            background-color: rgba(231, 76, 60, 0.15);
            border-color: var(--red-for);
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.3);
        }

        .btn-full:hover {
            background: var(--accent);
        }

        /* --- MILITARY TOGGLES --- */
        .mil-toggle {
            background: rgba(0, 0, 0, 0.4);
            border: 1px dashed #555;
            color: #555;
            padding: 8px;
            text-align: center;
            font-family: 'Consolas', monospace;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .mil-toggle:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: #777;
            color: #777;
        }

        /* Active States */
        /* --- VIRTUAL POINTER --- */
        #virtual-cursor {
            position: absolute;
            top: 0;
            left: 0;
            width: 20px;
            height: 20px;
            background: rgba(255, 0, 0, 0.7);
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            /* Center it */
            pointer-events: none;
            /* Let clicks pass through if we use elementFromPoint */
            z-index: 9999;
            display: none;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
            transition: transform 0.05s linear;
        }

        .mil-toggle.active.red {
            background: rgba(231, 76, 60, 0.15);
            border: 1px solid #e74c3c;
            color: #e74c3c;
            box-shadow: 0 0 5px rgba(231, 76, 60, 0.2);
        }

        .mil-toggle.active.blue {
            background: rgba(52, 152, 219, 0.15);
            border: 1px solid #3498db;
            color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.2);
        }

        .mil-toggle.active.neutral {
            background: rgba(180, 180, 180, 0.15);
            border: 1px solid #aaa;
            color: #aaa;
            box-shadow: 0 0 5px rgba(180, 180, 180, 0.2);
        }

        .mil-toggle.active:hover {
            filter: brightness(1.2);
        }

        #toast {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: #000;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            z-index: 3000;
        }

        #toast.show {
            opacity: 1;
        }

        /* MINI ROUTE PANEL */
        #mini-route-panel {
            position: absolute;
            top: 10px;
            left: 70px;
            z-index: 1500;
            background: rgba(21, 29, 33, 0.95);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 10px;
            display: none;
            gap: 10px;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        #mini-route-panel.visible {
            display: flex;
        }

        .mini-info {
            display: flex;
            flex-direction: column;
        }

        .mini-title {
            font-size: 10px;
            color: #aaa;
            text-transform: uppercase;
            font-weight: bold;
        }

        .mini-val {
            font-size: 14px;
            color: #fff;
            font-weight: bold;
            white-space: nowrap;
        }

        .mini-btn {
            background: var(--bg-panel);
            border: 1px solid #555;
            color: #fff;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mini-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        /* USER PLANE CONTAINER */
        .jet-container {
            transition: transform 0.1s linear;
        }

        /* MEASURE TOOL STYLES (Clean/Dark) */
        .measure-label,
        .bearing-label {
            background: rgba(21, 29, 33, 0.9);
            color: #d1e3ea;
            border: 1px solid var(--accent);
            padding: 2px 6px;
            font-size: 11px;
            font-family: 'Consolas', monospace;
            font-weight: bold;
            white-space: nowrap;
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .unit-badge {
            color: #888;
            font-size: 10px;
            padding: 0 5px;
            display: flex;
            align-items: center;
            background: #222;
            border: 1px solid #555;
            border-left: none;
            border-radius: 0 4px 4px 0;
            min-width: 25px;
            justify-content: center;
        }

        /* --- SCRATCHPAD (Scratchpad) --- */
        #scratchpad-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1900;
            pointer-events: none;
            display: none;
            overflow: hidden;
        }

        #scratchpad-canvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        /* MODES */
        #scratchpad-layer.mode-active {
            display: block;
            pointer-events: auto;
            cursor: crosshair;
        }

        #scratchpad-layer.mode-passive {
            display: block;
            pointer-events: none;
        }

        #scratchpad-layer.cursor-text {
            cursor: text;
            pointer-events: auto !important;
        }

        /* SUB-SIDEBAR (Toolbox) */
        #sp-sub-sidebar {
            position: absolute;
            right: 65px;
            /* Aligned left of the 50px sidebar */
            /* Dynamic Bottom Calculation */
            bottom: calc(var(--bottom-bar-height) + 60px);
            width: 45px;
            display: none;
            flex-direction: column-reverse;
            /* Stack grows UPWARDS */
            gap: 5px;
            pointer-events: auto;
            z-index: 2100;
            align-items: center;
        }

        /* Hide tool items by default so we don't need inline styles */
        .sp-tool-item {
            display: none;
        }

        #sp-sub-sidebar.visible {
            display: flex;
        }

        #sp-sub-sidebar.expanded .sp-tool-item {
            display: block;
        }

        /* Tool Button Tweaks */
        #sp-sub-sidebar .btn-square {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            font-size: 14px;
            margin-bottom: 0;
        }

        /* POPOUTS */
        .sp-tool-wrapper {
            position: relative;
        }

        .sp-popout {
            position: absolute;
            right: 50px;
            top: 0;
            background: var(--bg-panel);
            border: 1px solid var(--accent);
            padding: 10px;
            border-radius: 8px;
            display: none;
            flex-direction: column;
            gap: 5px;
            min-width: 140px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.9);
        }

        .sp-popout.show {
            display: flex;
        }

        .sp-popout label {
            font-size: 10px;
            color: #aaa;
            text-transform: uppercase;
            margin-bottom: 2px;
            display: block;
        }

        /* COLOR DOTS */
        .color-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .color-dot:hover {
            transform: scale(1.1);
            border-color: #fff;
        }

        /* IN-PLACE TEXT INPUT CLOUD */
        #sp-text-input-box {
            position: absolute;
            background: var(--bg-panel);
            border: 1px solid var(--accent);
            padding: 8px;
            border-radius: 20px 20px 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.8);
            z-index: 2500;
            display: flex;
            gap: 5px;
            align-items: center;
            pointer-events: auto;
        }

        #sp-text-input {
            background: #151d21;
            border: none;
            color: #fff;
            border-radius: 4px;
            padding: 8px;
            outline: none;
            min-width: 150px;
        }

        #sp-text-input-box button {
            background: var(--accent);
            border: none;
            border-radius: 4px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-size: 14px;
        }

        /* ACTIVE STATES */
        .btn-square.sp-tool-active {
            border-color: var(--accent);
            background: rgba(120, 170, 188, 0.2);
            color: var(--accent);
            box-shadow: 0 0 8px var(--accent);
        }

        .btn-square.sp-active-glow {
            border-color: #2ecc71;
            color: #2ecc71;
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
            text-shadow: 0 0 5px #2ecc71;
            animation: pulse-green 2s infinite;
        }

        .btn-square.sp-passive-eye {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(120, 170, 188, 0.1);
        }

        /* --- 1. FIXED SCRATCHPAD LABEL (Teal & Tactical) --- */
        #sp-text-cursor {
            /* Position fixed to float above the bottom bar */
            position: fixed;
            bottom: 4px;
            /* Vertically centered in the ~30px bottom bar */
            left: 50%;
            /* Horizontal Center */
            transform: translateX(-50%);
            /* Center alignment correction */

            /* Teal Theme Colors matching the bar aesthetics */
            background: rgba(15, 21, 24, 0.95);
            /* Matches bottom-bar #0f1518 */
            border: 1px solid var(--accent);
            color: var(--accent);

            /* Typography */
            font-family: 'Consolas', monospace;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: nowrap;

            /* Shape */
            padding: 2px 5px;
            border-radius: 4px;
            /* High Z-Index to ensure it sits ON TOP of the bottom bar (z-3000) */
            z-index: 3500;
            display: none;
            pointer-events: none;
            /* Let clicks pass through to the bar if needed */
        }

        /* Only visible in active mode */
        #scratchpad-layer.mode-active #sp-text-cursor {
            display: block;
        }

        /* --- 2. FIX SIDEBAR ICON SIZES --- */
        /* Forces all main sidebar icons to be consistent size */
        .sidebar .btn-square {
            font-size: 18px !important;
            /* Forces consistent icon size */
        }

        /* --- 3. FIX SUB-SIDEBAR (Toolbox) ALIGNMENT --- */
        #sp-sub-sidebar .btn-square {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            font-size: 14px !important;
            /* Tools are slightly smaller */
            margin-bottom: 0;

            /* Perfect Centering Fix */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        /* Fix for the Trash Icon specifically if it feels off-center */
        #sp-sub-sidebar .fa-trash {
            transform: translateY(0px);
            /* Adjust if visual weight is still off */
        }

        /* --- POPUP MENU - UPDATED FOR LAYERS --- */
        .popup-menu {
            position: fixed;
            /* Changed from absolute */
            /* Remove 'right: 115%' and 'top: 0' - JS will handle this */
            background: var(--bg-panel);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 5px;
            display: none;
            flex-direction: column;
            gap: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            min-width: 160px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 6000;
            /* Ensure it's on top of sidebar (2000) and toast (3000) */
        }

        .popup-menu.show {
            display: flex;
        }

        .menu-item {
            background: transparent;
            border: none;
            color: var(--text-main);
            text-align: left;
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-item:hover {
            background: var(--bg-hover);
        }

        .menu-item.active {
            background: rgba(120, 170, 188, 0.2);
            border-left: 2px solid var(--accent);
        }

        .overlay-chk {
            pointer-events: none;
            width: 14px;
            height: 14px;
        }

        /* Data Cartridge  MODALS */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 5000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }

        .modal-box {
            background: var(--bg-panel);
            border: 1px solid var(--accent);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 8px;
            padding: 20px;
            color: #fff;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-header {
            font-size: 18px;
            font-weight: bold;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            color: var(--accent);
            display: flex;
            justify-content: space-between;
        }

        .modal-section {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #444;
        }

        .modal-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #aaa;
            display: block;
            margin-bottom: 5px;
        }

        #qr-output {
            background: #fff;
            padding: 10px;
            align-self: center;
            border-radius: 4px;
            margin: 10px 0;
        }

        #reader {
            width: 100%;
            border: 1px solid #444;
            background: #000;
        }

        .chk-list {
            max-height: 150px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .chk-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
        }

        .chk-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .chk-item input {
            margin: 0;
            cursor: pointer;
        }

        /* TACTICAL DROP ZONE */
        .drop-zone {
            border: 2px dashed #444;
            border-radius: 6px;
            padding: 25px;
            text-align: center;
            background: rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #777;
            margin-top: 10px;
        }

        .drop-zone:hover {
            border-color: var(--accent);
            background: rgba(120, 170, 188, 0.05);
            color: var(--accent);
        }

        .drop-zone.dragover {
            border-color: #e67e22;
            /* Amber for active drag */
            background: rgba(230, 126, 34, 0.1);
            color: #e67e22;
        }

        .drop-zone i {
            font-size: 24px;
            margin-bottom: 10px;
            transition: color 0.2s;
        }

        /* CAMERA VIEWPORT */
        .camera-viewport {
            width: 100%;
            background: #000;
            border: 1px solid #444;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            min-height: 250px;
        }

        /* CAMERA VIDEO STYLING */
        #reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
            border-radius: 4px;
        }

        /* AIRPORT LABELS */
        .airport-label {
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: #bbb;
            font-weight: bold;
            font-family: 'Consolas';
            font-size: 10px;
            box-shadow: none;
        }

        /* VIRTUAL KEYBOARD */
        #virtual-keyboard {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2b3a41;
            border: 1px solid #78aabc;
            border-radius: 8px;
            padding: 10px;
            z-index: 9999;
            display: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.8);
            flex-direction: column;
            gap: 5px;
            min-width: 250px;
        }

        #virtual-keyboard.visible {
            display: flex;
        }

        .kb-row {
            display: flex;
            justify-content: center;
            gap: 5px;
        }

        .kb-key {
            background: #151d21;
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            min-width: 30px;
            height: 35px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .kb-key:hover {
            background: #78aabc;
            color: #000;
        }

        .kb-key.wide {
            flex-grow: 1;
        }

        .kb-key.action {
            background: #3a2b2b;
            color: #e74c3c;
        }

        .kb-key.enter {
            background: #2b3a2b;
            color: #2ecc71;
        }

        .input-with-kb {
            display: flex;
            align-items: center;
            gap: 5px;
            width: 100%;
        }

        .input-with-kb input {
            flex-grow: 1;
        }

        .kb-trigger {
            color: #78aabc;
            cursor: pointer;
            padding: 5px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #111;
        }

        .kb-trigger:hover {
            background: #333;
        }

        /* ICON GRID FOR POI */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr) !important;
            /* 5 Columns */
            gap: 3px;
            margin-top: 5px;
        }

        .icon-opt {
            background: #4d6875;
            border: 1px solid #555;
            color: #bbb;
            height: 40px;
            /* Compact height */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            font-size: 10px;
            /* Smaller text */
            font-weight: bold;
            line-height: 1.1;
            text-transform: uppercase;
            padding: 1px;
            transition: all 0.1s ease;
        }

        .icon-opt canvas {
            max-height: 38px !important;
            /* Ensure symbol fits */
            width: auto !important;
            margin-bottom: -2px;
        }

        .icon-opt:hover {
            border-color: #fff;
            color: #fff;
        }

        .icon-opt.selected {
            background: var(--bg-hover);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* --- CORE STYLES --- */
        :root {
            --bg-dark: #151d21;
            --bg-panel: #2b3a41;
            --bg-hover: #4a6069;
            --text-main: #d1e3ea;
            --accent: #78aabc;
            --red-for: #e74c3c;
            --active-leg: #00ff00;

            /* UI SCALING */
            --bottom-bar-height: calc(30px * var(--ui-scale));
            --ui-scale: 1.0;
            /* Default scale */
            --btn-size: calc(45px * var(--ui-scale));
            --font-size-base: calc(13px * var(--ui-scale));

            /* GRID COLORS (Defaults) */
            --mgrs-color: #733f59;
            --mgrs-gzd-color: #988035;
            --latlon-color: #00ffcc;
            /* NEW VARIABLE */

            --mgrs-text-stroke: 1px 0 0 #000, -1px 0 0 #000, 0 1px 0 #000, 0 -1px 0 #000;
        }

        /* MGRS RULER STYLES */
        /* 1. MOVE LAYOUT MENU TO BOTTOM LEFT */
        #layout-menu {
            position: absolute;
            bottom: calc(var(--bottom-bar-height) + 10px);
            left: 10px;
            top: auto;
            /* Clear top positioning */
            z-index: 2500;
        }

        #layout-dropdown {
            top: auto;
            bottom: 100%;
            /* Open upwards */
            margin-bottom: 5px;
        }

        /* --- MGRS GRID STYLES --- */
        :root {
            --mgrs-color: #733f59;
            --mgrs-gzd-color: #988035;
            --mgrs-text-stroke: 1px 0 0 #000, -1px 0 0 #000, 0 1px 0 #000, 0 -1px 0 #000;
        }

        .mgrs-line-base {
            fill: none;
            stroke-linecap: square;
            stroke-dasharray: 4, 6;
        }

        .mgrs-line-gzd-high {
            stroke: var(--mgrs-gzd-color);
            stroke-width: 1.75;
            stroke-opacity: 1.0;
        }

        .mgrs-line-gzd-low {
            stroke: var(--mgrs-gzd-color);
            stroke-width: 1;
            stroke-opacity: 0.7;
        }

        .mgrs-line-high {
            stroke: var(--mgrs-color);
            stroke-width: 1.75;
            stroke-opacity: 1.0;
        }

        .mgrs-line-low {
            stroke: var(--mgrs-color);
            stroke-width: 1;
            stroke-opacity: 0.6;
        }

        /* --- VIRTUAL POINTER --- */
        #virtual-cursor {
            width: 32px;
            height: 32px;
            position: fixed;
            z-index: 10000;
            pointer-events: none;
            display: none;
            /* Crosshair SVG - Default overwritten by JS */
            background: none;
            background-repeat: no-repeat;
            /* Center Hotspot handled via transform logic */
            transition: transform 0.05s linear;
        }

        /* Removed pseudo-element ::after as we use SVG */

        .pointer-click-anim {
            position: fixed;
            width: 40px;
            height: 40px;
            border: 2px solid #00ff00;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: ping 0.5s ease-out forwards;
            pointer-events: none;
            z-index: 9998;
        }

        @keyframes ping {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(2.0);
                opacity: 0;
            }
        }

        /* LABELS */
        .mgrs-label-gzd-corner {
            font-family: 'Consolas', monospace;
            font-weight: bold;
            font-size: 16px;
            color: var(--mgrs-gzd-color);
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
        }

        .mgrs-label-gzd-axis {
            color: var(--mgrs-gzd-color);
            font-family: 'Consolas', monospace;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 1px 1px 0 #000;
            pointer-events: none;
        }

        .mgrs-label-center {
            font-family: 'Consolas', monospace;
            font-weight: bold;
            font-size: 14px;
            color: var(--mgrs-color);
            opacity: 0.9;
            text-shadow: var(--mgrs-text-stroke);
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .mgrs-label-edge-header {
            font-family: 'Consolas', monospace;
            font-weight: bold;
            font-size: 16px;
            color: var(--mgrs-color);
            text-shadow: 0 0 4px #000, 0 0 8px var(--mgrs-color);
            pointer-events: none;
        }

        .mgrs-label-digit {
            color: var(--mgrs-color);
            font-family: 'Consolas', monospace;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 1px 1px 0 #000;
            pointer-events: none;
        }

        /* --- SETTINGS DRAWER UTILS --- */
        .sub-setting-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-left: 15px;
            border-left: 2px solid #333;
            padding-left: 10px;
            margin-top: 5px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chk-label-icon {
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
    </style>
</head>

<body>

    <div id="toast">Route Saved</div>
    <div id="virtual-cursor"></div>

    <div id="layout-menu">
        <div class="btn-square" title="Layout Options"><i class="fa-solid fa-eye"></i></div>
        <div id="layout-dropdown">
            <div class="chk-row" onclick="toggleSidebar('left')"><i class="fa-solid fa-square-check" id="chk-left"></i>
                Left Panel</div>
            <div class="chk-row" onclick="toggleSidebar('right')"><i class="fa-solid fa-square-check"
                    id="chk-right"></i> Right Panel</div>
        </div>
    </div>

    <div id="map-wrapper">
        <div id="map"></div>
        <iframe id="hud-overlay" src="about:blank"></iframe>
    </div>

    <div id="bottom-bar">
        <div class="bar-section">
            <div class="bar-item"><i class="fa-solid fa-crosshairs"></i> <span class="bar-val" id="val-cursor">--</span>
            </div>
        </div>
        <div class="bar-section">
            <div class="info-pill visible" id="pill-alt"><span class="bar-item" style="font-size:10px;">ALT</span> <span
                    class="bar-val" id="val-alt">0000</span></div>
            <div class="info-pill visible" id="pill-hdg"><span class="bar-item" style="font-size:10px;">HDG</span> <span
                    class="bar-val" id="val-hdg">360</span></div>
        </div>
    </div>

    <div id="mini-route-panel">
        <div class="mini-info"><span class="mini-title">Active Route</span><span class="mini-val"
                id="mini-route-name">ALPHA-1</span></div>
        <div style="width:1px; height:30px; background:#555;"></div>
        <div class="mini-info"><span class="mini-title">Tracking</span><span class="mini-val" id="mini-wp-name">WP
                1</span></div>
        <button class="mini-btn" onclick="cycleWp(-1)" title="Prev WP"><i class="fa-solid fa-chevron-left"></i></button>
        <button class="mini-btn" onclick="cycleWp(1)" title="Next WP"><i class="fa-solid fa-chevron-right"></i></button>
        <div style="width:1px; height:30px; background:#555;"></div>
        <button class="mini-btn" onclick="stopRoute()" title="Stop/Edit"><i class="fa-solid fa-stop"></i></button>
    </div>

    <div class="sidebar" id="sidebar-left">
        <div class="btn-square" id="btn-route-menu" onclick="toggleDrawer('route')" title="Route Manager"><i
                class="fa-solid fa-route"></i></div>
        <div class="btn-square" id="btn-poi-list" onclick="toggleDrawer('poi')" title="Visual Targets List"><i
                class="fa-solid fa-list-ul"></i></div>
        <div class="btn-square" id="btn-mode-poi" onclick="setClickMode('poi')" title="Drop POI Marker"><i
                class="fa-solid fa-thumbtack"></i></div>
        <div class="btn-square" onclick="markCurrentPosition()" title="Mark My Position"><i
                class="fa-solid fa-map-location-dot"></i></div>
        <div style="height:10px;"></div>
        <div class="btn-square" id="btn-settings" onclick="toggleDrawer('settings')" title="Settings & Options"><i
                class="fa-solid fa-gear"></i></div>
    </div>

    <div id="settings-drawer" class="drawer-panel">
        <div class="panel-header">Options</div>
        <div class="form-row"><label>Coordinates Format</label><select id="opt-coords" onchange="updateSettings()">
                <option value="latlon">Lat/Lon (DMS)</option>
                <option value="mgrs">MGRS</option>
            </select></div>
        <div class="form-row"><label>Altitude Units</label><select id="opt-alt-unit" onchange="updateSettings()">
                <option value="ft">Feet (ft)</option>
                <option value="m">Meters (m)</option>
            </select></div>
        <div class="form-row"><label>Distance Units</label><select id="opt-dist-unit" onchange="updateSettings()">
                <option value="nm">Nautical Miles (nm)</option>
                <option value="km">Kilometers (km)</option>
            </select></div>
        <div class="form-row"><label>Default Waypoint Altitude</label>
            <div class="input-group">
                <div class="input-with-kb">
                    <input type="number" id="opt-def-alt" value="20000"
                        style="width: 100%; border-radius: 4px 0 0 4px;">
                    <div class="kb-trigger" onclick="openKeyboard('opt-def-alt', 'number')">123</div>
                </div>
                <div class="unit-badge" id="lbl-def-alt-unit">ft</div>
            </div>
        </div>

        <div class="form-row" style="margin-top:10px;">
            <label>Navigation Logic</label>
            <div style="border-top:1px solid #444; margin:2px 0;"></div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="color:#78aabc; font-size:12px; font-weight:bold;">Auto Sequence Routes</span>
                <input type="checkbox" id="chk-opt-autoseq" checked onchange="toggleSeq()"
                    style="width:16px; height:16px; cursor:pointer;">
            </div>
            <div
                style="display:flex; flex-direction:column; gap:5px; background:#111; padding:5px; border:1px solid #555; border-radius:4px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#78aabc; font-size:12px; font-weight:bold;">Enable "Fly-By" Turns</span>
                    <input type="checkbox" id="chk-opt-flyby" onchange="saveMapSettings()"
                        style="width:16px; height:16px; cursor:pointer;">
                </div>
                <div style="border-top:1px solid #444; margin:2px 0;"></div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#78aabc; font-size:12px; font-weight:bold;">Course Line Auto Pilot Mode</span>
                    <input type="checkbox" id="chk-opt-courseline" onchange="saveMapSettings()"
                        style="width:16px; height:16px; cursor:pointer;">
                </div>
            </div>
        </div>
        <div class="form-row" style="margin-top:10px; border-top:1px solid #444; padding-top:10px;">
            <label style="font-size:12px; color:#fff; font-weight:bold; margin-bottom:5px; display:block;">Grid
                Appearance</label>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <span style="color:#aaa; font-size:13px;">Lat/Lon Grid</span>
                <input type="color" id="col-latlon" value="#00ffcc" onchange="updateSettings()"
                    class="color-picker-mini">
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <span style="color:#aaa; font-size:13px;">MGRS Grid</span>
                <input type="color" id="col-mgrs" value="#733f59" onchange="updateSettings()" class="color-picker-mini">
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="color:#aaa; font-size:13px;">MGRS GZD</span>
                <input type="color" id="col-mgrs-gzd" value="#988035" onchange="updateSettings()"
                    class="color-picker-mini">
            </div>
        </div>

        <div class="form-row" style="margin-top:10px; border-top:1px solid #444; padding-top:10px;">
            <label style="font-size:12px; color:#fff; font-weight:bold; margin-bottom:5px; display:block;">Pointer
                Appearance</label>

            <div style="display:flex; justify-content:space-between; align-items:center;">
                <select id="opt-ptr-style" onchange="updatePointerVisuals(); saveMapSettings()"
                    style="flex-grow:1; background:#111; color:#fff; border:1px solid #555; padding:2px; margin-right:8px;">
                    <option value="cross">Crosshair</option>
                    <option value="dot">Dot</option>
                    <option value="chevron">Chevron</option>
                    <option value="circle">Circle</option>
                    <option value="x">X-Mark</option>
                    <option value="arrow">Arrow</option>
                    <option value="diamond">Diamond</option>
                    <option value="square">Square</option>
                </select>
                <input type="color" id="opt-ptr-color" value="#00ff00"
                    onchange="updatePointerVisuals(); saveMapSettings()" class="color-picker-mini">
            </div>
        </div>
        <div style="margin-top:10px; border-top:1px solid #444; padding-top:10px;">
            <label style="font-size:12px; color:#fff; font-weight:bold; margin-bottom:10px; display:block;">Map
                Visibility</label>

            <div style="display:flex; flex-direction:column; gap:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#aaa; font-size:13px;">Show Airports</span>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="color" id="col-air-neutral" value="#888888" onchange="renderAirports()"
                            class="color-picker-mini"
                            style="width:20px; height:20px; padding:0; border:1px solid #555; background:none; cursor:pointer;"
                            title="Neutral Color">
                        <input type="checkbox" id="chk-vis-air" checked
                            onchange="toggleLayer(airportLayer, null); saveMapSettings()"
                            style="width:16px; height:16px; cursor:pointer;">
                    </div>
                </div>
                <!-- LIVE STATUS TOGGLE (Phase 3a) -->
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-left:15px; border-left:2px solid #333; padding-left:10px;">
                    <span style="color:#78aabc; font-size:11px;"> Live Airport Data</span>
                    <input type="checkbox" id="chk-live-air" onchange="updateAirportStatus(); saveMapSettings()"
                        style="width:14px; height:14px; cursor:pointer;">
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#aaa; font-size:13px;">Show Units (Master)</span>
                    <input type="checkbox" id="chk-vis-unit" checked
                        onchange="toggleLayer(unitLayer, null); saveMapSettings()"
                        style="width:16px; height:16px; cursor:pointer;">
                </div>

                <!-- GRANULAR UNIT SWITCHES -->
                <div class="sub-setting-group">
                    <div class="setting-row">
                        <span class="chk-label-icon" style="color:#78aabc;">
                            <i class="fa-solid fa-plane"></i> Air Units
                        </span>
                        <input type="checkbox" id="chk-vis-unit-air" checked onchange="saveMapSettings()"
                            style="width:14px; height:14px; cursor:pointer;">
                    </div>
                    <div class="setting-row">
                        <span class="chk-label-icon" style="color:#2ecc71;">
                            <i class="fa-solid fa-truck-field"></i> Ground Units
                        </span>
                        <input type="checkbox" id="chk-vis-unit-ground" checked onchange="saveMapSettings()"
                            style="width:14px; height:14px; cursor:pointer;">
                    </div>
                    <div class="setting-row">
                        <span class="chk-label-icon" style="color:#3498db;">
                            <i class="fa-solid fa-ship"></i> Naval Units
                        </span>
                        <input type="checkbox" id="chk-vis-unit-naval" checked onchange="saveMapSettings()"
                            style="width:14px; height:14px; cursor:pointer;">
                    </div>
                    <div class="setting-row">
                        <span class="chk-label-icon" style="color:#95a5a6;">
                            <i class="fa-solid fa-building"></i> Static Objects
                        </span>
                        <input type="checkbox" id="chk-vis-unit-static" onchange="saveMapSettings()"
                            style="width:14px; height:14px; cursor:pointer;">
                    </div>
                </div>

                <!-- AFFILIATION FILTERS (New) -->
                <!-- AFFILIATION FILTERS (New) -->
                <div class="sub-setting-group">
                    <label style="font-size:10px; color:#777; text-transform:uppercase; margin-bottom:5px;">Coalition
                        Filter</label>

                    <!-- Hostile -->
                    <div class="mil-toggle active red" id="btn-vis-red" onclick="toggleCoalition('red')">
                        <i class="fa-solid fa-diamond"></i> Hostile
                    </div>
                    <input type="checkbox" id="chk-vis-unit-red" checked style="display:none;"
                        onchange="saveMapSettings(); renderPois()">

                    <!-- Friendly -->
                    <div class="mil-toggle active blue" id="btn-vis-blue" onclick="toggleCoalition('blue')">
                        <i class="fa-solid fa-circle"></i> Friendly
                    </div>
                    <input type="checkbox" id="chk-vis-unit-blue" checked style="display:none;"
                        onchange="saveMapSettings(); renderPois()">

                    <!-- Neutral -->
                    <div class="mil-toggle active neutral" id="btn-vis-neutral" onclick="toggleCoalition('neutral')">
                        <i class="fa-solid fa-square"></i> Neutral
                    </div>
                    <input type="checkbox" id="chk-vis-unit-neutral" checked style="display:none;"
                        onchange="saveMapSettings(); renderPois()">
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#aaa; font-size:13px;">Show User Marks</span>
                    <input type="checkbox" id="chk-vis-poi" checked
                        onchange="toggleLayer(poiLayer, null); saveMapSettings()"
                        style="width:16px; height:16px; cursor:pointer;">
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#aaa; font-size:13px;">&nbsp;&nbsp;Show Threat Rings</span>
                    <input type="checkbox" id="chk-vis-threats" checked onchange="renderPois(); saveMapSettings()"
                        style="width:16px; height:16px; cursor:pointer;">
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#aaa; font-size:13px;">Altitude Info (Bottom)</span>
                    <input type="checkbox" id="chk-vis-alt" checked onchange="toggleInfo('alt'); saveMapSettings()"
                        style="width:16px; height:16px; cursor:pointer;">
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#aaa; font-size:13px;">Heading Info (Bottom)</span>
                    <input type="checkbox" id="chk-vis-hdg" checked onchange="toggleInfo('hdg'); saveMapSettings()"
                        style="width:16px; height:16px; cursor:pointer;">
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#aaa; font-size:13px;">Lat/Lon Grid</span>
                    <input type="checkbox" id="chk-vis-grid" onchange="toggleLayer(gridLayer, null); saveMapSettings()"
                        style="width:16px; height:16px; cursor:pointer;">
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#aaa; font-size:13px;">MGRS Grid</span>
                    <input type="checkbox" id="chk-vis-mgrs"
                        onchange="toggleLayer(mgrsGridLayer, null); saveMapSettings()"
                        style="width:16px; height:16px; cursor:pointer;">
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#aaa; font-size:13px;">Day/Night Cycle</span>
                    <input type="checkbox" id="chk-vis-term"
                        onchange="toggleLayer(terminatorLayer, null); saveMapSettings()"
                        style="width:16px; height:16px; cursor:pointer;">
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#aaa; font-size:13px;">HUD Display Mode</span>
                    <button id="btn-opt-hud" onclick="cycleHudMode(); saveMapSettings()"
                        style="background:#111; border:1px solid #555; color:#fff; font-size:11px; padding:2px 8px; border-radius:4px; cursor:pointer; width:80px;">OFF</button>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                    <span style="color:#aaa; font-size:13px;">Ring Fill Opacity</span>
                    <input type="range" id="sld-threat-fill" min="0" max="100" value="20"
                        oninput="updateThreatFill(this.value)" onchange="saveMapSettings()"
                        style="width:80px; cursor:pointer;">
                </div>
            </div>
        </div>
        <div class="form-row" style="margin-top:5px; border-top:1px solid #444; padding-top:10px;">
            <label style="color:var(--accent); font-weight:bold;">Active Map Tuning: <span
                    id="lbl-active-map-name">DARK</span></label>
            <div class="form-row"><label>Opacity: <span id="val-map-op">1.0</span></label><input type="range" min="0.1"
                    max="1.0" step="0.05" id="sld-map-op" oninput="tuneFilter('map', 'op', this.value)"></div>
            <div class="form-row"><label>Brightness: <span id="val-map-br">1.0</span></label><input type="range"
                    min="0.1" max="2.0" step="0.05" id="sld-map-br" oninput="tuneFilter('map', 'br', this.value)"></div>
            <div class="form-row"><label>Contrast: <span id="val-map-con">1.0</span></label><input type="range"
                    min="0.1" max="2.0" step="0.05" id="sld-map-con" oninput="tuneFilter('map', 'con', this.value)">
            </div>
        </div>

        <div class="form-row" style="margin-top:5px; border-top:1px solid #444; padding-top:10px;">
            <label style="color:#2ecc71; font-weight:bold;">NVG Layer</label>
            <div class="form-row"><label>Color Tint: <span id="val-nvg-sep">1.0</span></label><input type="range"
                    min="0.0" max="1.0" step="0.05" id="sld-nvg-sep" oninput="tuneFilter('nvg', 'sep', this.value)">
            </div>
            <div class="form-row"><label>Gain: <span id="val-nvg-op">1.0</span></label><input type="range" min="0.0"
                    max="1.0" step="0.05" id="sld-nvg-op" oninput="tuneFilter('nvg', 'op', this.value)"></div>
            <div class="form-row"><label>Brightness: <span id="val-nvg-br">0.7</span></label><input type="range"
                    min="0.1" max="2.0" step="0.05" id="sld-nvg-br" oninput="tuneFilter('nvg', 'br', this.value)"></div>
            <div class="form-row"><label>Contrast: <span id="val-nvg-con">0.9</span></label><input type="range"
                    min="0.1" max="2.0" step="0.05" id="sld-nvg-con" oninput="tuneFilter('nvg', 'con', this.value)">
            </div>
        </div>
        <div class="form-row"
            style="margin-bottom:5px; background:#111; padding:10px; border-radius:4px; border:1px solid #444;">
            <label style="color:#fff;">Interface Scale</label>
            <div style="display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-compress" style="font-size:12px; color:#777;"></i>
                <input type="range" id="opt-ui-scale" min="0.5" max="2.0" step="0.05" value="1.0"
                    oninput="applyUiScale(this.value)" onchange="updateSettings()" style="flex-grow:1; cursor:pointer;">
                <i class="fa-solid fa-expand" style="font-size:12px; color:#777;"></i>
                <span id="lbl-ui-scale" style="font-size:11px; width:30px; text-align:right;">1.0</span>
            </div>
        </div>
        <div class="form-row" style="margin-top:5px; border-top:1px solid #444; padding-top:10px;">
            <label style="color:#78aabc; font-weight:bold; margin-bottom:5px;">Data Cartridge (QR)</label>
            <div style="display:flex; gap:10px;">
                <button class="btn-full btn-action" onclick="openShareModal()"><i class="fa-solid fa-qrcode"></i>
                    Share</button>
                <button class="btn-full btn-alert" onclick="openImportModal()"><i class="fa-solid fa-camera"></i>
                    Import</button>
            </div>
        </div>
        <div class="form-row" style="margin-top:5px;">
            <label>Device Power</label>
            <div
                style="display:flex; justify-content:space-between; align-items:center; background:#111; padding:5px; border:1px solid #555; border-radius:4px;">
                <span style="color:#78aabc; font-size:12px; font-weight:bold;">Prevent Sleep (Wake Lock)</span>
                <input type="checkbox" id="chk-opt-wakelock" onchange="toggleWakeLock(); saveMapSettings()"
                    style="width:16px; height:16px; cursor:pointer;">
            </div>
        </div>
    </div>

    <div id="route-drawer" class="drawer-panel">

        <div id="view-missions" class="route-view">
            <div class="panel-header">Mission Selector</div>

            <button class="btn-full" onclick="createNewMission()" style="position:relative; margin-bottom:10px;">
                Create New Mission
                <i class="fa-solid fa-folder-plus"
                    style="position:absolute; right:15px; top:50%; transform:translateY(-50%); color:#aaa;"></i>
            </button>

            <div class="form-row"><label>Available Missions</label></div>
            <div id="mission-list" class="route-list-container"></div>
        </div>
        <div id="view-browser" class="route-view" style="display:none;">
            <div class="panel-header">
                <span id="browser-title" style="font-size:14px; color:#d1e3ea;">Route Manager</span>

                <button onclick="exitToMissionSelector()"
                    style="background:none; border:none; color:#78aabc; cursor:pointer; font-size:11px; display:flex; align-items:center; gap:5px; font-weight:bold; text-transform:uppercase;">
                    <i class="fa-solid fa-arrow-left"></i> Mission Selector
                </button>
            </div>

            <div
                style="font-size:11px; color:#777; margin-bottom:10px; padding:0 5px; display:flex; justify-content:space-between;">
                <span id="lbl-active-map">Map: --</span>
                <span id="lbl-mission-status">LOCAL</span>
            </div>

            <button class="btn-full" onclick="createNewRoute()" style="position:relative;">
                Create New Route
                <i class="fa-solid fa-plus"
                    style="position:absolute; right:15px; top:50%; transform:translateY(-50%); color:#aaa;"></i>
            </button>

            <div class="form-row"><label>Route Objects</label></div>
            <div id="saved-list" class="route-list-container"></div>
        </div>

        <div id="view-editor" class="route-view" style="display:none;">
            <div class="panel-header"><span id="route-title">Editing</span><button onclick="showBrowser()"
                    style="background:none; border:none; color:#aaa; cursor:pointer;">Back</button></div>
            <div class="form-row" style="background:rgba(0,0,0,0.3); padding:5px; border-radius:4px;"><label>Click / Add
                    Altitude</label>
                <div class="input-group">
                    <div class="input-with-kb">
                        <input type="number" id="global-alt" value="20000"
                            style="width:50%; border-radius:4px 0 0 4px;">
                        <div class="kb-trigger" onclick="openKeyboard('global-alt', 'number')">123</div>
                    </div><select id="global-alt-type" style="width:30%; border-radius:0;">
                        <option value="MSL">MSL</option>
                        <option value="AGL">AGL</option>
                    </select>
                    <div class="unit-badge" id="lbl-global-alt-unit">ft</div>
                </div>
            </div>
            <div style="display:flex; gap:5px;">
                <button class="btn-square" id="btn-mode-wp" onclick="setClickMode('wp')" title="Click Map for WP"><i
                        class="fa-solid fa-map-pin"></i></button>
                <button class="btn-square" id="btn-mode-tgt" onclick="setClickMode('tgt')" title="Click Map for TGT"><i
                        class="fa-solid fa-bullseye"></i></button>
                <button class="btn-square" onclick="toggleManualInput()" title="Manual Input"><i
                        class="fa-solid fa-keyboard"></i></button>
                <button class="btn-square" onclick="autoRenameWaypoints()" title="Auto Rename List"><i
                        class="fa-solid fa-arrow-down-1-9"></i></button>
            </div>
            <div id="manual-form"
                style="display:none; background:#000; padding:10px; border-radius:6px; border:1px solid #444;">
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;">
                    <span style="font-size:12px; font-weight:bold; color:#ccc;">MANUAL INPUT</span>
                    <button onclick="closeManualInput()"
                        style="background:none; border:none; color:#aaa; cursor:pointer; font-weight:bold; font-size:14px;"></button>
                </div>
                <div class="form-row"><label>Name</label>
                    <div class="input-with-kb"><input type="text" id="inp-name">
                        <div class="kb-trigger" onclick="openKeyboard('inp-name', 'text')"><i
                                class="fa-regular fa-keyboard"></i></div>
                    </div>
                </div>
                <div class="form-row"><label>Type</label><select id="inp-type">
                        <option value="wp">Waypoint</option>
                        <option value="tgt">Target</option>
                    </select></div>
                <div id="inp-latlon-box">
                    <div class="form-row"><label>Latitude</label>
                        <div class="input-with-kb"><input type="text" id="inp-lat" placeholder="N 42 15 30.00"
                                oninput="maskDMS(this, 'lat')" maxlength="13">
                            <div class="kb-trigger" onclick="openKeyboard('inp-lat', 'text')"><i
                                    class="fa-regular fa-keyboard"></i></div>
                        </div>
                    </div>
                    <div class="form-row"><label>Longitude</label>
                        <div class="input-with-kb"><input type="text" id="inp-lon" placeholder="E 041 30 00.00"
                                oninput="maskDMS(this, 'lon')" maxlength="14">
                            <div class="kb-trigger" onclick="openKeyboard('inp-lon', 'text')"><i
                                    class="fa-regular fa-keyboard"></i></div>
                        </div>
                    </div>
                </div>
                <div id="inp-mgrs-box" style="display:none;">
                    <div class="form-row"><label>MGRS</label>
                        <div class="input-with-kb"><input type="text" id="inp-mgrs" placeholder="38T KM 12345 67890"
                                oninput="maskMGRS(this)" maxlength="18">
                            <div class="kb-trigger" onclick="openKeyboard('inp-mgrs', 'text')"><i
                                    class="fa-regular fa-keyboard"></i></div>
                        </div>
                    </div>
                </div>
                <button class="btn-full" id="btn-add-point" onclick="addManualPoint()" style="margin-top:5px;">Add
                    Point</button>
            </div>
            <div id="active-route-list" class="route-list-container"></div>
            <div class="route-footer" id="route-footer">Total: 0 nm</div>
            <div style="margin-top:auto; display:flex; gap:5px; flex-direction:column;">
                <div class="input-group"><input type="color" id="save-color" value="#78aabc" title="Route Color">
                    <div class="input-with-kb"><input type="text" id="save-name" placeholder="Route Name"
                            style="width:100%;">
                        <div class="kb-trigger" onclick="openKeyboard('save-name', 'text')"><i
                                class="fa-regular fa-keyboard"></i></div>
                    </div>
                </div><button class="btn-full" onclick="saveCurrentRoute()">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="poi-drawer" class="drawer-panel">
        <div class="panel-header">Visual Points Off Interest</div>

        <button class="btn-full"
            onclick="if(confirm('Delete all targets?')) { socket.emit('update_pois', []); showToast('Cleared All Targets'); }"
            style="position:relative;">
            Clear All Targets
            <i class="fa-solid fa-trash"
                style="position:absolute; right:15px; top:50%; transform:translateY(-50%); color:#aaa;"></i>
        </button>

        <div class="form-row"><label>Active Visual POI</label></div>
        <div id="poi-list-container" class="route-list-container"></div>
    </div>

    <div id="sp-text-input-box" style="display:none;">
        <input type="text" id="sp-text-input" placeholder="Type here..."
            onkeydown="if(event.key==='Enter') Scratchpad.commitText()">
        <button onclick="Scratchpad.commitText()"><i class="fa-solid fa-check"></i></button>
    </div>

    <div id="sp-sub-sidebar">
        <div class="btn-square" id="btn-sp-expand" onclick="Scratchpad.toggleToolMenu()"
            style="font-size:12px; height:30px; min-height:30px; color:#aaa;">
            <i class="fa-solid fa-chevron-up"></i>
        </div>

        <div class="btn-square sp-tool-item" onclick="Scratchpad.clear()"
            style="color:#e74c3c; border-color:#5c2121; font-size:12px; height:30px; min-height:30px;">
            <i class="fa-solid fa-trash"></i>
        </div>

        <div class="sp-tool-wrapper sp-tool-item">
            <div class="btn-square" onclick="Scratchpad.togglePopout('opacity')" title="Opacity"><i
                    class="fa-solid fa-circle-half-stroke"></i></div>
            <div class="sp-popout" id="pop-opacity">
                <label>Overlay Opacity</label>
                <input type="range" min="0.1" max="1.0" step="0.1" value="1.0"
                    oninput="Scratchpad.setOpacity(this.value)">
            </div>
        </div>

        <div class="sp-tool-wrapper sp-tool-item">
            <div class="btn-square" id="btn-tool-eraser" onmousedown="Scratchpad.handlePressStart('eraser')"
                ontouchstart="Scratchpad.handlePressStart('eraser')" onmouseup="Scratchpad.handlePressEnd('eraser')"
                ontouchend="Scratchpad.handlePressEnd('eraser')" title="Eraser">
                <i class="fa-solid fa-eraser"></i>
            </div>
            <div class="sp-popout" id="pop-eraser">
                <label>Eraser Size</label>
                <input type="range" min="5" max="50" step="5" value="20" oninput="Scratchpad.eraserSize = this.value">
            </div>
        </div>

        <div class="sp-tool-wrapper sp-tool-item">
            <div class="btn-square" id="btn-tool-text" onmousedown="Scratchpad.handlePressStart('text')"
                ontouchstart="Scratchpad.handlePressStart('text')" onmouseup="Scratchpad.handlePressEnd('text')"
                ontouchend="Scratchpad.handlePressEnd('text')" title="Text Tool">
                <i class="fa-solid fa-font"></i>
            </div>
            <div class="sp-popout" id="pop-text">
                <label>Font Size</label>
                <input type="range" min="10" max="40" step="2" value="16" oninput="Scratchpad.fontSize = this.value">
            </div>
        </div>

        <div class="sp-tool-wrapper sp-tool-item">
            <div class="btn-square active" id="btn-tool-pen" onmousedown="Scratchpad.handlePressStart('pen')"
                ontouchstart="Scratchpad.handlePressStart('pen')" onmouseup="Scratchpad.handlePressEnd('pen')"
                ontouchend="Scratchpad.handlePressEnd('pen')" title="Pen Color">
                <i class="fa-solid fa-pen"></i>
            </div>
            <div class="sp-popout" id="pop-pen">
                <label>Pen Color</label>

                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin-bottom:5px;">

                    <div class="color-dot" style="background:#e74c3c" title="Red (Hostile)"
                        onclick="Scratchpad.setColor('#e74c3c')"></div>
                    <div class="color-dot" style="background:#3498db" title="Blue (Friendly)"
                        onclick="Scratchpad.setColor('#3498db')"></div>
                    <div class="color-dot" style="background:#2ecc71" title="Green"
                        onclick="Scratchpad.setColor('#2ecc71')"></div>
                    <div class="color-dot" style="background:#f1c40f" title="Yellow"
                        onclick="Scratchpad.setColor('#f1c40f')"></div>

                    <div class="color-dot" style="background:#ffffff" title="White"
                        onclick="Scratchpad.setColor('#ffffff')"></div>
                    <div class="color-dot" style="background:#000000; border:1px solid #777;" title="Black"
                        onclick="Scratchpad.setColor('#000000')"></div>
                    <div class="color-dot" style="background:#9b59b6" title="Purple"
                        onclick="Scratchpad.setColor('#9b59b6')"></div>

                    <div class="color-dot"
                        style="background:conic-gradient(red, yellow, lime, aqua, blue, magenta, red); border:1px solid #777; position:relative; overflow:hidden;"
                        title="Custom Color...">
                        <input type="color" id="sp-pen-color" oninput="Scratchpad.setColor(this.value)"
                            style="opacity:0; position:absolute; top:0; left:0; width:100%; height:100%; cursor:pointer; padding:0; border:none;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar" id="sidebar-right">
        <div class="btn-square" id="btn-fullscreen" onclick="toggleFullScreen()" title="Toggle Full Screen"><i
                class="fa-solid fa-expand"></i></div>
        <div style="height:5px;"></div>
        <div class="btn-square" id="btn-map-layers" onclick="toggleMapMenu()" title="Map Layers"><i
                class="fa-solid fa-layer-group"></i></div>
        <button class="btn-square" onclick="map.zoomIn()" title="Zoom In"><i class="fa-solid fa-plus"></i></button>
        <button class="btn-square" onclick="map.zoomOut()" title="Zoom Out"><i class="fa-solid fa-minus"></i></button>
        <div style="height:10px;"></div>
        <button class="btn-square" id="btn-measure" onclick="toggleMeasureTool()" title="Measure Distance"><i
                class="fa-solid fa-ruler-horizontal"></i></button>
        <div class="btn-square" id="btn-labels" onclick="toggleLabels()" title="Toggle Waypoint Labels"><i
                class="fa-solid fa-tag"></i></div>
        <div style="height:10px;"></div>
        <button class="btn-square" id="btn-follow" onclick="toggleFollow()" title="Follow Plane"><i
                class="fa-solid fa-crosshairs"></i></button>
        <button class="btn-square" id="btn-hdg-up" onclick="toggleHeadingUp()" title="Toggle Heading Up"><i
                class="fa-regular fa-compass"></i></button>
        <div style="height:5px;"></div>
        <div class="btn-square" id="btn-scratchpad" onclick="Scratchpad.toggleMode()" title="Toggle Scratchpad">
            <i class="fa-solid fa-pen-ruler"></i>
        </div>
        <div style="height:55px;"></div>
    </div>

    <div class="popup-menu" id="map-menu">
        <div style="font-size:10px; color:#777; padding:0 5px; text-transform:uppercase;">Base Map</div>
        <button class="menu-item" onclick="setMapLayer('dark')"><span>Tactical (Dark)</span></button>
        <button class="menu-item" onclick="setMapLayer('opentopo')"><span>Military Topo</span></button>
        <button class="menu-item" onclick="setMapLayer('sat')"><span>Satellite</span></button>
        <button class="menu-item" onclick="setMapLayer('cyclosm')"><span>Detailed Topo</span></button>
        <button class="menu-item" onclick="setMapLayer('light')"><span>Street (Light)</span></button>
        <button class="menu-item" onclick="setMapLayer('darkstreet')"><span>Street (Dark)</span></button>
        <button class="menu-item" onclick="setMapLayer('vfr')"><span>VFR Chart (Day)</span></button>
        <button class="menu-item" onclick="setMapLayer('vfr_night')"><span>VFR Chart (Night)</span></button>
        <button class="menu-item" onclick="setMapLayer('relief')"><span>Terrain Relief</span></button>

        <div style="border-top:1px solid #444; margin:5px 0;"></div>
        <div style="font-size:10px; color:#777; padding:0 5px; text-transform:uppercase;">Layer Overlays</div>

        <button class="menu-item" id="btn-ov-urban" onclick="toggleOverlay('urban')">
            <span>Urban Areas</span><input type="checkbox" class="overlay-chk" id="chk-ov-urban">
        </button>
        <button class="menu-item" id="btn-ov-roads" onclick="toggleOverlay('roads')">
            <span>Road Network</span><input type="checkbox" class="overlay-chk" id="chk-ov-roads">
        </button>
        <button class="menu-item" id="btn-ov-contours" onclick="toggleOverlay('contours')">
            <span>Contours (Elev)</span><input type="checkbox" class="overlay-chk" id="chk-ov-contours">
        </button>
        <button class="menu-item" id="btn-ov-labels" onclick="toggleOverlay('labels')">
            <span>Text Labels</span><input type="checkbox" class="overlay-chk" id="chk-ov-labels">
        </button>
        <div style="border-top:1px solid #444; margin:5px 0;"></div>

        <button class="menu-item" id="btn-ov-nvg" onclick="cycleNvgMode()">
            <span>Night Vision (NVG)</span>
            <i class="fa-regular fa-square" id="icon-nvg-state" style="width:14px; text-align:center;"></i>
        </button>
    </div>

    <div id="poi-modal"
        style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#2b3a41; padding:15px; border:1px solid #78aabc; border-radius:8px; z-index:4000; box-shadow:0 10px 20px rgba(0,0,0,0.5); flex-direction:column; gap:10px; min-width:280px;">
        <div style="color:#fff; font-weight:bold; border-bottom:1px solid #555; padding-bottom:5px;">Edit Marker</div>
        <div style="background:rgba(0,0,0,0.3); padding:8px; border-radius:4px; margin: 5px 0; border:1px solid #444;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <div>
                    <div style="font-size:9px; color:#aaa; text-transform:uppercase;">Coordinate</div>
                    <div id="poi-info-coord" style="font-family:monospace; color:#78aabc; font-size:11px;">--</div>
                </div>
                <div>
                    <div style="font-size:9px; color:#aaa; text-transform:uppercase;">Elevation</div>
                    <div id="poi-info-alt" style="font-family:monospace; color:#78aabc; font-size:11px;">--</div>
                </div>
            </div>
        </div>
        <div class="input-with-kb"><input type="text" id="poi-name" placeholder="Name">
            <div class="kb-trigger" onclick="openKeyboard('poi-name', 'text')"><i class="fa-regular fa-keyboard"></i>
            </div>
        </div>
        <div id="box-affil-select" style="display:none;">
            <div style="font-size:10px; color:#aaa; text-transform:uppercase; margin-top:5px;">Affiliation (Side)</div>
            <select id="poi-affil" onchange="renderPoiSelector()"
                style="width:100%; height:auto; padding:8px; background:#111; color:#fff; border:1px solid #555;">
                <option value="H">Hostile (Red)</option>
                <option value="F">Friendly (Blue)</option>
                <option value="N">Neutral (Green/Yel)</option>
                <option value="U">Unknown (Yellow)</option>
            </select>
        </div>
        <div id="box-color-picker" style="display:block;">
            <div style="font-size:10px; color:#aaa; text-transform:uppercase; margin-top:5px;">Pin Color</div><input
                type="color" id="poi-color" value="#ffff00" style="width:100%; height:30px; cursor:pointer;">
        </div>
        <div style="font-size:10px; color:#aaa; text-transform:uppercase; margin-top:5px;">Tactical Symbol</div>
        <div class="icon-grid" style="background:#747778; padding:5px; border-radius:4px; gap:4px;"></div>
        <div class="threat-row">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2px;">
                <span style="font-size:10px; color:#aaa; text-transform:uppercase; font-weight:bold;">Threat
                    Rings</span>
                <button id="btn-poi-threat-vis" class="list-btn" onclick="togglePoiThreatVis()"
                    title="Toggle Rings for this POI">
                    <i class="fa-solid fa-eye"></i>
                </button>
            </div>
            <div class="threat-input-group">
                <label>Detect (<span class="lbl-dist-unit">nm</span>)</label>
                <input type="number" id="poi-threat-detect" step="0.5" min="0" placeholder="0.0">
                <input type="checkbox" id="chk-poi-threat-detect" title="Enable Detect Ring">
            </div>
            <div class="threat-input-group">
                <label>Deadly (<span class="lbl-dist-unit">nm</span>)</label>
                <input type="number" id="poi-threat-deadly" step="0.5" min="0" placeholder="0.0">
                <input type="checkbox" id="chk-poi-threat-deadly" title="Enable Deadly Ring">
            </div>
        </div>
        <div id="poi-btn-container" style="display:flex; gap:5px; margin-top:10px;">
        </div>
    </div>
    </div>

    <div id="modal-share" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span>Data Cartridge : SEND</span><button onclick="closeModal('share')"
                    class="list-btn"><i class="fa-solid fa-xmark"></i></button></div>

            <div class="modal-section">
                <span class="modal-label">Meta Data</span>
                <div class="input-with-kb" style="margin-bottom:5px;">
                    <input type="text" id="share-sender" placeholder="Commander Name" value="Commander">
                    <div class="kb-trigger" onclick="openKeyboard('share-sender','text')"></div>
                </div>
                <div class="input-with-kb">
                    <input type="text" id="share-briefing" placeholder="Briefing / Notes">
                    <div class="kb-trigger" onclick="openKeyboard('share-briefing','text')"></div>
                </div>
            </div>

            <div class="modal-section"
                style="border-left: 2px solid var(--accent); background:rgba(120, 170, 188, 0.05);">
                <span class="modal-label" style="color:var(--accent);">Select Mission to Share</span>
                <select id="share-mission-select" onchange="updateShareList()"
                    style="width:100%; padding:8px; background:#111; color:#fff; border:1px solid #555;"></select>
            </div>

            <div class="modal-section">
                <span class="modal-label">Select Payloads</span>
                <div class="chk-item" style="border-bottom:1px solid #444; margin-bottom:5px; padding-bottom:5px;">
                    <input type="checkbox" id="share-pois" checked>
                    <span>Include POI List</span>
                </div>
                <div id="share-routes-list" class="chk-list"></div>
            </div>

            <button class="btn-full btn-action" onclick="generateMissionQR()">Generate Secure QR</button>
            <button class="btn-full btn-alert" style="margin-top:5px;" onclick="exportMissionToFile()">
                <i class="fa-solid fa-file-export"></i> Export to Data File (.json)
            </button>
            <div id="qr-result-area" style="display:none; text-align:center;">
                <div id="qr-output"></div>
                <button class="btn-full" onclick="downloadQR()" style="margin-top:10px;">
                    <i class="fa-solid fa-download"></i> Download Image
                </button>
            </div>
        </div>
    </div>

    <div id="modal-import" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span>DATA CARTRIDGE : RECEIVE</span>
                <button onclick="closeModal('import')" class="list-btn"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div id="import-step-1">
                <div class="modal-section" style="padding:0; border:none; background:transparent;">
                    <div class="modal-label" style="margin-bottom:5px;">OPTICAL SENSOR</div>
                    <div class="camera-viewport">
                        <div id="reader"></div>
                        <div
                            style="position:absolute; bottom:5px; width:100%; text-align:center; font-size:10px; color:var(--accent); opacity:0.7; pointer-events:none;">
                            SCANNING ACTIVE
                        </div>
                    </div>
                </div>

                <div style="display:flex; align-items:center; gap:15px; margin:20px 0;">
                    <div style="height:1px; background:#444; flex-grow:1;"></div>
                    <span style="font-size:10px; color:#555; font-weight:bold; letter-spacing:1px;">OR MANUAL
                        IMPORT</span>
                    <div style="height:1px; background:#444; flex-grow:1;"></div>
                </div>

                <div id="drop-area" class="drop-zone" onclick="document.getElementById('qr-file-input').click()">
                    <i class="fa-solid fa-file-import"></i>
                    <div style="font-weight:bold; font-size:12px;">DROP QR OR MISSION FILE HERE</div>
                    <div style="font-size:10px; opacity:0.7; margin-top:2px;">CLICK TO BROWSE (.png, .json)</div>
                    <input type="file" id="qr-file-input" accept="image/*" style="display:none;">
                </div>
            </div>

            <div id="import-step-2" style="display:none;">
                <div class="modal-section" style="border-color: #2ecc71; background: rgba(46, 204, 113, 0.05);">
                    <span class="modal-label" style="color:#2ecc71;">INCOMING TRANSMISSION</span>
                    <div style="font-size:14px; font-weight:bold; color:#fff; margin-top:5px;" id="import-meta-sender">
                    </div>
                    <div style="font-size:12px; color:#ccc; margin-top:2px; font-style:italic;" id="import-meta-info">
                    </div>
                </div>

                <div class="modal-section" style="margin-top:10px;">
                    <span class="modal-label">PAYLOAD MANIFEST</span>
                    <ul id="import-manifest"
                        style="margin:0; padding-left:20px; font-size:13px; color:#d1e3ea; list-style-type: square;">
                    </ul>
                </div>

                <button class="btn-full btn-success" style="margin-top:15px;" onclick="confirmImport()">CONFIRM
                    MERGE</button>
                <button class="btn-full btn-danger" style="margin-top:5px;"
                    onclick="closeModal('import')">DISCARD</button>
            </div>
        </div>
    </div>

    <div id="virtual-keyboard">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span
                style="font-size:12px; color:#aaa; font-weight:bold;">KEYBOARD</span><button onclick="closeKeyboard()"
                style="background:none; border:none; color:#aaa; cursor:pointer;"></button></div>
        <div id="kb-keys-container"></div>
    </div>

    <script>
        // 1. CONNECT
        // 1. CONNECT
        var socket = io();
        window.socket = socket; // Explicitly ensure global access for Python
        console.log("Socket Initialized", socket);

        // 2. INIT MAP & PANES
        // We create specific panes to ensure correct layering order (z-index)
        // Order: Satellite (Base) < Contours < Urban < Roads < Labels < Units/POIs
        const map = L.map('map', { center: [42.0, 42.0], zoom: 7, zoomControl: false, attributionControl: false });

        map.createPane('contourPane'); map.getPane('contourPane').style.zIndex = 350;
        map.createPane('urbanPane'); map.getPane('urbanPane').style.zIndex = 360;
        map.createPane('roadPane'); map.getPane('roadPane').style.zIndex = 370;
        map.createPane('labelPane'); map.getPane('labelPane').style.zIndex = 380;

        // 3. LAYERS
        const maptilerKey = '09u7MKuifUr11zqRXqZv';

        const layers = {
            'dark': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 20, className: 'map-tactical' }),
            'light': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20, className: 'map-light' }),
            'darkstreet': L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', { maxZoom: 20, className: 'map-darkstreet' }),
            'sat': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, className: 'map-satellite' }),
            'vfr': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, className: 'map-vfr-day' }),
            'vfr_night': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, className: 'map-vfr-night' }),
            'relief': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, maxNativeZoom: 13, className: 'map-relief' }),
            'opentopo': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17, attribution: 'Map data: &copy; OpenStreetMap contributors, SRTM | Map style: &copy; OpenTopoMap (CC-BY-SA)' }),
            'cyclosm': L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', { maxZoom: 20, attribution: 'Cycle map data &copy; OpenStreetMap contributors' })
        };
        layers['dark'].addTo(map);

        // --- OVERLAY LAYERS ---
        const overlayLayers = {
            'contours': L.tileLayer(`https://api.maptiler.com/maps/contours/{z}/{x}/{y}.png?key=${maptilerKey}`, { opacity: 0.9, pane: 'contourPane', attribution: '&copy; MapTiler' }),
            'urban': L.tileLayer.wms('http://ows.mundialis.de/services/service?', { layers: 'OSM-Overlay-WMS', format: 'image/png', transparent: true, opacity: 0.5, pane: 'urbanPane' }),
            'roads': L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_toner_lines/{z}/{x}/{y}{r}.png', { opacity: 0.8, pane: 'roadPane' }),
            'labels': L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_toner_labels/{z}/{x}/{y}{r}.png', { opacity: 1.0, pane: 'labelPane' })
        };
        let activeOverlays = { 'contours': false, 'urban': false, 'roads': false, 'labels': false };

        // 4. GROUPS
        const airportLayer = L.layerGroup().addTo(map);
        const unitLayer = L.layerGroup().addTo(map);
        const routeLayer = L.layerGroup().addTo(map);
        const activeLegLayer = L.layerGroup().addTo(map);
        const measureLayer = L.layerGroup().addTo(map);
        const poiLayer = L.layerGroup().addTo(map);
        const editorLayer = L.layerGroup().addTo(map);

        // 5. PLANE
        let planeMarker = null;
        try {
            if (typeof ms !== 'undefined') {
                const userSym = new ms.Symbol("SFAPMF-------", { size: 30, colorMode: "Light" }).asCanvas();
                const planeIconDiv = L.divIcon({ className: 'jet-container', html: `<div id="my-jet" style="width:30px; height:30px;"><img src="${userSym.toDataURL()}" style="width:100%; height:100%;"></div>`, iconSize: [40, 40], iconAnchor: [20, 20] });
                planeMarker = L.marker([0, 0], { icon: planeIconDiv }).addTo(map);
            } else { planeMarker = L.marker([0, 0]).addTo(map); }
        } catch (e) { planeMarker = L.marker([0, 0]).addTo(map); }

        // 6. CUSTOM MGRS MATH (From User)
        function MGRSString(Lat, Long) {
            if (Lat < -80) return 'Too far South'; if (Lat > 84) return 'Too far North';
            var c = 1 + Math.floor((Long + 180) / 6); var e = c * 6 - 183; var k = Lat * Math.PI / 180; var l = Long * Math.PI / 180; var m = e * Math.PI / 180; var n = Math.cos(k); var o = 0.006739496819936062 * Math.pow(n, 2); var p = 40680631590769 / (6356752.314 * Math.sqrt(1 + o)); var q = Math.tan(k); var r = q * q; var s = (r * r * r) - Math.pow(q, 6); var t = l - m; var u = 1.0 - r + o; var v = 5.0 - r + 9 * o + 4.0 * (o * o); var w = 5.0 - 18.0 * r + (r * r) + 14.0 * o - 58.0 * r * o; var x = 61.0 - 58.0 * r + (r * r) + 270.0 * o - 330.0 * r * o; var y = 61.0 - 479.0 * r + 179.0 * (r * r) - (r * r * r); var z = 1385.0 - 3111.0 * r + 543.0 * (r * r) - (r * r * r);
            var aa = p * n * t + (p / 6.0 * Math.pow(n, 3) * u * Math.pow(t, 3)) + (p / 120.0 * Math.pow(n, 5) * w * Math.pow(t, 5)) + (p / 5040.0 * Math.pow(n, 7) * y * Math.pow(t, 7));
            var ab = 6367449.14570093 * (k - (0.00251882794504 * Math.sin(2 * k)) + (0.00000264354112 * Math.sin(4 * k)) - (0.00000000345262 * Math.sin(6 * k)) + (0.000000000004892 * Math.sin(8 * k))) + (q / 2.0 * p * Math.pow(n, 2) * Math.pow(t, 2)) + (q / 24.0 * p * Math.pow(n, 4) * v * Math.pow(t, 4)) + (q / 720.0 * p * Math.pow(n, 6) * x * Math.pow(t, 6)) + (q / 40320.0 * p * Math.pow(n, 8) * z * Math.pow(t, 8));
            aa = aa * 0.9996 + 500000.0; ab = ab * 0.9996; if (ab < 0.0) ab += 10000000.0;
            var ad = 'CDEFGHJKLMNPQRSTUVWXX'.charAt(Math.floor(Lat / 8 + 10)); var ae = Math.floor(aa / 100000); var af = ['ABCDEFGH', 'JKLMNPQR', 'STUVWXYZ'][(c - 1) % 3].charAt(ae - 1); var ag = Math.floor(ab / 100000) % 20; var ah = ['ABCDEFGHJKLMNPQRSTUV', 'FGHJKLMNPQRSTUVABCDE'][(c - 1) % 2].charAt(ag);
            function pad(val) { if (val < 10) { val = '0000' + val } else if (val < 100) { val = '000' + val } else if (val < 1000) { val = '00' + val } else if (val < 10000) { val = '0' + val }; return val };
            aa = Math.floor(aa % 100000); aa = pad(aa); ab = Math.floor(ab % 100000); ab = pad(ab);
            return c + ad + ' ' + af + ah + ' ' + aa + ' ' + ab;
        }

        function LatLongFromMGRSstring(a) {
            var b = a.trim(); b = b.match(/\S+/g);
            if (b == null || b.length != 4) return [false, null, null];
            var c = (b[0].length < 3) ? b[0][0] : b[0].slice(0, 2); var d = (b[0].length < 3) ? b[0][1] : b[0][2]; var e = (c * 6 - 183) * Math.PI / 180; var f = ["ABCDEFGH", "JKLMNPQR", "STUVWXYZ"][(c - 1) % 3].indexOf(b[1][0]) + 1; var g = "CDEFGHJKLMNPQRSTUVWXX".indexOf(d); var h = ["ABCDEFGHJKLMNPQRSTUV", "FGHJKLMNPQRSTUVABCDE"][(c - 1) % 2].indexOf(b[1][1]); var i = [1.1, 2.0, 2.8, 3.7, 4.6, 5.5, 6.4, 7.3, 8.2, 9.1, 0, 0.8, 1.7, 2.6, 3.5, 4.4, 5.3, 6.2, 7.0, 7.9]; var j = [0, 2, 2, 2, 4, 4, 6, 6, 8, 8, 0, 0, 0, 2, 2, 4, 4, 6, 6, 6]; var k = i[g]; var l = Number(j[g]) + h / 10; if (l < k) l += 2; var m = f * 100000.0 + Number(b[2]); var n = l * 1000000 + Number(b[3]); m -= 500000.0; if (d < 'N') n -= 10000000.0; m /= 0.9996; n /= 0.9996; var o = n / 6367449.14570093; var p = o + (0.0025188266133249035 * Math.sin(2.0 * o)) + (0.0000037009491206268 * Math.sin(4.0 * o)) + (0.0000000074477705265 * Math.sin(6.0 * o)) + (0.0000000000170359940 * Math.sin(8.0 * o)); var q = Math.tan(p); var r = q * q; var s = r * r; var t = Math.cos(p); var u = 0.006739496819936062 * Math.pow(t, 2); var v = 40680631590769 / (6356752.314 * Math.sqrt(1 + u)); var w = v; var x = 1.0 / (w * t); w *= v; var y = q / (2.0 * w); w *= v; var z = 1.0 / (6.0 * w * t); w *= v; var aa = q / (24.0 * w); w *= v; var ab = 1.0 / (120.0 * w * t); w *= v; var ac = q / (720.0 * w); w *= v; var ad = 1.0 / (5040.0 * w * t); w *= v; var ae = q / (40320.0 * w); var af = -1.0 - u; var ag = -1.0 - 2 * r - u; var ah = 5.0 + 3.0 * r + 6.0 * u - 6.0 * r * u - 3.0 * (u * u) - 9.0 * r * (u * u); var ai = 5.0 + 28.0 * r + 24.0 * s + 6.0 * u + 8.0 * r * u; var aj = -61.0 - 90.0 * r - 45.0 * s - 107.0 * u + 162.0 * r * u; var ak = -61.0 - 662.0 * r - 1320.0 * s - 720.0 * (s * r); var al = 1385.0 + 3633.0 * r + 4095.0 * s + 1575 * (s * r); var lat = p + y * af * (m * m) + aa * ah * Math.pow(m, 4) + ac * aj * Math.pow(m, 6) + ae * al * Math.pow(m, 8); var lng = e + x * m + z * ag * Math.pow(m, 3) + ab * ai * Math.pow(m, 5) + ad * ak * Math.pow(m, 7);
            lat = lat * 180 / Math.PI; lng = lng * 180 / Math.PI; return [true, lat, lng];
        }

        // 7. VARS
        let settings = { coords: 'latlon', altUnit: 'ft', distUnit: 'nm', defAlt: 20000 };
        let missions = {};
        const dcsMaps = ["Caucasus", "Nevada", "Normandy", "PersianGulf", "TheChannel", "Syria", "Marianas", "SouthAtlantic", "Sinai", "Kola", "Afghanistan", "Iraq"];
        let activeMissionName = null;
        let allSavedRoutes = {}; let activeRouteName = null; let activeRouteData = []; let activeWpIndex = -1;
        let editingRouteName = null; let editingRouteData = []; let visibleRoutes = new Set();
        let lastTelemetry = null; let clickMode = 'none'; let wpCounter = 1; let autoSeq = true;
        let distMode = false, distStart = null; let hudMode = 0; let extHudWindow = null;
        let tacticalUnits = {}; let showWpLabels = false;
        let allPois = []; let activePoiIndex = -1; let activeEditIndex = -1; let currentMapLayerName = 'dark';
        let lastThreatDetect = 0; // Memory for last used range
        let lastThreatDeadly = 0; // Memory for last used range
        const threatLayer = L.layerGroup().addTo(map); // New layer for rings
        let threatFillOpacity = 0.2;
        let selectedPoiSidcPartial = 'GPU--------'; let terminatorLayer = L.terminator(); let currentBootId = null;
        let mapMoveTimer = null; let isProgrammaticMove = false; let allAirportsData = {};

        socket.on('remote_measurement', function (data) {
            // We pass 'true' as the 4th argument to indicate it's remote
            // so we don't send it back to the server (prevent loop)
            drawMeasureLine(data.start, data.end, data.isFinal, true);
        });

        // 8.1 GRID SETUP latlng
        const gridLayer = L.layerGroup();

        function updateGrid() {
            if (!map.hasLayer(gridLayer)) return;
            gridLayer.clearLayers();

            const bounds = map.getBounds();
            const zoom = map.getZoom();

            // 1. Determine Grid Interval (Same as before)
            let interval = 20;
            if (zoom >= 4) interval = 10;
            if (zoom >= 6) interval = 5;
            if (zoom >= 8) interval = 1;
            if (zoom >= 10) interval = 0.5;
            if (zoom >= 12) interval = 0.1;
            if (zoom >= 14) interval = 0.05;

            // 2. GET COLOR FROM CSS VARIABLE [UPDATED]
            const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--latlon-color').trim() || '#00ffcc';

            // Define Style using dynamic color
            const lineStyle = { color: gridColor, weight: 1, opacity: 0.5, dashArray: '4, 4' };
            const textStyle = `color: ${gridColor}; font-family: Consolas; font-size: 10px; text-shadow: 1px 1px 0 #000;`;

            // 3. Draw Longitude (Vertical) Lines
            const west = Math.floor(bounds.getWest() / interval) * interval;
            const east = Math.ceil(bounds.getEast() / interval) * interval;

            for (let lng = west; lng <= east; lng += interval) {
                const curLng = parseFloat(lng.toFixed(4));
                L.polyline([[bounds.getSouth(), curLng], [bounds.getNorth(), curLng]], lineStyle).addTo(gridLayer);

                const labelPos = L.latLng(bounds.getNorth() - (bounds.getNorth() - bounds.getSouth()) * 0.05, curLng);
                const icon = L.divIcon({
                    className: 'grid-label-lng',
                    html: `<div style="${textStyle}">${curLng}</div>`,
                    iconSize: [40, 20],
                    iconAnchor: [20, 0]
                });
                L.marker(labelPos, { icon: icon, interactive: false }).addTo(gridLayer);
            }

            // 4. Draw Latitude (Horizontal) Lines
            const south = Math.floor(bounds.getSouth() / interval) * interval;
            const north = Math.ceil(bounds.getNorth() / interval) * interval;

            for (let lat = south; lat <= north; lat += interval) {
                const curLat = parseFloat(lat.toFixed(4));
                L.polyline([[curLat, bounds.getWest()], [curLat, bounds.getEast()]], lineStyle).addTo(gridLayer);

                const labelPos = L.latLng(curLat, bounds.getWest() + (bounds.getEast() - bounds.getWest()) * 0.05);
                const icon = L.divIcon({
                    className: 'grid-label-lat',
                    html: `<div style="${textStyle}">${curLat}</div>`,
                    iconSize: [40, 20],
                    iconAnchor: [0, 10]
                });
                L.marker(labelPos, { icon: icon, interactive: false }).addTo(gridLayer);
            }
        }
        map.on('moveend', () => updateGrid());
        map.on('layeradd', (e) => { if (e.layer === gridLayer) updateGrid(); });

        // 8.2 MGRS GRID SYSTEM (Axis Labels vs Floating Labels)
        const mgrsGridLayer = L.layerGroup();

        function updateMgrsGrid() {
            if (!map.hasLayer(mgrsGridLayer)) return;
            mgrsGridLayer.clearLayers();

            const zoom = map.getZoom();
            const bounds = map.getBounds();
            const parse = (s) => { const p = s.split(' '); return p.length < 4 ? null : { gzd: p[0], sq: p[1], e: parseInt(p[2]), n: parseInt(p[3]) }; };
            const sw = parse(MGRSString(bounds.getSouth(), bounds.getWest()));
            if (!sw) return;

            // --- TIER 0: Zoom < 2 (Hidden) ---
            if (zoom < 2) return;

            // --- TIER 1: Zoom 2 to < 7 (Axis Labels) ---
            // "make another function that shows the top and left info on the lines"
            else if (zoom < 7) {
                drawGZDLines('mgrs-line-base mgrs-line-gzd-low');
                drawGZDAxisLabels(); // <--- NEW FUNCTION
            }

            // --- TIER 2: Zoom 7 to < 10 (Floating Corner Labels) ---
            // "we only want to use [top left corner ones] at Zoom < 10"
            else if (zoom < 10) {
                drawGZDLines('mgrs-line-base mgrs-line-gzd-high');
                drawMGRSLoop(100000, sw, bounds, 'mgrs-line-base mgrs-line-low', null, 0);
                drawCenterSQLabels();

                drawAllVisibleGZDs(); // <--- Smart Floating Labels
            }

            // --- TIER 3: Zoom 10 to < 14 (SQ High + 1-Dig Grid) ---
            else if (zoom < 14) {
                drawMGRSLoop(10000, sw, bounds, 'mgrs-line-base mgrs-line-low', 'mgrs-line-base mgrs-line-high', 1);
                drawEdgeHeaders(false);
            }

            // --- TIER 4: Zoom 14+ (2-Dig Grid) ---
            else {
                drawMGRSLoop(1000, sw, bounds, 'mgrs-line-base mgrs-line-low', 'mgrs-line-base mgrs-line-high', 2);
                drawEdgeHeaders(false);
            }
        }

        // --- DRAWING FUNCTIONS ---

        function drawGZDAxisLabels() {
            // Places labels on the Top and Left edges where the GZD lines intersect
            const bounds = map.getBounds();

            // 1. Longitudes (Top Edge Labels)
            for (let lng = -180; lng <= 180; lng += 6) {
                if (lng >= bounds.getWest() && lng <= bounds.getEast()) {
                    const zone = Math.floor((lng + 180) / 6) + 1;
                    L.marker([bounds.getNorth(), lng], {
                        icon: L.divIcon({
                            className: 'mgrs-label-gzd-axis',
                            html: `${zone}`,
                            iconSize: [30, 20],
                            iconAnchor: [15, 0] // Anchor Top Center
                        }),
                        interactive: false
                    }).addTo(mgrsGridLayer);
                }
            }

            // 2. Latitudes (Left Edge Labels)
            const lats = [-80, -72, -64, -56, -48, -40, -32, -24, -16, -8, 0, 8, 16, 24, 32, 40, 48, 56, 64, 72, 84];
            lats.forEach(lat => {
                if (lat >= bounds.getSouth() && lat <= bounds.getNorth()) {
                    const letters = "CDEFGHJKLMNPQRSTUVWXX";
                    const idx = Math.floor(lat / 8) + 10;
                    const band = letters.charAt(Math.min(letters.length - 1, Math.max(0, idx)));

                    L.marker([lat, bounds.getWest()], {
                        icon: L.divIcon({
                            className: 'mgrs-label-gzd-axis',
                            html: band,
                            iconSize: [30, 20],
                            iconAnchor: [0, 10] // Anchor Left Middle
                        }),
                        interactive: false
                    }).addTo(mgrsGridLayer);
                }
            });
        }

        function drawAllVisibleGZDs() {
            // Smart Floating Labels for Zoom 7-9
            const bounds = map.getBounds();
            const latBands = [-80, -72, -64, -56, -48, -40, -32, -24, -16, -8, 0, 8, 16, 24, 32, 40, 48, 56, 64, 72, 84];
            const startLng = Math.floor(bounds.getWest() / 6) * 6;
            const endLng = Math.ceil(bounds.getEast() / 6) * 6;

            for (let lng = startLng; lng < endLng; lng += 6) {
                for (let i = 0; i < latBands.length - 1; i++) {
                    const latMin = latBands[i];
                    const latMax = latBands[i + 1];

                    const interWest = Math.max(bounds.getWest(), lng);
                    const interEast = Math.min(bounds.getEast(), lng + 6);
                    const interSouth = Math.max(bounds.getSouth(), latMin);
                    const interNorth = Math.min(bounds.getNorth(), latMax);

                    if (interWest < interEast && interSouth < interNorth) {
                        try {
                            // Sample Center for Name
                            const sampleLat = (latMin + latMax) / 2;
                            const sampleLng = (lng + 6 + lng) / 2;
                            const str = MGRSString(sampleLat, sampleLng);
                            const gzd = str.split(' ')[0];

                            // Place at Top-Left of the VISIBLE intersection
                            const latOffset = (bounds.getNorth() - bounds.getSouth()) * 0.05;
                            const lngOffset = (bounds.getEast() - bounds.getWest()) * 0.02;

                            L.marker([interNorth - latOffset, interWest + lngOffset], {
                                icon: L.divIcon({
                                    className: 'mgrs-label-gzd-corner',
                                    html: gzd,
                                    iconSize: [100, 40],
                                    iconAnchor: [0, 0]
                                }),
                                interactive: false
                            }).addTo(mgrsGridLayer);

                        } catch (e) { }
                    }
                }
            }
        }

        function drawGZDLines(className) {
            // Just draws lines now. Labels handled by drawGZDAxisLabels
            for (let lng = -180; lng <= 180; lng += 6) {
                L.polyline([[-85, lng], [85, lng]], { className: className, interactive: false }).addTo(mgrsGridLayer);
            }
            [-80, -72, -64, -56, -48, -40, -32, -24, -16, -8, 0, 8, 16, 24, 32, 40, 48, 56, 64, 72, 84].forEach(lat => {
                L.polyline([[lat, -180], [lat, 180]], { className: className, interactive: false }).addTo(mgrsGridLayer);
            });
        }

        function drawCenterSQLabels() {
            const bounds = map.getBounds();
            const step = 0.3;
            const drawn = new Set();
            for (let la = bounds.getSouth(); la < bounds.getNorth(); la += step) {
                for (let lo = bounds.getWest(); lo < bounds.getEast(); lo += step) {
                    try {
                        const str = MGRSString(la, lo);
                        const parts = str.split(' ');
                        const sq = parts[1];
                        if (sq && !drawn.has(sq)) {
                            const m = { gzd: parts[0], sq: parts[1], e: parseInt(parts[2]), n: parseInt(parts[3]) };
                            const baseE = Math.floor(m.e / 100000) * 100000;
                            const baseN = Math.floor(m.n / 100000) * 100000;
                            const centerStr = `${m.gzd} ${m.sq} ${String(baseE + 50000).padStart(5, '0')} ${String(baseN + 50000).padStart(5, '0')}`;
                            const pt = LatLongFromMGRSstring(centerStr);
                            if (pt[0]) {
                                L.marker([pt[1], pt[2]], {
                                    icon: L.divIcon({ className: 'mgrs-label-center', html: sq, iconSize: [40, 20] }), interactive: false
                                }).addTo(mgrsGridLayer);
                            }
                            drawn.add(sq);
                        }
                    } catch (e) { }
                }
            }
        }

        function drawMGRSLoop(interval, sw, bounds, styleMinor, styleMajor, precision) {
            const startE = Math.floor(sw.e / interval) * interval;
            const startN = Math.floor(sw.n / interval) * interval;
            const widthM = (bounds.getEast() - bounds.getWest()) * 111000 * Math.cos(bounds.getCenter().lat * Math.PI / 180);
            const heightM = (bounds.getNorth() - bounds.getSouth()) * 111000;

            // Eastings
            let currE = startE; let safe = 0;
            while (safe < 300) {
                const isMajor = (currE % 100000 === 0);
                const eDisp = String(currE % 100000).padStart(5, '0');
                const bStr = `${sw.gzd} ${sw.sq} ${String(currE).padStart(5, '0')} ${String(sw.n).padStart(5, '0')}`;
                const tStr = `${sw.gzd} ${sw.sq} ${String(currE).padStart(5, '0')} ${String(sw.n + heightM + interval * 2).padStart(5, '0')}`;
                const ptBot = LatLongFromMGRSstring(bStr);
                const ptTop = LatLongFromMGRSstring(tStr);

                if (ptBot[0] && ptTop[0]) {
                    if (ptBot[2] > bounds.getEast() + 0.1) break;
                    if (ptBot[2] > bounds.getWest() - 0.1) {
                        let style = styleMinor;
                        if (isMajor && styleMajor) style = styleMajor;
                        L.polyline([[bounds.getSouth(), ptBot[2]], [bounds.getNorth(), ptBot[2]]], { className: style, interactive: false }).addTo(mgrsGridLayer);
                        if (!isMajor && precision > 0) {
                            const txt = eDisp.substring(0, precision);
                            L.marker([bounds.getNorth(), ptBot[2]], { icon: L.divIcon({ className: 'mgrs-label-digit', html: txt, iconSize: [20, 15], iconAnchor: [10, 0] }), interactive: false }).addTo(mgrsGridLayer);
                        }
                    }
                }
                currE += interval; safe++;
            }

            // Northings
            let currN = startN; safe = 0;
            while (safe < 300) {
                const isMajor = (currN % 100000 === 0);
                const nDisp = String(currN % 100000).padStart(5, '0');
                const lStr = `${sw.gzd} ${sw.sq} ${String(sw.e).padStart(5, '0')} ${String(currN).padStart(5, '0')}`;
                const rStr = `${sw.gzd} ${sw.sq} ${String(sw.e + widthM + interval * 2).padStart(5, '0')} ${String(currN).padStart(5, '0')}`;
                const ptLeft = LatLongFromMGRSstring(lStr);
                const ptRight = LatLongFromMGRSstring(rStr);

                if (ptLeft[0] && ptRight[0]) {
                    if (ptLeft[1] > bounds.getNorth() + 0.1) break;
                    if (ptLeft[1] > bounds.getSouth() - 0.1) {
                        let style = styleMinor;
                        if (isMajor && styleMajor) style = styleMajor;
                        L.polyline([[ptLeft[1], bounds.getWest()], [ptLeft[1], bounds.getEast()]], { className: style, interactive: false }).addTo(mgrsGridLayer);
                        if (!isMajor && precision > 0) {
                            const txt = nDisp.substring(0, precision);
                            L.marker([ptLeft[1], bounds.getWest()], { icon: L.divIcon({ className: 'mgrs-label-digit', html: txt, iconSize: [20, 15], iconAnchor: [0, 8] }), interactive: false }).addTo(mgrsGridLayer);
                        }
                    }
                }
                currN += interval; safe++;
            }
        }

        function drawEdgeHeaders(includeGZD) {
            // Scans edge for Floating SQ Headers (Zoom 10+)
            const bounds = map.getBounds();
            const scan = (isTop) => {
                const steps = 30;
                const range = isTop ? (bounds.getEast() - bounds.getWest()) : (bounds.getNorth() - bounds.getSouth());
                let lastTxt = "";
                for (let i = 0; i <= steps; i++) {
                    let lat = isTop ? bounds.getNorth() : (bounds.getNorth() - range * (i / steps));
                    let lng = isTop ? (bounds.getWest() + range * (i / steps)) : bounds.getWest();
                    try {
                        const p = MGRSString(lat, lng).split(' ');
                        if (p.length < 2) continue;
                        const txt = includeGZD ? `${p[0]} ${p[1]}` : p[1];
                        if (txt !== lastTxt) {
                            L.marker([lat, lng], {
                                icon: L.divIcon({ className: 'mgrs-label-edge-header', html: txt, iconSize: [50, 30], iconAnchor: [-5, -5] }),
                                interactive: false
                            }).addTo(mgrsGridLayer);
                            lastTxt = txt;
                        }
                    } catch (e) { }
                }
            };
            scan(true); scan(false);
        }

        // --- TRIGGERS ---
        map.on('moveend', () => updateMgrsGrid());
        map.on('layeradd', (e) => { if (e.layer === mgrsGridLayer) updateMgrsGrid(); });

        // --- 8.4 VIRTUAL POINTER LOGIC ---
        const VirtualPointer_Ignored = {
            active: false,
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            el: null,

            init: function () {
                this.el = document.getElementById('virtual-pointer');
                // Center initially
                this.x = window.innerWidth / 2;
                this.y = window.innerHeight / 2;
                this.updateVisuals();
            },

            toggle: function (isActive) {
                this.active = isActive;
                if (this.el) {
                    this.el.style.display = isActive ? 'block' : 'none';
                    if (isActive) {
                        // Recenter on activation
                        this.x = window.innerWidth / 2;
                        this.y = window.innerHeight / 2;
                        this.updateVisuals();
                        showToast("Pointer Mode Active");
                    }
                }
            },

            move: function (dx, dy) {
                if (!this.active) return;

                // Apply delta (server should send pixel deltas or speed factors)
                this.x += dx;
                this.y += dy;

                // Clamp to screen bounds
                this.x = Math.max(0, Math.min(window.innerWidth, this.x));
                this.y = Math.max(0, Math.min(window.innerHeight, this.y));

                this.updateVisuals();
            },

            updateVisuals: function () { if (this.el) { this.el.style.transform = `translate(${this.x}px, ${this.y}px)`; } },

            click: function () {
                if (!this.active) return;

                // 1. visual feedback
                const ripple = document.createElement('div');
                ripple.className = 'pointer-click-anim';
                ripple.style.left = this.x + 'px';
                ripple.style.top = this.y + 'px';
                document.body.appendChild(ripple);
                setTimeout(() => ripple.remove(), 500);

                // 2. Identify target
                // Hide pointer momentarily so we get the element BENEATH it
                this.el.style.display = 'none';
                let target = document.elementFromPoint(this.x, this.y);
                this.el.style.display = 'block';

                // 3. Trigger events
                if (target) {
                    // Leaflet map interactions often require specific mouse event sequences
                    const opts = {
                        bubbles: true, cancelable: true, view: window,
                        clientX: this.x, clientY: this.y,
                        screenX: this.x, screenY: this.y
                    };

                    // Dispatch full click sequence
                    target.dispatchEvent(new MouseEvent('mousedown', opts));
                    target.dispatchEvent(new MouseEvent('mouseup', opts));
                    target.dispatchEvent(new MouseEvent('click', opts));

                    // Special handling for form inputs (focus)
                    if (['INPUT', 'SELECT', 'BUTTON', 'TEXTAREA'].includes(target.tagName)) {
                        target.focus();
                    }
                }
            }
        };

        // Init Pointer on Load
        window.addEventListener('load', () => VirtualPointer.init());

        // --- 8.5 INTERACTIVE SCRATCHPAD (FINAL) ---
        const Scratchpad = {
            mode: 0, // 0: Hidden, 1: Active, 2: Passive
            canvas: null, ctx: null,
            isDrawing: false, lastX: 0, lastY: 0,

            currentTool: 'pen',
            currentColor: '#e74c3c',
            lineWidth: 2, eraserSize: 20, fontSize: 16,

            menuExpanded: false,
            pressTimer: null, longPressTriggered: false,

            init: function () {
                this.canvas = document.getElementById('scratchpad-canvas');
                this.ctx = this.canvas.getContext('2d');

                window.addEventListener('resize', () => this.resize());
                this.resize(); this.load();

                // --- MOUSE EVENTS ---
                this.canvas.addEventListener('mousedown', (e) => {
                    if (e.button !== 0) return;
                    this.handleStart(e.clientX, e.clientY);
                });
                this.canvas.addEventListener('mousemove', (e) => this.handleMove(e.clientX, e.clientY));
                this.canvas.addEventListener('mouseup', () => this.handleEnd());

                // --- TOUCH EVENTS (Fixed for Mobile) ---
                this.canvas.addEventListener('touchstart', (e) => {
                    // Prevent default ONLY if drawing (Pen/Eraser) to stop scrolling.
                    // We must allow default for some UI interactions, but for Canvas drawing 
                    // we usually want to block the scroll.
                    if (this.currentTool !== 'none') e.preventDefault();

                    const touch = e.touches[0];
                    this.handleStart(touch.clientX, touch.clientY);
                }, { passive: false });

                this.canvas.addEventListener('touchmove', (e) => {
                    // Always prevent scrolling while interacting with the canvas
                    if (this.currentTool !== 'none') e.preventDefault();

                    const touch = e.touches[0];
                    this.handleMove(touch.clientX, touch.clientY);
                }, { passive: false });

                this.canvas.addEventListener('touchend', (e) => {
                    if (this.currentTool !== 'none') e.preventDefault();

                    // For Text tool on mobile, we need to ensure we have the Last coordinates
                    // because 'e.touches' is empty on 'touchend'.
                    // We rely on 'this.lastX' set in touchstart/move.
                    this.handleEnd();
                });
            },

            toggleMode: function () { this.mode = (this.mode + 1) % 3; if (this.mode === 0) this.menuExpanded = false; this.updateUI(); },
            toggleToolMenu: function () { this.menuExpanded = !this.menuExpanded; this.updateUI(); },

            updateUI: function () {
                const layer = document.getElementById('scratchpad-layer');
                const subSidebar = document.getElementById('sp-sub-sidebar');
                const btn = document.getElementById('btn-scratchpad');
                const icon = btn.querySelector('i');
                const expandBtn = document.getElementById('btn-sp-expand');

                // Clean States
                layer.classList.remove('mode-active', 'mode-passive', 'cursor-text');
                btn.classList.remove('sp-active-glow', 'sp-passive-eye');
                subSidebar.classList.remove('visible', 'expanded');
                this.closeAllPopouts();

                if (this.mode === 0) {
                    // HIDDEN
                    layer.style.display = 'none';
                    icon.className = 'fa-solid fa-pen-ruler';
                    btn.title = "Toggle Scratchpad";
                    document.getElementById('sp-text-input-box').style.display = 'none';
                } else {
                    // VISIBLE
                    layer.style.display = 'block';
                    subSidebar.classList.add('visible');

                    if (this.menuExpanded) {
                        subSidebar.classList.add('expanded');
                        expandBtn.innerHTML = '<i class="fa-solid fa-chevron-down"></i>';
                    } else {
                        expandBtn.innerHTML = '<i class="fa-solid fa-chevron-up"></i>';
                    }

                    if (this.mode === 1) {
                        layer.classList.add('mode-active');
                        icon.className = 'fa-solid fa-pen-nib';
                        btn.classList.add('sp-active-glow');
                    } else {
                        layer.classList.add('mode-passive');
                        icon.className = 'fa-solid fa-eye';
                        btn.classList.add('sp-passive-eye');
                    }

                    if (this.currentTool === 'text' && this.mode === 2) {
                        layer.classList.add('cursor-text');
                    }
                }
            },

            // --- INTERACTION ---
            handleStart: function (clientX, clientY) {
                const rect = this.canvas.getBoundingClientRect();
                this.lastX = clientX - rect.left;
                this.lastY = clientY - rect.top;

                if (this.currentTool === 'pen' || this.currentTool === 'eraser') {
                    this.isDrawing = true;
                    this.drawStep(this.lastX, this.lastY);
                }
            },

            handleMove: function (clientX, clientY) {
                const rect = this.canvas.getBoundingClientRect();
                const x = clientX - rect.left;
                const y = clientY - rect.top;

                if (this.isDrawing) {
                    this.drawStep(x, y);
                } else {
                    this.lastX = x;
                    this.lastY = y;
                }
            },

            handleEnd: function () {
                if (this.currentTool === 'text' && this.mode !== 0) {
                    this.openTextCloud(this.lastX, this.lastY);
                    return;
                }

                if (this.isDrawing) {
                    this.isDrawing = false;
                    this.save();
                }
            },

            drawStep: function (x, y) {
                this.ctx.beginPath();
                this.ctx.moveTo(this.lastX, this.lastY);
                this.ctx.lineTo(x, y);

                if (this.currentTool === 'pen') {
                    this.ctx.globalCompositeOperation = 'source-over';
                    this.ctx.strokeStyle = this.currentColor;
                    this.ctx.lineWidth = this.lineWidth;
                } else if (this.currentTool === 'eraser') {
                    this.ctx.globalCompositeOperation = 'destination-out';
                    this.ctx.lineWidth = this.eraserSize;
                }
                this.ctx.stroke();
                this.lastX = x; this.lastY = y;
            },

            // --- TOOLS & POPOUTS ---
            handlePressStart: function (toolName) {
                this.longPressTriggered = false;
                this.pressTimer = setTimeout(() => {
                    this.longPressTriggered = true;
                    this.togglePopout(toolName, true);
                }, 500);
            },

            handlePressEnd: function (toolName) { clearTimeout(this.pressTimer); if (!this.longPressTriggered) { if (this.currentTool === toolName) this.setTool('none'); else this.setTool(toolName); } },

            setTool: function (tool) {
                this.currentTool = tool;
                document.querySelectorAll('.sp-tool-item .btn-square').forEach(b => b.classList.remove('sp-tool-active'));
                if (tool !== 'none') {
                    const btn = document.getElementById(`btn-tool-${tool}`);
                    if (btn) btn.classList.add('sp-tool-active');
                }
                document.getElementById('sp-text-input-box').style.display = 'none';
                this.updateUI();
            },

            setColor: function (color) {
                this.currentColor = color;
                document.getElementById('sp-pen-color').value = color;
                const btn = document.getElementById('btn-tool-pen');
                if (btn) btn.style.color = color;
                this.setTool('pen');
                this.closeAllPopouts();
            },

            setOpacity: function (val) { document.getElementById('scratchpad-canvas').style.opacity = val; },

            // --- TEXT CLOUD (FIXED FOR MOBILE) ---
            openTextCloud: function (canvasX, canvasY) {
                const box = document.getElementById('sp-text-input-box');
                const input = document.getElementById('sp-text-input');
                const rect = this.canvas.getBoundingClientRect();

                // Store the EXACT place the user clicked on the map (for the text to land)
                this.pendingTextPos = { x: canvasX, y: canvasY };

                // LOGIC CHANGE: 
                // On mobile/narrow screens (< 768px), force box to TOP CENTER.
                // On Desktop, keep box near the cursor.
                const isMobile = window.innerWidth < 768;

                if (isMobile) {
                    // Fixed position at top of screen (safe from keyboard)
                    box.style.position = 'fixed';
                    box.style.left = '50%';
                    box.style.top = '80px'; // Clear of top bars
                    box.style.transform = 'translateX(-50%)'; // Center horizontally
                } else {
                    // Desktop: Keep following the mouse/cursor (Standard Absolute)
                    box.style.position = 'absolute';
                    box.style.transform = 'none';

                    const rawScreenX = rect.left + canvasX;
                    const rawScreenY = rect.top + canvasY;
                    const boxWidth = 220;
                    const boxHeight = 50;

                    // Clamp to be visible inside window bounds
                    const screenX = Math.min(window.innerWidth - boxWidth - 10, Math.max(10, rawScreenX));
                    const screenY = Math.min(window.innerHeight - boxHeight - 50, Math.max(60, rawScreenY - 40));

                    box.style.left = screenX + 'px';
                    box.style.top = screenY + 'px';
                }

                box.style.display = 'flex';
                input.value = "";

                // Focus Logic: Crucial for Android Keyboard trigger
                // We use a slight delay to allow the UI to repaint first
                input.focus();
                setTimeout(() => { input.focus(); }, 50);
            },

            commitText: function () {
                const input = document.getElementById('sp-text-input');
                const text = input.value;
                if (text && this.pendingTextPos) {
                    this.ctx.globalCompositeOperation = 'source-over';
                    this.ctx.font = `bold ${this.fontSize}px Consolas`;
                    this.ctx.fillStyle = this.currentColor;
                    this.ctx.fillText(text, this.pendingTextPos.x, this.pendingTextPos.y);
                    this.save();
                }
                document.getElementById('sp-text-input-box').style.display = 'none';
            },

            togglePopout: function (name, forceOpen = false) {
                const el = document.getElementById(`pop-${name}`);
                const wasOpen = el.classList.contains('show');
                this.closeAllPopouts();
                if (!wasOpen || forceOpen) el.classList.add('show');
            },
            closeAllPopouts: function () { document.querySelectorAll('.sp-popout').forEach(e => e.classList.remove('show')); },

            clear: function () { if (confirm("Clear Scratchpad?")) { this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); this.save(); } },
            resize: function () {
                const t = document.createElement('canvas'); const tx = t.getContext('2d');
                t.width = this.canvas.width; t.height = this.canvas.height;
                if (t.width > 0) tx.drawImage(this.canvas, 0, 0);
                this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight;
                this.ctx.drawImage(t, 0, 0); this.ctx.lineCap = 'round'; this.ctx.lineJoin = 'round';
            },
            save: function () { localStorage.setItem('dcs_Scratchpad_data', this.canvas.toDataURL()); },
            load: function () { const d = localStorage.getItem('dcs_Scratchpad_data'); if (d) { const i = new Image(); i.onload = () => { this.ctx.drawImage(i, 0, 0) }; i.src = d; } }
        };

        window.addEventListener('load', () => Scratchpad.init());

        // 9. HELPERS
        // --- DISPLAY & POWER HELPERS ---
        // --- FILTER AND TUNING LOGIC ---
        let filterSettings = {
            map: JSON.parse(localStorage.getItem('map_filters')) || {
                'dark': { br: 1.2, con: 1.2, op: 1.0 },
                'light': { br: 0.6, con: 1.8, op: 1.0 },
                'darkstreet': { br: 0.8, con: 1.2, op: 1.0 },
                'sat': { br: 0.9, con: 1.0, op: 1.0 },
                'vfr': { br: 0.6, con: 1.7, op: 1.0 },
                'vfr_night': { br: 1.8, con: 1.0, op: 1.0 },
                'relief': { br: 0.7, con: 1.2, op: 1.0 },
                'opentopo': { br: 1.0, con: 1.0, op: 1.0 },
                'cyclosm': { br: 1.0, con: 1.0, op: 1.0 }
            },
            nvg: JSON.parse(localStorage.getItem('nvg_filters')) || { br: 0.7, con: 0.9, op: 1.0, sep: 1.0 }
        };

        function tuneFilter(category, property, value) {
            if (category === 'map') {
                const currentLayer = currentMapLayerName;
                if (!filterSettings.map[currentLayer]) {
                    filterSettings.map[currentLayer] = { br: 1.0, con: 1.0, op: 1.0 };
                }
                filterSettings.map[currentLayer][property] = parseFloat(value);
                localStorage.setItem('map_filters', JSON.stringify(filterSettings.map));
            } else {
                filterSettings.nvg[property] = parseFloat(value);
                localStorage.setItem('nvg_filters', JSON.stringify(filterSettings.nvg));
            }
            applyVisualFilters();
        }

        function applyVisualFilters() {
            const curMap = filterSettings.map[currentMapLayerName] || { br: 1.0, con: 1.0, op: 1.0 };
            const curNvg = filterSettings.nvg;

            // 1. Map Tiles (Remains the same)
            document.documentElement.style.setProperty('--map-br', curMap.br);
            document.documentElement.style.setProperty('--map-con', curMap.con);
            document.documentElement.style.setProperty('--map-op', curMap.op);

            // 2. NVG "Color Bleed" Logic
            // This ensures that if Color Tint is 0, the Hue-Rotate is ALSO 0.
            const tintFactor = curNvg.sep !== undefined ? curNvg.sep : 1.0;

            const sepiaPercent = tintFactor * 100;

            // Only rotate the hue if the tint is actually active
            const hueVal = (currentNvgMode === 'green') ? (100 * tintFactor) : (-50 * tintFactor);

            // Intensity (Gain) now scales based on the Tint Factor
            // This prevents the "Greyscale" look when you want natural colors
            const baseSat = (currentNvgMode === 'green' ? 400 : 600);
            const saturatePercent = 100 + (curNvg.op * (baseSat - 100) * tintFactor);

            document.documentElement.style.setProperty('--nvg-sepia', `${sepiaPercent}%`);
            document.documentElement.style.setProperty('--nvg-hue', `${hueVal}deg`);
            document.documentElement.style.setProperty('--nvg-saturate', `${saturatePercent}%`);
            document.documentElement.style.setProperty('--nvg-br', curNvg.br);
            document.documentElement.style.setProperty('--nvg-con', curNvg.con);

            updateSliderUI('map', curMap);
            updateSliderUI('nvg', curNvg);
        }

        function updateSliderUI(cat, data) {
            const props = ['br', 'con', 'op', 'sep'];
            props.forEach(prop => {
                const sld = document.getElementById(`sld-${cat}-${prop}`);
                const valLabel = document.getElementById(`val-${cat}-${prop}`);

                if (sld) sld.value = data[prop];
                if (valLabel) {
                    valLabel.innerText = data[prop];
                }
            });
        }

        // Override setMapLayer to refresh tuning per map
        const originalSetMapLayer = setMapLayer; setMapLayer = function (name, skipSave = false) { originalSetMapLayer(name, skipSave); applyVisualFilters(); };

        window.addEventListener('load', () => applyVisualFilters());

        // --- NIGHT VISION LOGIC ---
        let currentNvgMode = 'off'; // 'off' -> 'red' -> 'green'
        function cycleNvgMode() { if (currentNvgMode === 'off') setNightVision('red'); else if (currentNvgMode === 'red') setNightVision('green'); else setNightVision('off'); }

        function setNightVision(mode) {
            currentNvgMode = mode;
            const body = document.body;
            const btn = document.getElementById('btn-ov-nvg');
            const icon = document.getElementById('icon-nvg-state');

            // 1. Reset Classes on Body
            body.classList.remove('nvg-red', 'nvg-green');

            // 2. Reset Button/Icon styling
            if (btn) btn.classList.remove('active');
            if (icon) {
                icon.className = 'fa-regular fa-square'; // Default Empty
                icon.style.color = ''; // Default Color
                icon.style.textShadow = 'none';
            }

            // 3. Apply New State
            if (mode === 'red') {
                body.classList.add('nvg-red');
                if (btn) btn.classList.add('active');
                if (icon) {
                    icon.className = 'fa-solid fa-square-check';
                    icon.style.color = '#e74c3c'; // Red
                    icon.style.textShadow = '0 0 5px #e74c3c';
                }
            } else if (mode === 'green') {
                body.classList.add('nvg-green');
                if (btn) btn.classList.add('active');
                if (icon) {
                    icon.className = 'fa-solid fa-square-check';
                    icon.style.color = '#2ecc71'; // Green
                    icon.style.textShadow = '0 0 5px #2ecc71';
                }
            }

            // --- ADDED THIS LINE ---
            // Force CSS variables to recalculate for the new mode (Red vs Green)
            applyVisualFilters();

            // 4. Persistence
            localStorage.setItem('dcs_nvg_mode', mode);
            saveMapSettings();
        }

        // Full Screen Logic
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error enabling full-screen mode: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function updateFullScreenIcon() {
            const btn = document.getElementById('btn-fullscreen');
            if (!btn) return;
            const icon = btn.querySelector('i');

            if (document.fullscreenElement) {
                icon.classList.remove('fa-expand');
                icon.classList.add('fa-compress');
                btn.classList.add('active');
            } else {
                icon.classList.remove('fa-compress');
                icon.classList.add('fa-expand');
                btn.classList.remove('active');
            }
        }

        // Listen for system changes (e.g. user presses 'Esc' or Android 'Back')
        document.addEventListener('fullscreenchange', updateFullScreenIcon);

        // Wake Lock Logic
        let wakeLock = null;

        async function toggleWakeLock() {
            const isChecked = document.getElementById('chk-opt-wakelock').checked;

            if (isChecked) {
                await requestWakeLock();
            } else {
                await releaseWakeLock();
            }
        }

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active');

                    // Release listener to clean up variable if lock is lost automatically
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock released by system');
                    });
                } catch (err) {
                    console.error(`${err.name}, ${err.message}`);
                    // If it fails, uncheck the box visually so user knows
                    const chk = document.getElementById('chk-opt-wakelock');
                    if (chk) chk.checked = false;
                }
            } else {
                console.log('Wake Lock API not supported');
            }
        }

        async function releaseWakeLock() { if (wakeLock !== null) { await wakeLock.release(); wakeLock = null; } }

        // Re-acquire lock if page becomes visible again (Android app switching)
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                const chk = document.getElementById('chk-opt-wakelock');
                if (chk && chk.checked) await requestWakeLock();
            }
        });

        // --- ALTITUDE HELPERS ---
        function toDisplayAlt(meters) { if (settings.altUnit === 'ft') return Math.round(meters * 3.28084); return Math.round(meters); }
        function fromDisplayAlt(userVal) { if (settings.altUnit === 'ft') return userVal / 3.28084; return userVal; }


        function cycleHudMode(forceMode = null) {
            if (forceMode !== null) hudMode = forceMode; else hudMode = (hudMode + 1) % 3;
            const overlay = document.getElementById('hud-overlay'); const btn = document.getElementById('btn-opt-hud');
            overlay.classList.remove('visible'); if (extHudWindow && !extHudWindow.closed) extHudWindow.close();
            if (hudMode === 0) { overlay.src = "about:blank"; if (btn) { btn.innerText = "OFF"; btn.style.color = "#aaa"; btn.style.borderColor = "#555"; } }
            else if (hudMode === 1) { overlay.src = "/hud?bg=transparent"; overlay.classList.add('visible'); if (btn) { btn.innerText = "OVERLAY"; btn.style.color = "#f1c40f"; btn.style.borderColor = "#f1c40f"; } }
            else if (hudMode === 2) { overlay.src = "about:blank"; extHudWindow = window.open('/hud', 'HUD', 'width=800,height=600,menubar=no,toolbar=no'); if (btn) { btn.innerText = "WINDOW"; btn.style.color = "#e74c3c"; btn.style.borderColor = "#e74c3c"; } }
        }

        // --- VISUAL TARGET / POI HANDLER ---
        socket.on('pois_update', function (poiList) {
            poiLayer.clearLayers();
            allPois = poiList;
            renderPois(); // Draw markers on map
            renderPoiList(); // Draw list in drawer

            // If we are currently navigating POIs, update the green line data in real-time
            if (activeRouteName === "Visual Targets") {
                activeRouteData = JSON.parse(JSON.stringify(allPois));
                activeRouteData.forEach((p, i) => { p.name = `T${i + 1}`; p.type = 'poi'; });
                renderMapRoutes();
            }
        });

        socket.on('visual_target_added', function (newPoi) {
            // 1. Check if we have an active mission
            if (!activeMissionName || !missions[activeMissionName]) {
                showToast(" No Mission Active: Target Discarded");
                return;
            }

            // 2. Add to Local State
            allPois.push(newPoi);

            // 3. Update Visuals immediately
            renderPois();
            renderPoiList();

            // 4. Save to Disk (This persists it to the Mission file)
            saveActiveMission();

            showToast(`Target Added: ${newPoi.name}`);
        });

        socket.on('server_handshake', function (data) {
            console.log("Server Handshake:", data.boot_id);

            if (currentBootId === null) {
                // First connection since page load. Store it.
                currentBootId = data.boot_id;
            } else if (currentBootId !== data.boot_id) {
                // We have a stored ID, but the server sent a different one.
                // This means the server restarted while we were open.
                console.log("Server restart detected! Reloading...");
                location.reload();
            }
        });

        socket.on('force_route_sync', function (data) {
            console.log("Syncing Route from Server:", data.name);

            // 1. Update Local Variables
            activeRouteData = data.route;
            activeWpIndex = data.index;
            activeRouteName = data.name;

            // 2. Handling "Stop" or "Clear" events (Empty Route)
            if (!activeRouteData || activeRouteData.length === 0) {
                activeRouteName = null;
                activeWpIndex = -1;
                activeLegLayer.clearLayers();
                renderMapRoutes();
                document.getElementById('mini-route-panel').classList.remove('visible');
                return; // Exit early
            }

            // 3. Update UI for Active Route
            renderMapRoutes();
            updateMiniPanel();
            document.getElementById('mini-route-panel').classList.add('visible');

            // 4. Optional: Open the POI drawer if it's Visual Mode
            if (activeRouteName === "Visual Targets") {
                renderPoiList();
            }

            showToast(`Synced: ${activeRouteName}`);
        });

        socket.on('map_settings_update', function (data) {
            console.log("Remote Settings Update:", data);

            // 1. Update Global Settings Var
            settings = { ...settings, ...data };
            if (data.nvgMode && data.nvgMode !== currentNvgMode) {
                setNightVision(data.nvgMode);
            }
            if (data.visibleRoutes) {
                // Check if lists are different to avoid unnecessary re-renders
                const currentArr = Array.from(visibleRoutes).sort();
                const newArr = data.visibleRoutes.sort();
                const isDifferent = JSON.stringify(currentArr) !== JSON.stringify(newArr);

                if (isDifferent) {
                    visibleRoutes = new Set(data.visibleRoutes);
                    renderBrowserList();
                    renderMapRoutes();
                    saveMapSettings();
                }
            }

            // 2. Sync Base Layer (Pass true to skip saving back to server)
            if (data.layer && data.layer !== currentMapLayerName) {
                setMapLayer(data.layer, true);
            }

            // 3. Sync Overlays
            if (data.overlays) {
                for (const [key, isActive] of Object.entries(data.overlays)) {
                    if (activeOverlays[key] !== isActive) {
                        toggleOverlay(key, isActive, true); // Pass true to skip save
                    }
                }
            }
            // 3.1 Sync Zoom
            if (data.view) {
                const currentZoom = map.getZoom();
                const currentCenter = map.getCenter();

                // Only update if significantly different (to avoid jitter)
                const dist = map.distance(currentCenter, data.view.center);
                if (dist > 100 || currentZoom !== data.view.zoom) {
                    isProgrammaticMove = true;
                    map.setView(data.view.center, data.view.zoom, { animate: true });
                    // Re-enable local saving after animation
                    setTimeout(() => isProgrammaticMove = false, 1000);
                }
            }

            // 4. Sync Visibility Toggles (Checkboxes)
            if (data.vis) {
                // Helper to update UI without triggering onchange events
                const syncChk = (id, val) => {
                    const el = document.getElementById(id);
                    if (el) el.checked = val;
                };

                syncChk('chk-vis-air', data.vis.airports);
                syncChk('chk-vis-unit', data.vis.units);
                syncChk('chk-vis-poi', data.vis.pois);
                syncChk('chk-vis-grid', data.vis.grid);
                syncChk('chk-vis-mgrs', data.vis.mgrs);
                syncChk('chk-opt-wakelock', data.vis.wakeLock);
                if (data.vis.wakeLock) requestWakeLock();
                else releaseWakeLock();

                if (data.vis.ptrStyle) { document.getElementById('opt-ptr-style').value = data.vis.ptrStyle; updatePointerVisuals(); }
                if (data.vis.ptrColor) { document.getElementById('opt-ptr-color').value = data.vis.ptrColor; updatePointerVisuals(); }

                // Actually toggle the layers visually
                if (data.vis.airports !== map.hasLayer(airportLayer)) toggleLayer(airportLayer);
                if (data.vis.units !== map.hasLayer(unitLayer)) toggleLayer(unitLayer);
                if (data.vis.pois !== map.hasLayer(poiLayer)) toggleLayer(poiLayer);
                if (data.vis.grid !== map.hasLayer(gridLayer)) toggleLayer(gridLayer);
                if (data.vis.mgrs !== map.hasLayer(mgrsGridLayer)) toggleLayer(mgrsGridLayer);
            }

            // 5. Update Grid Colors
            if (data.colors) {
                if (data.colors.latlon) document.documentElement.style.setProperty('--latlon-color', data.colors.latlon);
                if (data.colors.mgrs) document.documentElement.style.setProperty('--mgrs-color', data.colors.mgrs);
                if (data.colors.mgrsGzd) document.documentElement.style.setProperty('--mgrs-gzd-color', data.colors.mgrsGzd);
            }
        });

        socket.on('routes_library_update', function (data) {
            console.log("Library Update Received");
            // Check format
            const firstKey = Object.keys(data)[0];
            const isOldFormat = firstKey && data[firstKey].points;

            if (isOldFormat) {
                // Server has old data? Wrap it temporarily
                missions["Default Mission"].routes = data;
            } else {
                missions = data;
            }

            // Refresh Active View
            if (activeMissionName && missions[activeMissionName]) {
                allSavedRoutes = missions[activeMissionName].routes;
                allPois = missions[activeMissionName].pois || [];
                renderBrowserList();
                renderMapRoutes();
                renderPois();
            } else {
                renderMissionList();
            }
            showToast("Library Updated");
        });

        // --- SAVEMAPSETTINGS now explicitly looks for every ID we created in HTML ---
        async function saveMapSettings() {
            // Safe check helper (in case a button is removed in future, it defaults to false)
            const check = (id) => { const el = document.getElementById(id); return el ? el.checked : false; };

            const payload = {
                coords: settings.coords, altUnit: settings.altUnit, distUnit: settings.distUnit,
                defAlt: settings.defAlt, layer: currentMapLayerName,
                visibleRoutes: Array.from(visibleRoutes),
                navFlyBy: check('chk-opt-flyby'),
                navCourseLine: check('chk-opt-courseline'),
                colors: { latlon: document.getElementById('col-latlon').value, mgrs: document.getElementById('col-mgrs').value, mgrsGzd: document.getElementById('col-mgrs-gzd').value },            // Save Overlay States
                overlays: activeOverlays,
                view: { zoom: map.getZoom(), center: map.getCenter() },
                threatFill: parseInt(document.getElementById('sld-threat-fill').value),
                vis: {
                    airports: check('chk-vis-air'),
                    units: check('chk-vis-unit'),
                    units_air: check('chk-vis-unit-air'),
                    units_ground: check('chk-vis-unit-ground'),
                    units_naval: check('chk-vis-unit-naval'),
                    units_static: check('chk-vis-unit-static'),
                    pois: check('chk-vis-poi'),
                    threats: check('chk-vis-threats'),
                    grid: check('chk-vis-grid'),
                    mgrs: check('chk-vis-mgrs'),
                    alt: check('chk-vis-alt'),
                    hdg: check('chk-vis-hdg'),
                    wakeLock: check('chk-opt-wakelock'),
                    units_red: check('chk-vis-unit-red'),
                    units_blue: check('chk-vis-unit-blue'),
                    units_neutral: check('chk-vis-unit-neutral'),
                    hudMode: hudMode,
                    ptrStyle: document.getElementById('opt-ptr-style').value,
                    ptrColor: document.getElementById('opt-ptr-color').value
                }
            };
            await fetch('/api/map/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        }

        async function loadMapSettings() {
            try {
                const res = await fetch('/api/map/settings'); const data = await res.json();
                if (data.visibleRoutes) { visibleRoutes = new Set(data.visibleRoutes) };
                settings = { ...settings, ...data };
                // Restore NVG
                const savedNvg = data.nvgMode || localStorage.getItem('dcs_nvg_mode') || 'off';
                setNightVision(savedNvg);
                document.getElementById('opt-coords').value = data.coords || 'latlon';
                document.getElementById('opt-alt-unit').value = data.altUnit || 'ft';
                document.getElementById('opt-dist-unit').value = data.distUnit || 'nm';
                document.getElementById('opt-def-alt').value = data.defAlt || 20000;
                const flyByChk = document.getElementById('chk-opt-flyby');
                if (flyByChk) flyByChk.checked = (data.navFlyBy === true);
                const courseLineChk = document.getElementById('chk-opt-courseline');
                if (courseLineChk) courseLineChk.checked = (data.navCourseLine === true);
                const localScale = localStorage.getItem('dcs_map_ui_scale');
                if (localScale) { document.getElementById('opt-ui-scale').value = localScale; applyUiScale(localScale); }
                // Restore Base Layer
                if (data.layer && layers[data.layer]) setMapLayer(data.layer);
                // Restore Threat Opacity
                if (data.threatFill !== undefined) {
                    document.getElementById('sld-threat-fill').value = data.threatFill;
                    updateThreatFill(data.threatFill);
                }
                // Restore Overlays
                if (data.overlays) { for (const [key, isActive] of Object.entries(data.overlays)) { if (isActive) toggleOverlay(key, true); } }

                if (data.vis) {
                    setCheckboxAndLayer('chk-vis-air', airportLayer, data.vis.airports);
                    setCheckboxAndLayer('chk-vis-unit', unitLayer, data.vis.units);

                    // Granular Unit Settings (No Layer Toggle, just State)
                    const setChk = (id, val) => { const el = document.getElementById(id); if (el) el.checked = (val !== undefined ? val : true); };
                    setChk('chk-vis-unit-air', data.vis.units_air);
                    setChk('chk-vis-unit-ground', data.vis.units_ground);
                    setChk('chk-vis-unit-naval', data.vis.units_naval);
                    setChk('chk-vis-unit-static', data.vis.units_static);
                    setChk('chk-vis-unit-red', data.vis.units_red);
                    setChk('chk-vis-unit-blue', data.vis.units_blue);
                    setChk('chk-vis-unit-neutral', data.vis.units_neutral);

                    setCheckboxAndLayer('chk-vis-poi', poiLayer, data.vis.pois !== undefined ? data.vis.pois : true);
                    const threatChk = document.getElementById('chk-vis-threats');
                    if (threatChk) threatChk.checked = (data.vis.threats !== undefined ? data.vis.threats : true);
                    setCheckboxAndLayer('chk-vis-grid', gridLayer, data.vis.grid);
                    setCheckboxAndLayer('chk-vis-mgrs', mgrsGridLayer, data.vis.mgrs);

                    const altChk = document.getElementById('chk-vis-alt');
                    if (altChk) { altChk.checked = data.vis.alt; document.getElementById('pill-alt').classList.toggle('visible', data.vis.alt); }

                    const hdgChk = document.getElementById('chk-vis-hdg');
                    if (hdgChk) { hdgChk.checked = data.vis.hdg; document.getElementById('pill-hdg').classList.toggle('visible', data.vis.hdg); }

                    cycleHudMode(data.vis.hudMode !== undefined ? data.vis.hudMode : 0);

                    if (data.vis.ptrStyle) document.getElementById('opt-ptr-style').value = data.vis.ptrStyle;
                    if (data.vis.ptrColor) document.getElementById('opt-ptr-color').value = data.vis.ptrColor;
                    updatePointerVisuals();

                    const wlChk = document.getElementById('chk-opt-wakelock');
                    if (wlChk && data.vis.wakeLock) { wlChk.checked = true; requestWakeLock(); }
                }
                if (data.colors) { if (data.colors.latlon) document.getElementById('col-latlon').value = data.colors.latlon; if (data.colors.mgrs) document.getElementById('col-mgrs').value = data.colors.mgrs; if (data.colors.mgrsGzd) document.getElementById('col-mgrs-gzd').value = data.colors.mgrsGzd; }
                if (data.view) { isProgrammaticMove = true; map.setView(data.view.center, data.view.zoom); setTimeout(() => isProgrammaticMove = false, 500); }
                updateSettings();
            } catch (e) { }
        }

        function applyUiScale(val) {
            document.documentElement.style.setProperty('--ui-scale', val);
            document.getElementById('lbl-ui-scale').innerText = val;
            localStorage.setItem('dcs_map_ui_scale', val);
        }

        function updateSettings() {
            const newAltUnit = document.getElementById('opt-alt-unit').value;
            const newCoords = document.getElementById('opt-coords').value;

            // 1. Just Update the Config
            settings.altUnit = newAltUnit;
            settings.coords = newCoords;
            settings.distUnit = document.getElementById('opt-dist-unit').value;
            settings.defAlt = parseInt(document.getElementById('opt-def-alt').value) || 20000;
            settings.uiScale = document.getElementById('opt-ui-scale').value;

            // 2. Update UI Labels
            document.getElementById('lbl-def-alt-unit').innerText = settings.altUnit;
            document.getElementById('lbl-global-alt-unit').innerText = settings.altUnit;
            document.getElementById('inp-latlon-box').style.display = (settings.coords === 'latlon') ? 'block' : 'none';
            document.getElementById('inp-mgrs-box').style.display = (settings.coords === 'mgrs') ? 'block' : 'none';

            // 3. Update Global Input to match new unit (Visual Only)
            // We take the current default, assume it was in the OLD unit, and show it in NEW unit?
            // Or better: Just re-render. User can re-type if needed.
            document.getElementById('global-alt').value = settings.defAlt;

            // 4. Update Colors (CSS)
            const cLatLon = document.getElementById('col-latlon').value;
            const cMgrs = document.getElementById('col-mgrs').value;
            const cMgrsGzd = document.getElementById('col-mgrs-gzd').value;
            document.documentElement.style.setProperty('--latlon-color', cLatLon);
            document.documentElement.style.setProperty('--mgrs-color', cMgrs);
            document.documentElement.style.setProperty('--mgrs-gzd-color', cMgrsGzd);

            // 5. Redraw Everything (The render functions will handle the unit display)
            renderEditorPoints();
            renderMapRoutes();

            saveMapSettings();
        }

        function setCheckboxAndLayer(chkId, layer, shouldBeVisible) { const chk = document.getElementById(chkId); if (chk) { chk.checked = shouldBeVisible; if (shouldBeVisible && !map.hasLayer(layer)) map.addLayer(layer); if (!shouldBeVisible && map.hasLayer(layer)) map.removeLayer(layer); } }
        function toggleSidebar(side) { const el = document.getElementById(`sidebar-${side}`); const isHidden = el.classList.toggle(`hidden-${side}`); document.getElementById(`chk-${side}`).className = isHidden ? "fa-regular fa-square" : "fa-solid fa-square-check"; }
        function toggleLabels() { showWpLabels = !showWpLabels; document.getElementById('btn-labels').classList.toggle('active', showWpLabels); renderMapRoutes(); renderPois(); renderAirports(); }
        function toggleDrawer(name) {
            // 1. Close other drawers
            document.querySelectorAll('.drawer-panel').forEach(d => {
                if (d.id !== `${name}-drawer`) d.classList.remove('open');
            });

            // 2. LOGIC FIX: If leaving Route Drawer while Editing -> Exit Editor
            if (name !== 'route' && document.getElementById('view-editor').style.display === 'flex') {
                // Safely return to browser mode (cancels edit visually)
                showBrowser();
            }

            const el = document.getElementById(`${name}-drawer`);
            if (el) el.classList.toggle('open');

            // 3. LOGIC FOR ROUTE MANAGER
            if (name === 'route') {
                // If opening route drawer, decide which view to show
                if (activeMissionName && missions[activeMissionName]) {
                    // If we were editing, showBrowser() above already reset us. 
                    // We just need to ensure the view is correct.
                    if (document.getElementById('view-editor').style.display === 'none') {
                        document.getElementById('view-missions').style.display = 'none';
                        document.getElementById('view-browser').style.display = 'flex';
                        renderBrowserList();
                    }
                } else {
                    showMissionList();
                }
            }

            if (name === 'poi') renderPoiList();
        }

        function toggleLayer(layer, btn) { if (map.hasLayer(layer)) map.removeLayer(layer); else map.addLayer(layer); if (btn) btn.classList.toggle('active'); }
        function toggleInfo(type) { document.getElementById(`pill-${type}`).classList.toggle('visible'); }
        function toggleMapMenu() {
            const menu = document.getElementById('map-menu');
            const btn = document.getElementById('btn-map-layers');

            if (menu.classList.contains('show')) {
                menu.classList.remove('show');
            } else {
                // Calculate position based on the button's location
                const rect = btn.getBoundingClientRect();

                // Align top of menu with top of button
                menu.style.top = rect.top + 'px';

                // Position to the left of the button (Button Left - Menu Width - Margin)
                // Since menu is display:none, we need to show it briefly or guess.
                // Better strategy: Set Right edge to (Window Width - Button Left + Margin)
                const rightOffset = (window.innerWidth - rect.left) + 10;
                menu.style.right = rightOffset + 'px';

                menu.classList.add('show');
            }
        }

        // Update signature to accept skipSave
        function setMapLayer(name, skipSave = false) {
            // 1. Remove all BASE layers
            for (let key in layers) {
                if (map.hasLayer(layers[key])) map.removeLayer(layers[key]);
            }
            // 2. Add selected Base Layer
            if (layers[name]) {
                layers[name].addTo(map);
                currentMapLayerName = name;

                // Only save if this was a user click, NOT a server sync
                if (!skipSave) saveMapSettings();
            }

            document.getElementById('map-menu').classList.remove('show');
            document.querySelectorAll('.menu-item span').forEach(el => {
                if (el.parentElement.getAttribute('onclick').includes(name)) {
                    el.parentElement.classList.add('active');
                } else if (!el.parentElement.id.includes('btn-ov')) {
                    el.parentElement.classList.remove('active');
                }
            });
        }

        // Update signature
        function toggleOverlay(name, forceState = null, skipSave = false) {
            const layer = overlayLayers[name];
            const chk = document.getElementById(`chk-ov-${name}`);
            const btn = document.getElementById(`btn-ov-${name}`);

            let newState = !activeOverlays[name];
            if (forceState !== null) newState = forceState;

            if (newState) {
                if (!map.hasLayer(layer)) map.addLayer(layer);
                activeOverlays[name] = true;
                if (chk) chk.checked = true;
                if (btn) btn.classList.add('active');
            } else {
                if (map.hasLayer(layer)) map.removeLayer(layer);
                activeOverlays[name] = false;
                if (chk) chk.checked = false;
                if (btn) btn.classList.remove('active');
            }

            // Only save if not skipping (Server Sync) AND not a forced state load
            if (forceState === null && !skipSave) saveMapSettings();
        }

        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }

        function toDmsInput(deg, isLat) {
            const absDeg = Math.abs(deg); const d = Math.floor(absDeg); const m = Math.floor((absDeg - d) * 60); const s = ((absDeg - d - m / 60) * 3600).toFixed(2);
            let dir = ""; if (isLat) dir = deg >= 0 ? "N" : "S"; else dir = deg >= 0 ? "E" : "W";
            return `${dir} ${String(d).padStart(isLat ? 2 : 3, '0')} ${String(m).padStart(2, '0')} ${String(s).padStart(5, '0')}`;
        }
        function parseDMS(dmsString) {
            if (!dmsString) return 0; const s = dmsString.trim().toUpperCase();
            let isNeg = false; if (s.includes('S') || s.includes('W')) isNeg = true;
            const matches = s.match(/[\d.]+/g); if (!matches || matches.length < 3) return 0;
            const deg = parseFloat(matches[0]); const min = parseFloat(matches[1]); const sec = parseFloat(matches[2]);
            let val = deg + (min / 60.0) + (sec / 3600.0); if (isNeg) val = -val; return val;
        }
        function maskDMS(input, type) { /* (Logic Identical to prev) */ let v = input.value.toUpperCase().replace(/[^NESW\d.]/g, ''); if (v.length > 0 && !['N', 'S', 'E', 'W'].includes(v[0])) { v = (type === 'lat' ? 'N' : 'E') + v; } let dir = v.charAt(0); if (type === 'lat' && !['N', 'S'].includes(dir)) v = 'N' + v.substring(1); if (type === 'lon' && !['E', 'W'].includes(dir)) v = 'E' + v.substring(1); let raw = v.substring(1).replace(/[^\d]/g, ''); if (type === 'lon' && raw.length >= 1 && !['0', '1'].includes(raw[0])) raw = '0' + raw.substring(1); let degLen = (type === 'lat') ? 2 : 3; let out = dir + " "; if (raw.length > 0) out += raw.substring(0, degLen); if (raw.length >= degLen) out += " " + raw.substring(degLen, degLen + 2); if (raw.length > degLen) { let m1 = raw.charAt(degLen); if (parseInt(m1) > 5) raw = raw.substring(0, degLen) + '5' + raw.substring(degLen + 1); } if (raw.length >= degLen + 2) out += " " + raw.substring(degLen + 2, degLen + 4); if (raw.length > degLen + 2) { let s1 = raw.charAt(degLen + 2); if (parseInt(s1) > 5) raw = raw.substring(0, degLen + 2) + '5' + raw.substring(degLen + 3); } if (raw.length >= degLen + 4) { out += "." + raw.substring(degLen + 4, degLen + 6); } input.value = out; }

        function maskMGRS(input) { let v = input.value.toUpperCase().replace(/[^A-Z0-9]/g, ''); let out = ""; if (v.length > 0) out += v.substring(0, 3); if (v.length > 3) out += " " + v.substring(3, 5); if (v.length > 5) out += " " + v.substring(5, 10); if (v.length > 10) out += " " + v.substring(10, 15); input.value = out; }

        function formatCoordDisplay(lat, lon) {
            if (settings.coords === 'mgrs') {
                try { return MGRSString(lat, lon); } catch (e) { return "MGRS Err"; }
            }
            const toDms = (deg, isLat) => { const d = Math.floor(deg); const m = Math.floor((deg - d) * 60); const s = ((deg - d - m / 60) * 3600).toFixed(2); return `${isLat ? 'N' : 'E'} ${String(d).padStart(isLat ? 2 : 3, '0')} ${String(m).padStart(2, '0')}' ${s}"`; };
            return `${toDms(lat, true)}\n${toDms(lon, false)}`;
        }

        async function getGroundElevation(lat, lon) { try { const resp = await fetch(`https://api.open-meteo.com/v1/elevation?latitude=${lat}&longitude=${lon}`); const data = await resp.json(); if (data && data.elevation) return data.elevation[0]; } catch (e) { } return 0; }

        function toggleSeq() { const chk = document.getElementById('chk-opt-autoseq'); if (chk) { autoSeq = chk.checked; socket.emit('toggle_seq', { state: autoSeq }); } }
        function switchToEditor() { document.getElementById('view-browser').style.display = 'none'; document.getElementById('view-editor').style.display = 'flex'; }
        function createNewRoute() { editingRouteName = ""; editingRouteData = []; activeWpIndex = -1; wpCounter = 1; document.getElementById('save-color').value = "#78aabc"; document.getElementById('route-title').innerText = "New Route"; document.getElementById('save-name').value = ""; switchToEditor(); renderEditorPoints(); }
        function setClickMode(mode) { clickMode = (clickMode === mode) ? 'none' : mode; document.getElementById('btn-mode-wp').classList.toggle('active', clickMode === 'wp'); document.getElementById('btn-mode-tgt').classList.toggle('active', clickMode === 'tgt'); document.getElementById('btn-mode-poi').classList.toggle('active', clickMode === 'poi'); document.getElementById('map').style.cursor = (clickMode !== 'none') ? 'crosshair' : 'default'; if (clickMode != 'none') distMode = false; }
        function toggleManualInput() { const f = document.getElementById('manual-form'); f.style.display = (f.style.display === 'none') ? 'block' : 'none'; }
        function updateServerNav() { socket.emit('set_active_wp', { index: activeWpIndex, route: activeRouteData, name: activeRouteName }); }
        function autoRenameWaypoints() { let w = 1, t = 1; editingRouteData.forEach(p => { if (p.type === 'tgt') p.name = `TGT ${t++}`; else p.name = `WP ${w++}`; }); renderEditorPoints(); renderEditorMap(); }
        async function loadSavedRoutes() {
            try {
                // Added timestamp to prevent browser caching old data
                const res = await fetch(`/api/routes?t=${Date.now()}`);
                const data = await res.json();

                const firstKey = Object.keys(data)[0];
                // Check if this is the "Old Format" (Root keys are route names, not missions)
                const isOldFormat = firstKey && data[firstKey].points;

                if (isOldFormat) {
                    missions = { "Legacy Mission": { imported: "L", map: null, routes: data, pois: [] } };
                } else {
                    missions = data;
                }
                // Check LocalStorage for a previously active mission
                const lastMission = localStorage.getItem('last_active_mission');
                if (lastMission && missions[lastMission]) {
                    activeMissionName = lastMission;
                }

                // Restore view if we were editing a specific mission
                if (activeMissionName && missions[activeMissionName]) {
                    selectMission(activeMissionName);
                } else {
                    renderMissionList();
                }
            } catch (e) { console.error("Load failed", e); }
        }

        async function saveCurrentRoute() {
            if (!activeMissionName) { showToast("No Active Mission"); return; }

            const name = document.getElementById('save-name').value || "Unnamed Route";
            const color = document.getElementById('save-color').value;
            editingRouteName = name;

            // 1. Update the Route Data Object
            const newRouteObj = { color: color, points: editingRouteData };

            // 2. SAFETY: Ensure the mission route list exists
            if (!missions[activeMissionName]) return;
            if (!missions[activeMissionName].routes) missions[activeMissionName].routes = {};

            // 3. Update the Master Mission List
            missions[activeMissionName].routes[name] = newRouteObj;

            // 4. Update the Local Reference (so the UI updates immediately)
            allSavedRoutes = missions[activeMissionName].routes;

            // 5. Update Active State if we are flying this route
            if (activeRouteName === name || activeRouteName === "New Route") {
                activeRouteName = name;
                activeRouteData = editingRouteData;
                updateServerNav();
            }

            renderMapRoutes();

            // 6. SAVE TO SERVER
            await saveAllMissions();

            showToast("Route Saved");
            showBrowser();
        }

        // --- MISSION LOGIC START ---

        function createNewMission() {
            // 1. Prevent multiple input rows
            if (document.getElementById('new-mission-row')) {
                document.getElementById('new-mission-name').focus();
                return;
            }

            const list = document.getElementById('mission-list');

            // 2. Clear "No Missions" text if it exists
            if (Object.keys(missions).length === 0) {
                list.innerHTML = "";
            }

            // 3. Create the inline edit row
            const div = document.createElement('div');
            div.id = 'new-mission-row';
            div.className = 'saved-route-item';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.padding = '5px';
            div.style.gap = '10px';
            div.style.borderLeft = '3px solid #78aabc';
            div.style.background = 'rgba(120, 170, 188, 0.1)';

            // 4. Inject Input Field and Buttons
            div.innerHTML = `
            <div style="flex-grow:1; display:flex; align-items:center;">
                <div class="input-with-kb" style="width:100%;">
                    <input type="text" id="new-mission-name" placeholder="Enter Mission Name..." 
                           style="width:100%; border:1px solid #78aabc; background:#111; color:#fff; padding:5px; font-weight:bold;"
                           onkeydown="if(event.key==='Enter') saveNewMission()">
                    <div class="kb-trigger" onclick="openKeyboard('new-mission-name', 'text')"></div>
                </div>
            </div>
            <button class="list-btn" onclick="saveNewMission()" title="Save"><i class="fa-solid fa-check" style="color:#2ecc71;"></i></button>
            <button class="list-btn delete" onclick="cancelNewMission()" title="Cancel"><i class="fa-solid fa-xmark"></i></button>
        `;

            // 5. Prepend to list (Appear at top) and Focus
            list.prepend(div);
            setTimeout(() => document.getElementById('new-mission-name').focus(), 50);
        }

        // Explicitly go back to the top level
        function exitToMissionSelector() {
            // 1. Clear the remembered active mission
            activeMissionName = null;
            localStorage.removeItem('last_active_mission');

            // 2. Clear map visuals associated with that mission
            activeRouteName = null;
            routeLayer.clearLayers();
            activeLegLayer.clearLayers();
            document.getElementById('mini-route-panel').classList.remove('visible');

            // 3. Show the Mission List
            showMissionList();
        }

        async function saveNewMission() {
            const input = document.getElementById('new-mission-name');
            const name = input.value.trim();

            if (!name) {
                showToast("Name required");
                input.focus();
                return;
            }
            if (missions[name]) {
                alert("Mission name already exists!");
                input.focus();
                return;
            }

            // Create the new mission object
            missions[name] = {
                imported: "L",
                map: "Caucasus",
                routes: {},
                pois: []
            };

            // Clean up UI
            cancelNewMission(); // Removes the input row

            // Save and Refresh List
            await saveAllMissions();
            renderMissionList();
        }

        function cancelNewMission() {
            const row = document.getElementById('new-mission-row');
            if (row) row.remove();

            // If list is now empty, re-render to show "No Missions" message
            if (Object.keys(missions).length === 0) {
                renderMissionList();
            }
        }

        function selectMission(name) {
            if (!missions[name]) return;

            // 1. Remember the Mission
            activeMissionName = name;
            localStorage.setItem('last_active_mission', name);
            // 2. Update Header Title
            document.getElementById('browser-title').innerText = `Route Manager: ${name}`;

            // 3. Update Mission Info Bar (Optional context)
            document.getElementById('lbl-active-map').innerText = "Map: " + (missions[name].map || "None");
            const statusSpan = document.getElementById('lbl-mission-status');
            statusSpan.innerText = (missions[name].imported === 'I') ? "IMPORTED" : "LOCAL";
            statusSpan.style.color = (missions[name].imported === 'I') ? "#e67e22" : "#78aabc";

            // 4. BIND DATA
            allSavedRoutes = missions[name].routes || {};
            allPois = missions[name].pois || [];

            // 5. STRICT VIEW SWITCHING (State 2)
            document.getElementById('view-missions').style.display = 'none'; // Hide Selector
            document.getElementById('view-editor').style.display = 'none';   // Hide Editor
            document.getElementById('view-browser').style.display = 'flex';  // Show Route List

            renderBrowserList();
            renderMapRoutes();
            renderPois();
        }

        function showMissionList() {
            // STATE 1: MISSION SELECTOR
            // Hide Route Browser and Editor
            document.getElementById('view-browser').style.display = 'none';
            document.getElementById('view-editor').style.display = 'none';

            // Show Mission List
            document.getElementById('view-missions').style.display = 'flex';

            renderMissionList();
        }

        function renderMissionList() {
            const list = document.getElementById('mission-list');
            list.innerHTML = "";

            const missionKeys = Object.keys(missions);
            if (missionKeys.length === 0) {
                list.innerHTML = `<div style="padding:10px; color:#555; text-align:center;">No Missions Created</div>`;
                return;
            }

            missionKeys.forEach(key => {
                const data = missions[key];
                const div = document.createElement('div');
                div.className = 'saved-route-item draggable-mission';

                // 1. ENABLE ROW DRAG (Standard HTML5 Drag)
                div.draggable = true;
                div.dataset.missionName = key;

                // Styling
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.padding = '5px';
                div.style.gap = '10px';

                // 2. ENABLE ROW CLICK (Select Mission)
                div.onclick = () => selectMission(key);

                div.innerHTML = `
                <div class="drag-handle" style="color:#555; padding:0 5px;">
                    <i class="fa-solid fa-grip-vertical"></i>
                </div>
                
                <div style="flex-grow:1;">
                    <div style="font-weight:bold; color:#d1e3ea; font-size:13px;">${key}</div>
                    <div style="font-size:10px; color:#888;">${Object.keys(data.routes || {}).length} Routes | ${(data.pois || []).length} POIs</div>
                </div>

                <div style="margin-right:5px;" onmousedown="event.stopPropagation()" onclick="event.stopPropagation()">
                    <select class="map-selector" onchange="updateMissionMap('${key}', this.value)" style="width:80px; padding:2px; font-size:10px; background:#111; color:#aaa; border:1px solid #444; cursor:pointer;">
                        <option value="None" ${!data.map ? 'selected' : ''}>-- Map --</option>
                        ${dcsMaps.map(m => `<option value="${m}" ${data.map === m ? 'selected' : ''}>${m}</option>`).join('')}
                    </select>
                </div>
                
                <button class="list-btn delete" onmousedown="event.stopPropagation()" onclick="event.stopPropagation(); deleteMission('${key}')">
                    <i class="fa-solid fa-trash"></i>
                </button>
            `;

                div.addEventListener('dragstart', handleMissionDragStart);
                div.addEventListener('dragend', handleMissionDragEnd);
                list.appendChild(div);
            });
        }

        function updateMissionMap(name, mapVal) {
            if (missions[name]) {
                missions[name].map = (mapVal === "None") ? null : mapVal;
                saveAllMissions();
            }
        }

        async function deleteMission(name) {
            if (confirm(`Delete mission "${name}" and all contents?`)) {
                delete missions[name];

                // If we deleted the last mission, create a clean object so we don't save "null"
                if (Object.keys(missions).length === 0) {
                    // Optional: You can choose to leave it empty, 
                    // but saving an empty object {} is safer than undefined.
                }

                await saveAllMissions(); // Wait for server write
                renderMissionList();
            }
        }

        // --- MISSION DRAG & DROP ---
        function handleMissionDragStart(e) { this.classList.add('dragging'); }
        function handleMissionDragEnd(e) {
            this.classList.remove('dragging');

            // Rebuild Object Order
            const newMissions = {};
            document.querySelectorAll('#mission-list .draggable-mission').forEach(el => {
                const key = el.dataset.missionName;
                if (missions[key]) newMissions[key] = missions[key];
            });
            missions = newMissions;
            saveAllMissions();
        }

        // Attach listener to container
        const missionContainer = document.getElementById('mission-list');
        missionContainer.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(missionContainer, e.clientY, '.draggable-mission');
            const draggable = document.querySelector('.dragging');
            if (draggable) {
                if (afterElement == null) missionContainer.appendChild(draggable);
                else missionContainer.insertBefore(draggable, afterElement);
            }
        });

        async function saveAllMissions() {
            // Full Sync
            await fetch('/api/routes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(missions)
            });
        }

        async function saveActiveMission() {
            if (!activeMissionName || !missions[activeMissionName]) return;

            // 1. Force-Sync the Active Arrays back to the Mission Object
            // (This fixes the issue where sorting or filtering broke the link)
            missions[activeMissionName].routes = allSavedRoutes;
            missions[activeMissionName].pois = allPois;

            // 2. Save everything to Server
            await saveAllMissions();
        }
        // --- MISSION LOGIC END ---

        async function loadSavedPois() { if (activeMissionName && missions[activeMissionName]) { allPois = missions[activeMissionName].pois || []; renderPois(); if (typeof renderPoiList === 'function') renderPoiList(); } }
        function activateRoute(name) { if (allSavedRoutes[name]) { activeRouteName = name; activeRouteData = allSavedRoutes[name].points || allSavedRoutes[name]; activeWpIndex = 0; visibleRoutes.add(name); updateServerNav(); renderMapRoutes(); document.getElementById('route-drawer').classList.remove('open'); updateMiniPanel(); document.getElementById('mini-route-panel').classList.add('visible'); showToast(`Route Active: ${name}`); } }
        function stopRoute() { activeRouteName = null; activeRouteData = []; activeWpIndex = -1; updateServerNav(); document.getElementById('mini-route-panel').classList.remove('visible'); document.getElementById('route-drawer').classList.add('open'); activeLegLayer.clearLayers(); renderMapRoutes(); renderBrowserList(); showToast("Route Stopped"); }
        function updateMiniPanel() { if (!activeRouteName) return; document.getElementById('mini-route-name').innerText = activeRouteName; let wpName = "N/A"; if (activeRouteData[activeWpIndex]) wpName = activeRouteData[activeWpIndex].name || `WP ${activeWpIndex + 1}`; document.getElementById('mini-wp-name').innerText = wpName; }
        function cycleWp(dir) { socket.emit('cycle_wp', { dir: dir }); }
        function activateVisualRoute() { if (allPois.length === 0) { showToast("No Visual Targets to Follow"); return; } activatePoiFromModal(0); }
        // --- GENERIC DRAG & DROP HANDLERS ---
        let dragSrcEl = null;
        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            // Hack to allow drag image rendering before opacity change
            setTimeout(() => this.classList.add('dragging'), 0);
        }
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.draggable-row').forEach(row => {
                row.classList.remove('over');
            });
        }

        // Generic helper to find insertion point
        function getDragAfterElement(container, y, selector) {
            const draggableElements = [...container.querySelectorAll(`${selector}:not(.dragging)`)];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        function renderBrowserList() {
            const list = document.getElementById('saved-list');
            list.innerHTML = "";

            // --- 1. SPECIAL "VISUAL TARGETS" ROW ---
            const poiCount = allPois.length;
            const isPoiActive = (activeRouteName === "Visual Targets");
            const isPoiVisible = map.hasLayer(poiLayer);

            const poiDiv = document.createElement('div');
            poiDiv.className = `saved-route-item ${isPoiActive ? 'is-active' : ''}`;
            poiDiv.style.borderLeftColor = "#f1c40f";

            // Exact styling match to standard rows
            poiDiv.style.display = 'flex';
            poiDiv.style.alignItems = 'center';
            poiDiv.style.padding = '5px';
            poiDiv.style.gap = '0px';

            poiDiv.draggable = true;
            poiDiv.dataset.routeName = "Visual Targets";
            poiDiv.addEventListener('dragstart', handleDragStart);
            poiDiv.addEventListener('dragend', handleDragEnd);

            poiDiv.innerHTML = `
            <button id="btn-vis-poi-list" class="list-btn ${isPoiVisible ? 'active' : ''}" style="width:30px; margin-right:5px;" onclick="event.stopPropagation(); toggleLayer(poiLayer, null); saveMapSettings();" title="Toggle POI Visibility">
                <i class="fa-solid fa-eye"></i>
            </button>
            
            <div style="flex-grow:1; width:0; display:flex; align-items:center; justify-content:space-between; padding:0 5px; pointer-events:none;">
                <span style="font-weight:bold; font-size:13px; color:#d1e3ea; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Visual Targets</span>
                
                <span style="font-size:10px; color:#aaa; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px; white-space:nowrap;">
                    ${poiCount} POI
                </span>
            </div>

            <button class="list-btn ${isPoiActive ? 'active' : ''}" style="width:30px;" onclick="event.stopPropagation(); activateVisualRoute()" title="Navigate Visual Targets">
                <i class="fa-solid fa-crosshairs"></i>
            </button>

            <button class="list-btn" style="width:30px;" onclick="event.stopPropagation(); toggleDrawer('poi')" title="Open Target List">
                <i class="fa-solid fa-list-ul"></i>
            </button>
        `;
            list.appendChild(poiDiv);

            // --- 2. RENDER STANDARD ROUTES ---
            if (Object.keys(allSavedRoutes).length === 0) {
                if (poiCount === 0) {
                    const empty = document.createElement('div');
                    empty.innerHTML = `<div style="text-align:center; padding:10px; color:#555; font-size:11px;">No Saved Routes</div>`;
                    list.appendChild(empty);
                    return;
                }
            }

            Object.entries(allSavedRoutes).forEach(([name, rData]) => {
                const rColor = rData.color || "#78aabc";
                const isActive = (name === activeRouteName);
                const isVisible = visibleRoutes.has(name) || isActive;

                const div = document.createElement('div');
                div.className = `saved-route-item ${isActive ? 'is-active' : ''}`;
                div.draggable = true;
                div.dataset.routeName = name;
                div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.padding = '5px'; div.style.gap = '0px';

                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragend', handleDragEnd);
                div.onclick = () => openEditor(name);

                div.innerHTML = `
                <button class="list-btn ${isVisible ? 'active' : ''}" style="width:30px; margin-right:5px;" onclick="event.stopPropagation(); toggleRouteVis('${name}')">
                    <i class="fa-solid fa-eye"></i>
                </button>
                <div style="flex-grow:1; width:0; display:flex; align-items:center; justify-content:space-between; padding:0 5px; pointer-events:none;">
                    <span style="font-weight:bold; font-size:13px; color:#d1e3ea; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${name}</span>
                    <input type="color" class="color-picker-mini" value="${rColor}" onclick="event.stopPropagation()" onchange="updateRouteColor('${name}', this.value)" style="pointer-events:auto;">
                </div>
                <button class="list-btn ${isActive ? 'active' : ''}" style="width:30px;" onclick="event.stopPropagation(); activateRoute('${name}')"><i class="fa-solid fa-crosshairs"></i></button>
                <button class="list-btn delete" style="width:30px;" onclick="event.stopPropagation(); deleteRoute('${name}')"><i class="fa-solid fa-trash"></i></button>
            `;
                list.appendChild(div);
            });
        }

        // Helper for Route List HTML actions to keep code clean
        function toggleRouteVis(name) {
            if (visibleRoutes.has(name)) visibleRoutes.delete(name);
            else visibleRoutes.add(name);
            renderBrowserList(); renderMapRoutes(); saveMapSettings();
        }
        async function updateRouteColor(name, color) {
            if (allSavedRoutes[name]) {
                allSavedRoutes[name].color = color;
            }
            renderMapRoutes();
            await saveActiveMission();
        }
        async function deleteRoute(name) {
            if (confirm(`Delete route "${name}"?`)) {
                delete allSavedRoutes[name];
                await saveAllMissions();
                if (activeRouteName === name) stopRoute();
                renderBrowserList(); renderMapRoutes();
            }
        }

        // Logic to handle dropping a route (Sort Persistence)
        function handleRouteListDrop(e) {
            if (e.stopPropagation) e.stopPropagation();

            const container = document.getElementById('saved-list');
            const newOrderObj = {};

            // Reconstruct the object based on DOM order
            [...container.querySelectorAll('.saved-route-item')].forEach(row => {
                const name = row.dataset.routeName;
                if (name && allSavedRoutes[name]) {
                    newOrderObj[name] = allSavedRoutes[name];
                }
            });

            allSavedRoutes = newOrderObj;

            // Persistence: Emit to server to overwrite the JSON file order
            // Note: This relies on the server supporting a bulk update or implicit ordering
            saveActiveMission();
        }

        function openEditor(name) { editingRouteName = name; const rawData = allSavedRoutes[name].points || allSavedRoutes[name]; editingRouteData = JSON.parse(JSON.stringify(rawData)); document.getElementById('save-name').value = name; document.getElementById('save-color').value = allSavedRoutes[name].color || "#78aabc"; document.getElementById('route-title').innerText = "Edit: " + name; let maxWp = 0; editingRouteData.forEach(p => { if (p.name && p.name.startsWith('WP ')) { let num = parseInt(p.name.split(' ')[1]); if (num > maxWp) maxWp = num; } }); wpCounter = maxWp + 1; if (visibleRoutes.has(name)) { visibleRoutes.delete(name); renderMapRoutes(); } switchToEditor(); renderEditorPoints(); renderEditorMap(); }
        function showBrowser() { document.getElementById('view-browser').style.display = 'flex'; document.getElementById('view-editor').style.display = 'none'; document.getElementById('manual-form').style.display = 'none'; setClickMode('none'); activeEditIndex = -1; editorLayer.clearLayers(); if (editingRouteName && allSavedRoutes[editingRouteName]) visibleRoutes.add(editingRouteName); renderBrowserList(); renderMapRoutes(); }
        function renderMapRoutes() {
            routeLayer.clearLayers(); activeLegLayer.clearLayers();
            for (const [name, rData] of Object.entries(allSavedRoutes)) {
                const isActive = (name === activeRouteName); if (!visibleRoutes.has(name) && !isActive) continue; const pts = rData.points || rData; const color = rData.color || "#78aabc"; if (!pts || pts.length === 0) continue;
                if (isActive) {
                    pts.forEach((pt, i) => {
                        const isTgt = pt.type === 'tgt';
                        const isNext = (i === activeWpIndex);
                        const htmlColor = isNext ? '#fff' : color;
                        const iconHtml = isTgt ? `<div style="color:${htmlColor}; font-size:20px; filter:drop-shadow(0 0 3px black);"></div>` : `<div style="color:${htmlColor}; font-size:20px; filter:drop-shadow(0 0 3px black);"><i class="fa-solid fa-location-dot"></i></div>`;
                        const icon = L.divIcon({ className: 'rt-icon', html: iconHtml, iconSize: [20, 20], iconAnchor: [10, 20] });
                        const m = L.marker([pt.lat, pt.lon], { icon: icon }).addTo(routeLayer);

                        // --- CHANGED BLOCK START ---
                        m.on('click', () => {
                            const coordStr = formatCoordDisplay(pt.lat, pt.lon);
                            const displayAlt = toDisplayAlt(pt.alt); // Convert Meters -> Display Unit
                            const detailHtml = `<div style="font-weight:bold; color:#333; margin-bottom:4px;">${pt.name}</div><div style="font-size:11px; color:#555;">${displayAlt} ${pt.altType || settings.altUnit}</div><div style="font-family:monospace; margin-top:5px; font-size:10px; color:#000;">${coordStr.replace('\n', '<br>')}</div>`;
                            L.popup().setLatLng([pt.lat, pt.lon]).setContent(detailHtml).openOn(map);
                        });

                        const labelAlt = toDisplayAlt(pt.alt); // Convert for label
                        if (showWpLabels) m.bindTooltip(`${pt.name} | ${labelAlt}`, { permanent: true, direction: 'right', className: 'airport-label' });
                        else m.bindTooltip(pt.name, { permanent: false, direction: 'top' });
                        // --- CHANGED BLOCK END ---
                    });

                    if (activeWpIndex > 0) { const pastPts = pts.slice(0, activeWpIndex + 1).map(p => [p.lat, p.lon]); if (pastPts.length > 1) L.polyline(pastPts, { color: '#555', weight: 2 }).addTo(routeLayer); }
                    if (activeWpIndex >= 0 && activeWpIndex < pts.length) { const futurePts = pts.slice(activeWpIndex).map(p => [p.lat, p.lon]); if (futurePts.length > 1) L.polyline(futurePts, { color: color, weight: 3, dashArray: '10, 10' }).addTo(routeLayer); }
                    if (activeWpIndex > 0 && activeWpIndex < pts.length) { const prev = pts[activeWpIndex - 1]; const curr = pts[activeWpIndex]; L.polyline([[prev.lat, prev.lon], [curr.lat, curr.lon]], { color: '#0f0', weight: 4, opacity: 0.3 }).addTo(routeLayer); }
                } else {
                    const latlngs = pts.map(p => [p.lat, p.lon]);
                    L.polyline(latlngs, { color: color, weight: 2, dashArray: '3, 6', opacity: 0.8 }).addTo(routeLayer);
                    pts.forEach(pt => {
                        const cm = L.circleMarker([pt.lat, pt.lon], { radius: 3, color: color, fillOpacity: 1 }).addTo(routeLayer);
                        if (showWpLabels) {
                            cm.bindTooltip(`${pt.name}`, { permanent: true, direction: 'right', className: 'airport-label' });
                        }
                    });
                }
            }
        }

        function renderEditorPoints() {
            const list = document.getElementById('active-route-list');
            list.innerHTML = "";
            let totalMeters = 0;

            if (editingRouteData.length > 1) {
                const pts = editingRouteData.map(p => L.latLng(p.lat, p.lon));
                for (let i = 0; i < pts.length - 1; i++) { totalMeters += pts[i].distanceTo(pts[i + 1]); }
            }

            let totalStr = (settings.distUnit === 'nm') ? (totalMeters * 0.000539957).toFixed(1) + " nm" : (totalMeters / 1000).toFixed(1) + " km";
            document.getElementById('route-footer').innerText = "Total: " + totalStr;

            editingRouteData.forEach((pt, i) => {
                const div = document.createElement('div');
                div.className = `route-item`;
                div.draggable = true;
                div.dataset.index = i;

                if (activeEditIndex === i) {
                    div.style.background = "rgba(46, 204, 113, 0.15)";
                    div.style.borderLeft = "3px solid #2ecc71";
                }

                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragend', handleDragEnd);
                // NOTE: 'dragover' and 'drop' are now handled by the CONTAINER

                const displayAlt = toDisplayAlt(pt.alt);

                div.innerHTML = `
                <div style="flex-grow:1; display:flex; flex-direction:column;">
                    <div style="font-weight:bold; font-size:12px; color:#fff;">${pt.name} <span style="color:#aaa; font-weight:normal;">| ${displayAlt} ${pt.altType || settings.altUnit}</span></div>
                    <div style="font-family:monospace; font-size:11px; color:#888;">${formatCoordDisplay(pt.lat, pt.lon).replace('\n', ' ')}</div>
                </div>
                <div style="display:flex; gap: 5px;">
                    <button onclick="startManualEdit(${i})" title="Edit" style="background:none; border:none; color:#f1c40f; cursor:pointer;"><i class="fa-solid fa-pencil"></i></button>
                    <button onclick="deleteEditorPoint(${i})" title="Delete" style="background:none; border:none; color:#e74c3c; cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
                </div>`;
                list.appendChild(div);
            });
        }

        // Logic to handle dropping a waypoint (Array Reorder)
        function handleWpDrop(e) {
            if (e.stopPropagation) e.stopPropagation();

            const container = document.getElementById('active-route-list');
            const rows = [...container.querySelectorAll('.route-item')];
            const newArray = [];
            let newEditIndex = -1;

            rows.forEach((row, newIndex) => {
                const oldIndex = parseInt(row.dataset.index);
                newArray.push(editingRouteData[oldIndex]);

                // If we are currently manually editing a point (Manual Input Form Open),
                // track where it went so the index stays valid.
                if (activeEditIndex === oldIndex) {
                    newEditIndex = newIndex;
                }
            });

            editingRouteData = newArray;
            activeEditIndex = newEditIndex;

            // Visual Refresh
            renderEditorPoints();
            renderEditorMap();

            // Note: Persistence happens when user clicks "Save Changes", which uses the updated editingRouteData
        }

        function renderEditorMap() { editorLayer.clearLayers(); if (editingRouteData.length === 0) return; const latlngs = editingRouteData.map(p => [p.lat, p.lon]); const color = document.getElementById('save-color').value || "#78aabc"; if (latlngs.length > 1) L.polyline(latlngs, { color: color, weight: 3, dashArray: '5, 5' }).addTo(editorLayer); editingRouteData.forEach((pt, i) => { const isTgt = pt.type === 'tgt'; const isEditing = (activeEditIndex === i); const markerColor = isEditing ? '#00ff00' : (isTgt ? '#e74c3c' : '#ffffff'); const iconHtml = isTgt ? `<div style="color:${markerColor}; font-size:24px; filter:drop-shadow(0 0 3px black);"></div>` : `<div style="color:${markerColor}; font-size:24px; filter:drop-shadow(0 0 3px black);"><i class="fa-solid fa-location-dot"></i></div>`; const icon = L.divIcon({ className: 'edit-icon', html: iconHtml, iconSize: [24, 24], iconAnchor: [12, 24] }); const m = L.marker([pt.lat, pt.lon], { icon: icon, draggable: true }).addTo(editorLayer); if (showWpLabels) { m.bindTooltip(`${pt.name}`, { permanent: true, direction: 'right', className: 'airport-label' }); } m.on('dragend', function (event) { const newPos = event.target.getLatLng(); editingRouteData[i].lat = newPos.lat; editingRouteData[i].lon = newPos.lng; renderEditorMap(); renderEditorPoints(); if (activeEditIndex === i) fillManualForm(i); }); m.on('click', () => startManualEdit(i)); }); }
        // --- ALTITUDE HELPER ---
        async function calculateDualAltitudes(lat, lon, val, type) {
            // 1. Get Ground Elevation in Meters
            const elevM = await getGroundElevation(lat, lon);

            // 2. Input 'val' is ALREADY in Meters (passed from addPoint)
            const inputMeters = parseFloat(val);

            // 3. Calculate Both (Pure Meters)
            let msl = 0, agl = 0;

            if (type === 'AGL') {
                agl = inputMeters;
                msl = inputMeters + elevM;
            } else {
                msl = inputMeters;
                agl = inputMeters - elevM;
            }

            // Return integers for clean storage
            return { msl: Math.round(msl), agl: Math.round(agl) };
        }

        // --- ADDPOINT (ASYNC) ---
        async function addPoint(lat, lon, alt, altType, type) {
            let name = (type === 'wp') ? `WP ${wpCounter++}` : `TGT`;
            // Calculate the complement altitude
            const alts = await calculateDualAltitudes(lat, lon, alt, altType);
            editingRouteData.push({
                lat: lat,
                lon: lon,
                alt: alt,
                altType: altType,
                type: type,
                name: name,
                alt_msl: alts.msl, // New Field
                alt_agl: alts.agl  // New Field
            });

            renderEditorPoints();
            renderEditorMap();
        }

        function addManualPoint() {
            const type = document.getElementById('inp-type').value;
            const rawAlt = parseFloat(document.getElementById('global-alt').value) || 0;
            const altMeters = fromDisplayAlt(rawAlt);
            const altType = document.getElementById('global-alt-type').value;
            let lat = 0, lon = 0;

            if (settings.coords === 'mgrs') {
                let val = document.getElementById('inp-mgrs').value.trim().toUpperCase();
                const rawMatch = val.match(/^(\d{1,2}[C-X])([A-Z]{2})(\d{5})(\d{5})$/);
                if (rawMatch) {
                    val = `${rawMatch[1]} ${rawMatch[2]} ${rawMatch[3]} ${rawMatch[4]}`;
                }
                const result = LatLongFromMGRSstring(val);
                if (result && result[0]) {
                    lat = result[1];
                    lon = result[2];
                } else {
                    alert("Invalid MGRS format. Expecting: 38T KM 12345 67890");
                    return;
                }
            } else {
                lat = parseDMS(document.getElementById('inp-lat').value);
                lon = parseDMS(document.getElementById('inp-lon').value);
            }

            // Pass 'altMeters' (the converted value)
            if (lat && lon) addPoint(lat, lon, altMeters, altType, type);
        }

        function updateManualPoint(index) {
            const type = document.getElementById('inp-type').value;
            const rawAlt = parseFloat(document.getElementById('global-alt').value) || 0;
            const altMeters = fromDisplayAlt(rawAlt);
            const altType = document.getElementById('global-alt-type').value;
            const newName = document.getElementById('inp-name').value;
            let newLat = 0, newLon = 0;

            if (settings.coords === 'mgrs') {
                let val = document.getElementById('inp-mgrs').value.trim().toUpperCase();
                const rawMatch = val.match(/^(\d{1,2}[C-X])([A-Z]{2})(\d{5})(\d{5})$/);
                if (rawMatch) val = `${rawMatch[1]} ${rawMatch[2]} ${rawMatch[3]} ${rawMatch[4]}`;

                const result = LatLongFromMGRSstring(val);
                if (result && result[0]) {
                    newLat = result[1];
                    newLon = result[2];
                } else {
                    alert("Invalid MGRS format");
                    return;
                }
            } else {
                newLat = parseDMS(document.getElementById('inp-lat').value);
                newLon = parseDMS(document.getElementById('inp-lon').value);
            }

            if (!newLat || !newLon) { alert("Invalid Coordinates"); return; }

            // Save 'altMeters'
            editingRouteData[index] = { name: newName, lat: newLat, lon: newLon, alt: altMeters, altType: altType, type: type };
            closeManualInput();
        }

        function startManualEdit(index) { activeEditIndex = index; const pt = editingRouteData[index]; document.getElementById('manual-form').style.display = 'block'; document.getElementById('inp-name').value = pt.name; document.getElementById('inp-type').value = pt.type; document.getElementById('global-alt').value = pt.alt; document.getElementById('global-alt-type').value = pt.altType || 'MSL'; fillManualForm(index); const btn = document.getElementById('btn-add-point'); btn.innerText = "Update Point"; btn.onclick = () => updateManualPoint(index); renderEditorMap(); }

        function fillManualForm(index) {
            const pt = editingRouteData[index];
            const displayVal = toDisplayAlt(pt.alt);
            document.getElementById('global-alt').value = displayVal;

            if (settings.coords === 'mgrs') {
                try {
                    document.getElementById('inp-mgrs').value = MGRSString(pt.lat, pt.lon);
                } catch (e) { }
            } else {
                document.getElementById('inp-lat').value = toDmsInput(pt.lat, true);
                document.getElementById('inp-lon').value = toDmsInput(pt.lon, false);
            }
        }

        function closeManualInput() { activeEditIndex = -1; document.getElementById('manual-form').style.display = 'none'; if (typeof closeKeyboard === 'function') closeKeyboard(); const btn = document.getElementById('btn-add-point'); if (btn) { btn.innerText = "Add Point"; btn.onclick = addManualPoint; } renderEditorMap(); renderEditorPoints(); }
        function deleteEditorPoint(i) { editingRouteData.splice(i, 1); renderEditorPoints(); }
        function toggleMeasureTool() { distMode = !distMode; document.getElementById('btn-measure').classList.toggle('active', distMode); if (distMode) { document.getElementById('map').style.cursor = 'crosshair'; setClickMode('none'); } else { document.getElementById('map').style.cursor = 'default'; measureLayer.clearLayers(); distStart = null; } }
        function drawMeasureLine(start, end, isFinal, isRemote = false) {
            if (!isFinal) measureLayer.clearLayers();

            // Standard Drawing Logic
            L.circleMarker(start, { radius: 4, color: '#6C0E42' }).addTo(measureLayer);
            if (isFinal) L.circleMarker(end, { radius: 4, color: '#6C0E42' }).addTo(measureLayer);
            L.polyline([start, end], { color: '#6C0E42', weight: 1, dashArray: isFinal ? null : '5, 5' }).addTo(measureLayer);

            const distMeters = map.distance(start, end);
            let distStr = (settings.distUnit === 'nm') ? (distMeters * 0.000539957).toFixed(2) + " nm" : (distMeters / 1000).toFixed(2) + " km";
            L.marker(end, { icon: L.divIcon({ className: 'measure-label', html: distStr, iconSize: [60, 20] }) }).addTo(measureLayer);

            // Bearing Calc
            const lat1 = start.lat * Math.PI / 180; const lat2 = end.lat * Math.PI / 180; const dLon = (end.lng - start.lng) * Math.PI / 180;
            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            let brng = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
            L.marker(start, { icon: L.divIcon({ className: 'bearing-label', html: Math.round(brng) + "T", iconSize: [40, 20], iconAnchor: [40, 0] }) }).addTo(measureLayer);

            //  NEW: Send to server if this is a local user action
            if (!isRemote) {
                socket.emit('sync_measurement', {
                    start: start,
                    end: end,
                    isFinal: isFinal
                });
            }
        }

        function createPoi(lat, lon, name, isUserPos) {
            if (!activeMissionName && !isUserPos) { showToast("Select Mission First"); return; }
            const color = isUserPos ? '#00ff00' : '#ffff00';
            const label = isUserPos ? "My Pos" : (name || "Mark");
            const sidc = isUserPos ? "SFGPU-------" : "SHGPU-------";

            allPois.push({ lat, lon, name: label, color: color, sidc: sidc });

            renderPois();
            setClickMode('none');

            if (!isUserPos) {
                saveActiveMission();
            }
            if (activeMissionName) renderBrowserList();
        }

        function renderPois() {
            poiLayer.clearLayers();
            threatLayer.clearLayers();

            const showThreats = document.getElementById('chk-vis-threats') ? document.getElementById('chk-vis-threats').checked : true;

            // 1. Determine Unit Multiplier
            // If 'km': x1000. If 'nm' (default): x1852.
            const unitMult = (settings.distUnit === 'km') ? 1000 : 1852;

            const showPois = document.getElementById('chk-vis-poi') ? document.getElementById('chk-vis-poi').checked : true;

            allPois.forEach((poi, i) => {
                if (!showPois) return;

                const color = poi.color || '#ffff00';
                const center = [poi.lat, poi.lon];

                if (showThreats && poi.threatVisible !== false) {

                    // 2. Detect Range (Dash/Dot Line)
                    // Style: '10, 5, 2, 5' = 10px Line, 5px Gap, 2px Dot, 5px Gap
                    if (poi.threatDetectEnabled && poi.threatDetect > 0) {
                        L.circle(center, {
                            radius: poi.threatDetect * unitMult,
                            color: color,
                            weight: 1,
                            fill: false,             // Detect usually has no fill
                            dashArray: '10, 5, 2, 5',
                            opacity: 0.8,            // Line is visible (fixed opacity)
                            interactive: false
                        }).addTo(threatLayer);
                    }

                    // 3. Deadly Range (Dashed Line + Variable Fill)
                    // Style: '10, 10' = Standard Dashed
                    if (poi.threatDeadlyEnabled && poi.threatDeadly > 0) {
                        L.circle(center, {
                            radius: poi.threatDeadly * unitMult,
                            color: color,
                            weight: 1,
                            fill: true,
                            fillColor: color,
                            fillOpacity: threatFillOpacity, // <--- Controlled by Slider
                            dashArray: '10, 10',
                            opacity: 0.8,            // Line stays visible (fixed opacity)
                            interactive: false
                        }).addTo(threatLayer);
                    }
                }

                // --- RENDER ICON (Standard) ---
                let icon;
                if (!poi.sidc || poi.sidc === 'PIN') {
                    icon = L.divIcon({ className: 'poi-icon', html: `<i class="fa-solid fa-map-pin" style="color:${poi.color}; font-size:32px; filter:drop-shadow(0 3px 2px rgba(0,0,0,0.5));"></i>`, iconSize: [32, 32], iconAnchor: [16, 32] });
                } else {
                    try {
                        if (typeof ms !== 'undefined') {
                            const symb = new ms.Symbol(poi.sidc, { size: 28, colorMode: "Light" }).asCanvas();
                            icon = L.divIcon({ className: 'poi-icon', html: `<img src="${symb.toDataURL()}" style="width:100%; height:100%;">`, iconSize: [36, 36], iconAnchor: [18, 18] });
                        } else { throw new Error("No Lib"); }
                    } catch (e) { icon = L.divIcon({ className: 'poi-icon', html: '', iconSize: [24, 24] }); }
                }

                const m = L.marker(center, { icon: icon, draggable: true }).addTo(poiLayer);
                m.bindTooltip(poi.name, { direction: 'top', offset: [0, -35], permanent: showWpLabels, className: 'airport-label' });

                m.on('dragend', (e) => {
                    const pos = e.target.getLatLng();
                    allPois[i].lat = pos.lat;
                    allPois[i].lon = pos.lng;
                    renderPois();
                    saveActiveMission();
                });
                m.on('click', () => openPoiModal(i));
            });
        }


        function markCurrentPosition() { if (lastTelemetry && lastTelemetry.lat) createPoi(lastTelemetry.lat, lastTelemetry.lon, "My Pos", true); else showToast("No GPS Data"); }
        async function openPoiModal(index) {
            activePoiIndex = index;
            const poi = allPois[index];

            // 1. Populate Name & Color
            document.getElementById('poi-name').value = poi.name;
            document.getElementById('poi-color').value = poi.color || '#ffff00';

            // 2. Populate Checkboxes & Eye Icon
            document.getElementById('chk-poi-threat-detect').checked = (poi.threatDetectEnabled !== undefined) ? poi.threatDetectEnabled : false;
            document.getElementById('chk-poi-threat-deadly').checked = (poi.threatDeadlyEnabled !== undefined) ? poi.threatDeadlyEnabled : false;
            updatePoiThreatVisBtn(poi.threatVisible !== false);

            // 3. Setup Affiliation & Render Grid
            let currentCode = poi.sidc || "PIN";
            let affil = 'F';
            if (currentCode.length > 10) affil = currentCode.charAt(1);
            document.getElementById('poi-affil').value = affil;
            renderPoiSelector(); // Re-draw icons with correct Red/Blue color

            // 4. Select the Icon Visually (CRASH FIXED HERE)
            let partialToMatch = (currentCode === 'PIN') ? 'PIN' : currentCode.substring(4, 11);

            // Reset all highlights first
            document.querySelectorAll('.icon-opt').forEach(d => {
                d.classList.remove('selected');
                d.style.background = "#111";
                d.style.borderColor = "#444";
                d.style.color = "#777";
            });

            // Find the button using the dataset attribute we added
            const targetBtn = document.querySelector(`.icon-opt[data-code="${partialToMatch}"]`);

            // Manually trigger selection logic to setup UI (hiding color picker etc)
            // We pass 0,0 for ranges here because we will overwrite them in Step 5 anyway
            selectPoiIcon(partialToMatch, targetBtn, 0, 0);

            // 5. RESTORE SAVED RANGES
            // We do this AFTER selectPoiIcon, because selectPoiIcon tries to set defaults.
            // We want the values currently in the POI object.
            const savedDetect = poi.threatDetect || lastThreatDetect || 0;
            const savedDeadly = poi.threatDeadly || lastThreatDeadly || 0;
            document.getElementById('poi-threat-detect').value = savedDetect;
            document.getElementById('poi-threat-deadly').value = savedDeadly;

            // 6. Coordinates & Elevation Info
            const coordStr = formatCoordDisplay(poi.lat, poi.lon);
            document.getElementById('poi-info-coord').innerText = coordStr.replace('\n', ', ');
            const elBox = document.getElementById('poi-info-alt'); elBox.innerText = "Fetching...";
            const elevM = await getGroundElevation(poi.lat, poi.lon);
            let finalAlt = elevM; let unitStr = "m";
            if (settings.altUnit === 'ft') { finalAlt = elevM * 3.28084; unitStr = "ft"; }
            elBox.innerText = `${Math.round(finalAlt)} ${unitStr}`;

            // 7. Render Buttons
            const btnContainer = document.getElementById('poi-btn-container');
            btnContainer.innerHTML = `
            <button class="btn-full" onclick="activatePoiFromModal(${index})" style="background:#18611c; color:#aaa;">Navigate To</button>
            <button class="btn-full" onclick="savePoiEdit()" style="color:#aaa">Save</button>
            <button class="btn-full" onclick="deletePoi()" style="background:#5c2121; color:#aaa;">Delete</button>
            <button class="btn-full" onclick="closePoiModal()" style="background:#555; color:#aaa;">Cancel</button>
        `;

            document.getElementById('poi-modal').style.display = 'flex';
        }
        function activatePoiFromModal(index) {
            // Tell server to load POI list as route
            socket.emit('activate_poi_route', { index: index });

            // Update Local "Active Route" to match POIs so Green Line appears
            activeRouteName = "Visual Targets";
            activeRouteData = JSON.parse(JSON.stringify(allPois)); // Deep copy
            activeRouteData.forEach((p, i) => { p.name = `T${i + 1}`; p.type = 'poi'; }); // Format for Nav
            activeWpIndex = index;

            // Refresh UI
            updateMiniPanel();
            renderMapRoutes();
            closePoiModal();
            showToast(`Tracking T${index + 1}`);
        }

        // 3. Render POI Drawer List
        function renderPoiList() {
            const list = document.getElementById('poi-list-container');
            list.innerHTML = "";

            if (allPois.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:20px; color:#555;">No Visual Targets</div>`;
                return;
            }

            allPois.forEach((poi, i) => {
                const isActiveTarget = (activeRouteName === "Visual Targets" && activeWpIndex === i);
                const rawName = poi.name || "Mark";

                const div = document.createElement('div');
                div.className = `saved-route-item ${isActiveTarget ? 'is-active' : ''}`;

                // Drag Attributes
                div.setAttribute('draggable', 'true');
                div.dataset.originId = i;

                // Flex Layout matching Grid visuals
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.padding = '5px'; // Matches CSS padding
                div.style.gap = '0px';     // Matches CSS gap

                // Drag Event Listeners
                div.addEventListener('dragstart', () => div.classList.add('dragging'));
                div.addEventListener('dragend', () => {
                    div.classList.remove('dragging');
                    finishPoiSort();
                });

                const coordStr = formatCoordDisplay(poi.lat, poi.lon).replace(/\n/g, ' ');

                div.innerHTML = `
                <div style="width:20px; min-width:20px; text-align:center; font-weight:bold; color:${isActiveTarget ? '#0f0' : '#78aabc'}; font-size:11px; pointer-events:none;">
                    T${i + 1}
                </div>
                
                <div style="flex-grow:1; width:0; display:flex; align-items:center; justify-content:space-between; padding:0 5px; pointer-events:none; overflow:hidden;">
                    <span style="font-weight:bold; font-size:13px; color:#d1e3ea; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-right:5px;">
                        ${rawName}
                    </span>
                    <span style="font-family:'Consolas', monospace; color:#aaa; font-size:11px; white-space:nowrap; flex-shrink:0;">
                        ${coordStr}
                    </span>
                </div>

                <button class="list-btn" style="width:30px;" onclick="activatePoiFromModal(${i})" title="Set Active"><i class="fa-solid fa-crosshairs"></i></button>
                <button class="list-btn delete" style="width:30px;" onclick="activePoiIndex=${i}; deletePoi();" title="Delete"><i class="fa-solid fa-trash"></i></button>
            `;
                list.appendChild(div);
            });
        }

        // --- LIVE DRAG LOGIC ---
        const poiContainer = document.getElementById('poi-list-container');

        // 1. Live Sort on Hover
        poiContainer.addEventListener('dragover', e => {
            e.preventDefault();
            // UPDATED: Added 3rd argument '.saved-route-item' to use the generic function
            const afterElement = getDragAfterElement(poiContainer, e.clientY, '.saved-route-item');
            const draggable = document.querySelector('.dragging');
            if (!draggable) return;
            if (afterElement == null) poiContainer.appendChild(draggable);
            else poiContainer.insertBefore(draggable, afterElement);
        });

        // 3. Save New Order
        function finishPoiSort() {
            const listItems = document.querySelectorAll('#poi-list-container .saved-route-item');
            const newPois = [];
            let newActiveIndex = -1;

            listItems.forEach((item, newIndex) => {
                const originalIndex = parseInt(item.dataset.originId);
                newPois.push(allPois[originalIndex]);
                if (activeWpIndex === originalIndex) newActiveIndex = newIndex;
            });

            // Update Global Array
            allPois = newPois;

            // Update Nav Data if active
            if (activeRouteName === "Visual Targets") {
                activeRouteData = JSON.parse(JSON.stringify(allPois));
                activeRouteData.forEach((p, i) => { p.name = `T${i + 1}`; p.type = 'poi'; });
                activeWpIndex = newActiveIndex;
                updateServerNav();
            }
            saveActiveMission();
            renderPoiList();
            renderMapRoutes();
        }

        function savePoiEdit() {
            if (activePoiIndex === -1) return;
            const name = document.getElementById('poi-name').value;
            let finalSidc = 'PIN';
            let color = document.getElementById('poi-color').value;

            // --- SAVE THREAT DATA ---
            const tDetect = parseFloat(document.getElementById('poi-threat-detect').value) || 0;
            const tDeadly = parseFloat(document.getElementById('poi-threat-deadly').value) || 0;

            allPois[activePoiIndex].threatDetect = tDetect;
            allPois[activePoiIndex].threatDeadly = tDeadly;
            allPois[activePoiIndex].threatDetectEnabled = document.getElementById('chk-poi-threat-detect').checked;
            allPois[activePoiIndex].threatDeadlyEnabled = document.getElementById('chk-poi-threat-deadly').checked;

            // Update Memory (Script remembers last used)
            if (tDetect > 0) lastThreatDetect = tDetect;
            if (tDeadly > 0) lastThreatDeadly = tDeadly;

            // Existing Icon Logic
            if (selectedPoiSidcPartial !== 'PIN') {
                const aff = document.getElementById('poi-affil').value;
                let dim = 'G';
                if (selectedPoiSidcPartial.startsWith('M')) dim = 'A';
                if (selectedPoiSidcPartial.startsWith('N')) dim = 'S';
                finalSidc = `S${aff}${dim}P${selectedPoiSidcPartial}`;
                if (aff === 'H') color = '#e74c3c'; else if (aff === 'F') color = '#3498db'; else if (aff === 'N') color = '#2ecc71'; else color = '#f1c40f';
            }

            allPois[activePoiIndex].name = name;
            allPois[activePoiIndex].color = color;
            allPois[activePoiIndex].sidc = finalSidc;

            closePoiModal();
            renderPois();
            saveActiveMission();
            renderBrowserList();
        }

        function deletePoi() { if (activePoiIndex === -1) return; allPois.splice(activePoiIndex, 1); closePoiModal(); renderPois(); saveActiveMission(); renderBrowserList(); }
        function closePoiModal() { document.getElementById('poi-modal').style.display = 'none'; if (typeof closeKeyboard === 'function') closeKeyboard(); activePoiIndex = -1; }
        // --- NEW CONFIGURATION ARRAY ---
        const poiPresets = [
            // ROW 1: ANTI-AIR (Threat Rings: High to Low)
            { label: "SAM-L", code: "UCDS--", det: 45, dead: 30, desc: "Long Range SAM (SA-10/Patriot)" },
            { label: "SAM-M", code: "UCDM--", det: 25, dead: 18, desc: "Med Range SAM (SA-11/Hawk)" },
            { label: "SAM-S", code: "UCDT--", det: 8, dead: 5, desc: "Short Range SAM (SA-15/Roland)" },
            { label: "AAA", code: "UCDG--", det: 4, dead: 2, desc: "Anti-Air Artillery (Shilka)" },
            { label: "MANPAD", code: "UCIM--", det: 4, dead: 2.5, desc: "Shoulder Launch (Igla/Stinger)" },

            // ROW 2: GROUND & SUPPORT
            { label: "Armor", code: "UCA---", det: 0, dead: 2, desc: "Tank/IFV" },
            { label: "Recon", code: "UCR---", det: 0, dead: 0, desc: "Scout Vehicle" },
            { label: "Arty", code: "UCF---", det: 0, dead: 15, desc: "Howitzer/MLRS" },
            { label: "SCUD", code: "UCFM--", det: 0, dead: 60, desc: "Long Range Missile" },
            { label: "Inf", code: "UCI---", det: 0, dead: 0.5, desc: "Infantry" },

            // ROW 3: AIR, NAVAL, UTIL
            { label: "Ship", code: "IBN---", det: 60, dead: 30, desc: "Naval Unit" }, // should be NS----, but the current one is visiually easier
            { label: "Util", code: "UCV---", det: 0, dead: 0, desc: "Truck/Engineering" },
            { label: "Fighter", code: "MF----", det: 40, dead: 20, desc: "Fixed Wing Fighter" },
            { label: "Helo", code: "MH----", det: 10, dead: 5, desc: "Attack Helicopter" },
            { label: "Pin", code: "PIN", det: 0, dead: 0, desc: "Generic Marker" }
        ];

        function renderPoiSelector() {
            const container = document.querySelector('.icon-grid');
            container.innerHTML = "";

            const affilEl = document.getElementById('poi-affil');
            const affil = affilEl ? affilEl.value : 'H';

            poiPresets.forEach(p => {
                const div = document.createElement('div');
                div.className = "icon-opt";
                div.title = p.desc || p.label;

                // --- CRITICAL ADDITION HERE ---
                div.dataset.code = p.code;
                // ------------------------------

                div.onclick = function () { selectPoiIcon(p.code, this, p.det, p.dead); };

                if (p.code === 'PIN') {
                    div.innerHTML = `<div style="font-size: 24px; line-height:24px; margin-bottom:-2px;"></div><div>${p.label}</div>`;
                } else {
                    let base = "S" + affil;
                    if (p.code.startsWith('M')) base += "A";
                    else if (p.code.startsWith('N')) base += "S";
                    else base += "G";

                    const fullSidc = base + "P" + p.code;

                    try {
                        const sym = new ms.Symbol(fullSidc, { size: 30, frame: false, icon: true }).asCanvas();
                        div.appendChild(sym);
                        const lbl = document.createElement('div');
                        lbl.innerText = p.label;
                        lbl.style.marginTop = "0px";
                        div.appendChild(lbl);
                    } catch (e) {
                        div.innerText = p.label;
                    }
                }
                container.appendChild(div);
            });
        }

        function selectPoiIcon(sidcPartial, el, defaultDetect, defaultDeadly) {
            selectedPoiSidcPartial = sidcPartial;

            // 1. Visual Highlight (Reset others using CSS classes only)
            document.querySelectorAll('.icon-opt').forEach(d => {
                d.classList.remove('selected');
                // REMOVED: d.style.background = "#111";  <-- This was the culprit
                // REMOVED: d.style.borderColor = "#444";
                // REMOVED: d.style.color = "#777";

                // Clear any inline styles so CSS can take over
                d.style.background = "";
                d.style.borderColor = "";
                d.style.color = "";
            });

            if (el) {
                el.classList.add('selected');
                // We can keep specific highlight styles for the ACTIVE button if you want, 
                // or move this to CSS too. For now, we leave the active state dynamic.
                el.style.background = "rgba(120, 170, 188, 0.15)";
                el.style.borderColor = "#78aabc";
                el.style.color = "#d1e3ea";
            }

            // 2. Toggle Color Picker vs Affiliation Box
            const isPin = (sidcPartial === 'PIN');
            const affilBox = document.getElementById('box-affil-select');
            const colorBox = document.getElementById('box-color-picker');
            if (affilBox) affilBox.style.display = isPin ? 'none' : 'block';
            if (colorBox) colorBox.style.display = isPin ? 'block' : 'none';

            // 3. Pre-populate Threat Ranges
            const detInput = document.getElementById('poi-threat-detect');
            const deadInput = document.getElementById('poi-threat-deadly');
            const detChk = document.getElementById('chk-poi-threat-detect');
            const deadChk = document.getElementById('chk-poi-threat-deadly');

            if (detInput && deadInput) {
                // Only update if values differ from defaults (optional check) or just overwrite
                if (defaultDetect !== undefined) detInput.value = defaultDetect;
                if (defaultDeadly !== undefined) deadInput.value = defaultDeadly;

                if (detChk) detChk.checked = (defaultDetect > 0);
                if (deadChk) deadChk.checked = (defaultDeadly > 0);

                if (typeof lastThreatDetect !== 'undefined') lastThreatDetect = defaultDetect;
                if (typeof lastThreatDeadly !== 'undefined') lastThreatDeadly = defaultDeadly;
            }
        }
        let followMode = true; let headingUp = false;
        function toggleFollow() { followMode = !followMode; document.getElementById('btn-follow').classList.toggle('active', followMode); }
        function toggleHeadingUp() { headingUp = !headingUp; document.getElementById('btn-hdg-up').classList.toggle('active', headingUp); if (!headingUp) document.getElementById('map').style.transform = 'translate(0,0) rotate(0deg)'; }

        let pressTimer;
        map.on('mousedown', function (e) { pressTimer = setTimeout(() => { createPoi(e.latlng.lat, e.latlng.lng, "Mark", false); }, 800); });
        map.on('mouseup', function (e) { clearTimeout(pressTimer); });
        map.on('dragstart', () => { clearTimeout(pressTimer); if (followMode) toggleFollow(); });

        map.on('mousemove', function (e) {
            if (distMode && distStart) { drawMeasureLine(distStart, e.latlng, false); }
            const pill = document.getElementById('val-cursor');
            if (settings.coords === 'mgrs') {
                try { pill.innerText = MGRSString(e.latlng.lat, e.latlng.lng); } catch (err) { pill.innerText = "Err"; }
            }
            else {
                const toDms = (val, isLat) => {
                    const dir = val >= 0 ? (isLat ? 'N' : 'E') : (isLat ? 'S' : 'W');
                    const abs = Math.abs(val); const d = Math.floor(abs); const m = Math.floor((abs - d) * 60); const s = ((abs - d - m / 60) * 3600).toFixed(2);
                    return `${dir} ${String(d).padStart(isLat ? 2 : 3, '0')} ${String(m).padStart(2, '0')}' ${s}"`;
                };
                pill.innerText = `${toDms(e.latlng.lat, true)}  ${toDms(e.latlng.lng, false)}`;
            }
        });

        map.on('click', async function (e) {
            if (distMode) { if (!distStart) { distStart = e.latlng; measureLayer.clearLayers(); L.circleMarker(distStart, { radius: 4, color: '#6C0E42' }).addTo(measureLayer); } else { drawMeasureLine(distStart, e.latlng, true); distStart = null; } return; }
            if (clickMode === 'poi') { createPoi(e.latlng.lat, e.latlng.lng, "Mark", false); return; }

            if (clickMode === 'wp' || clickMode === 'tgt') {
                // 1. Get value from box (User Display Units) and Convert to Meters
                let userInput = parseFloat(document.getElementById('global-alt').value) || 0;
                let altMeters = fromDisplayAlt(userInput);
                let altType = document.getElementById('global-alt-type').value;

                if (clickMode === 'tgt') {
                    // 2. API Returns Meters. Store directly.
                    const groundMeters = await getGroundElevation(e.latlng.lat, e.latlng.lng);
                    altMeters = Math.round(groundMeters);
                    altType = 'MSL';
                }

                // 3. Save as Meters
                addPoint(e.latlng.lat, e.latlng.lng, altMeters, altType, clickMode);
            }
        });

        function scheduleViewSave() { if (isProgrammaticMove) return; if (mapMoveTimer) clearTimeout(mapMoveTimer); mapMoveTimer = setTimeout(() => { saveMapSettings(); }, 1000); }

        map.on('moveend', scheduleViewSave);
        map.on('zoomend', scheduleViewSave);

        // --- AIRPORT LOGIC ---
        let airportMarkers = {}; // Store references for ID access

        // Fix Z-Index Issue: Create a dedicated pane for static stations
        map.createPane('stationPane');
        map.getPane('stationPane').style.zIndex = 550; // Above tiles (200), below units (600)

        function renderAirports() {
            airportLayer.clearLayers();
            airportMarkers = {}; // Reset

            if (!allAirportsData) return;

            // Get Settings
            const neutralColor = document.getElementById('col-air-neutral') ? document.getElementById('col-air-neutral').value : '#aaaaaa';
            const altUnit = document.getElementById('opt-alt-unit') ? document.getElementById('opt-alt-unit').value : 'ft';

            Object.keys(allAirportsData).forEach(region => {
                const list = allAirportsData[region];
                list.forEach(ap => {
                    const icon = L.divIcon({
                        className: 'airport-icon',
                        html: `<i class="fa-solid fa-chess-rook" style="color:${neutralColor};"></i>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });

                    const mk = L.marker([ap.lat, ap.lon], { icon: icon, pane: 'stationPane' });

                    // Unit Conversion
                    let dispAlt = ap.alt; // Default meters
                    if (altUnit === 'ft') dispAlt = Math.round(ap.alt * 3.28084);

                    // Detailed Popup
                    const detailHtml = `
                        <div style="min-width:200px;">
                            <div style="font-weight:bold; color:#78aabc; border-bottom:1px solid #444; margin-bottom:5px;">${ap.name}</div>
                            <div style="font-size:11px; display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                                <span><i class="fa-solid fa-road"></i> ${ap.runway}</span>
                                <span><i class="fa-solid fa-compass"></i> ${ap.rwyHeading}</span>
                                <span><i class="fa-solid fa-wifi"></i> ${ap.atc} MHz</span>
                                <span><i class="fa-solid fa-tower-broadcast"></i> ${ap.tacan}</span>
                                <span style="color:#aaa;">ALT: ${dispAlt} ${altUnit}</span>
                                <span style="color:#aaa;">WP (FC3): ${ap.id}</span>
                            </div>
                        </div>
                    `;
                    mk.bindPopup(detailHtml);

                    // Hover Label
                    mk.bindTooltip(ap.name, {
                        permanent: showWpLabels,
                        direction: 'right',
                        className: 'airport-label',
                        offset: [10, 0]
                    });

                    mk.addTo(airportLayer);
                    airportMarkers[ap.name] = mk; // Store for lookup
                });
            });
        }
        // Toggle Logic for Settings Drawer
        function updateAirportStatus() {
            const isLive = document.getElementById('chk-live-air').checked;
            const neutralColor = document.getElementById('col-air-neutral') ? document.getElementById('col-air-neutral').value : '#aaaaaa';

            if (!isLive) {
                // RESET to Grey (User Color)
                for (let name in airportMarkers) {
                    const mk = airportMarkers[name];
                    const iconHtml = `<i class="fa-solid fa-chess-rook" style="color:${neutralColor};"></i>`;
                    mk.setIcon(L.divIcon({ className: 'airport-icon', html: iconHtml, iconSize: [20, 20], iconAnchor: [10, 10] }));
                }
            }
        }

        async function loadAirports() { try { const res = await fetch('/api/airports'); allAirportsData = await res.json(); renderAirports(); } catch (e) { console.log("Airport load failed:", e); } }

        // --- THEATER STATE (Phase 2b / 3a) ---
        const theaterUnits = {};
        socket.on('theater_state', function (data) {
            if (!data) return;
            const isLiveAirports = document.getElementById('chk-live-air') ? document.getElementById('chk-live-air').checked : false;

            // 1. Mark for Cleanup
            for (let id in theaterUnits) theaterUnits[id].updated = false;

            // 2. Update / Create
            data.forEach(u => {
                // Coalition: 1=Red, 2=Blue
                let color = '#aaaaaa';
                const isRed = (u.coalition === 1);
                const isBlue = (u.coalition === 2);
                const isNeutral = (!isRed && !isBlue);
                const showStatic = document.getElementById('chk-vis-unit-static') ? document.getElementById('chk-vis-unit-static').checked : true;

                // FILTERS
                const showRed = document.getElementById('chk-vis-unit-red') ? document.getElementById('chk-vis-unit-red').checked : true;
                const showBlue = document.getElementById('chk-vis-unit-blue') ? document.getElementById('chk-vis-unit-blue').checked : true;
                const showNeutral = document.getElementById('chk-vis-unit-neutral') ? document.getElementById('chk-vis-unit-neutral').checked : true;

                if (isRed && !showRed) return;
                if (isBlue && !showBlue) return;
                if (isNeutral && !showNeutral) return;

                if (isRed) color = '#e74c3c'; // Red
                else if (isBlue) color = '#3498db'; // Blue

                // PHASE 3a: AIRPORT MATCHING
                // If this unit name matches a known Airport, update the Static Marker instead of drawing a dot.
                if (airportMarkers[u.name]) {
                    if (isLiveAirports) {
                        const mk = airportMarkers[u.name];
                        const iconHtml = `<i class="fa-solid fa-chess-rook" style="color:${color}; text-shadow:0 0 5px ${color};"></i>`;

                        // Only update if not already set (Optimization?) 
                        // Actually Leaflet setIcon is cheap enough at 1Hz for <50 airports
                        mk.setIcon(L.divIcon({ className: 'airport-icon', html: iconHtml, iconSize: [20, 20], iconAnchor: [10, 10] }));
                    }
                    return; // Skip drawing a dot for this airport
                }

                // Lat/Lon check
                if (!u.lat || !u.long) return;

                if (theaterUnits[u.id]) {
                    // Update Position
                    theaterUnits[u.id].marker.setLatLng([u.lat, u.long]);
                    theaterUnits[u.id].updated = true;
                } else {
                    if (!showStatic) return; // Only apply static filter to these dots, not airports

                    // Create Marker
                    const m = L.circleMarker([u.lat, u.long], {
                        radius: 3,
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.8,
                        weight: 1
                    }).addTo(unitLayer);

                    // Tooltip
                    m.bindTooltip(`${u.name} [${u.type}]`, { direction: 'top', offset: [0, -5], className: 'active-leg-label' });

                    theaterUnits[u.id] = { marker: m, updated: true };
                }
            });

            // 3. Remove Missing
            for (let id in theaterUnits) {
                if (!theaterUnits[id].updated) {
                    if (unitLayer.hasLayer(theaterUnits[id].marker)) {
                        unitLayer.removeLayer(theaterUnits[id].marker);
                    }
                    delete theaterUnits[id];
                }
            }
        });

        socket.on('telemetry', function (data) { lastTelemetry = data; let altVal = (settings.altUnit === 'ft') ? data.alt * 3.28084 : data.alt; document.getElementById('val-alt').innerText = Math.round(altVal); document.getElementById('val-hdg').innerText = String(Math.round(data.hdg)).padStart(3, '0'); if (data.steer && typeof data.steer.index !== 'undefined') { if (activeRouteName && activeWpIndex !== data.steer.index) { activeWpIndex = data.steer.index; updateMiniPanel(); renderMapRoutes(); } } if (data.lat && data.lon) { planeMarker.setLatLng([data.lat, data.lon]); const jet = document.getElementById('my-jet'); if (jet) jet.style.transform = `rotate(${data.hdg}deg)`; if (headingUp) { document.getElementById('map').style.transform = `rotate(${-data.hdg}deg)`; if (jet) jet.style.transform = `rotate(0deg)`; map.panTo([data.lat, data.lon], { animate: false }); } else { if (jet) jet.style.transform = `rotate(${data.hdg}deg)`; if (followMode) map.panTo([data.lat, data.lon], { animate: true, duration: 0.5 }); } activeLegLayer.clearLayers(); if (activeRouteName && activeWpIndex >= 0 && activeWpIndex < activeRouteData.length) { const wp = activeRouteData[activeWpIndex]; L.polyline([[data.lat, data.lon], [wp.lat, wp.lon]], { color: '#0f0', weight: 4 }).addTo(activeLegLayer); } } });
        // --- POINTER VISUALS ---
        const pointerSvgs = {
            cross: (c) => `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 4V12M16 20V28M4 16H12M20 16H28" stroke="${c}" stroke-width="2" stroke-linecap="round"/><circle cx="16" cy="16" r="2" fill="${c}"/></svg>`,
            dot: (c) => `<svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="5" fill="${c}" stroke="none" stroke-width="1"/></svg>`,
            chevron: (c) => `<svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M8 20L16 12L24 20" stroke="${c}" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            circle: (c) => `<svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="8" stroke="${c}" stroke-width="2" fill="none"/></svg>`,
            x: (c) => `<svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M10 10L22 22M22 10L10 22" stroke="${c}" stroke-width="3" stroke-linecap="round"/></svg>`,
            arrow: (c) => `<svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M16 8L22 26L16 22L10 26L16 8Z" fill="${c}" stroke="none" stroke-width="1" stroke-linejoin="round"/></svg>`,
            diamond: (c) => `<svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect x="16" y="6" width="12" height="12" transform="rotate(45 16 6)" fill="none" stroke="${c}" stroke-width="2"/></svg>`,
            square: (c) => `<svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect x="11" y="11" width="10" height="10" stroke="${c}" stroke-width="2" fill="none"/></svg>`,
        };

        function updatePointerVisuals() {
            const style = document.getElementById('opt-ptr-style').value || 'cross';
            const color = document.getElementById('opt-ptr-color').value || '#00ff00';
            const svgGen = pointerSvgs[style] || pointerSvgs['cross'];
            const svgString = svgGen(color);
            const encoded = encodeURIComponent(svgString);

            const cursor = document.getElementById('virtual-cursor');
            if (cursor) {
                cursor.style.backgroundImage = `url("data:image/svg+xml;charset=utf-8,${encoded}")`;
            }
        }

        // --- BLOCK REAL MOUSE INTERFERENCE ---
        const blockRealMouse = (e) => {
            if (VirtualPointer.active && e.isTrusted) {
                e.preventDefault();
                e.stopPropagation();
            }
        };
        const eventsToBlock = ['mousedown', 'mouseup', 'mousemove', 'click', 'dblclick', 'pointerdown', 'pointerup', 'pointermove', 'contextmenu'];

        // --- VIRTUAL POINTER CLASS ---
        const VirtualPointer = {
            el: document.getElementById('virtual-cursor'),
            active: false,
            isDown: false,
            lastX: 0, lastY: 0,
            downX: 0, downY: 0,
            lastClickTime: 0,

            toggle: function (isActive) {
                this.active = isActive;
                if (this.el) {
                    this.el.style.display = isActive ? 'block' : 'none';
                    this.el.style.position = 'fixed';
                    this.el.style.zIndex = '9999';
                }
                document.body.style.cursor = isActive ? 'none' : 'default';
                showToast(`Pointer Mode: ${isActive ? 'ON' : 'OFF'}`);
            },

            update: function (x, y, isNorm) {
                if (!this.el) return;
                let px = isNorm ? x * window.innerWidth : x;
                let py = isNorm ? y * window.innerHeight : y;

                this.el.style.transform = `translate(${px - 16}px, ${py - 16}px)`;

                if (this.isDown) {
                    // Drag Logic
                    let dx = px - this.downX;
                    let dy = py - this.downY;
                    let dist = Math.hypot(dx, dy);

                    if (dist > 3) {
                        let target = document.elementFromPoint(px, py) || document;
                        target.dispatchEvent(new PointerEvent('pointermove', { bubbles: true, cancelable: true, view: window, clientX: px, clientY: py, buttons: 1, pointerId: 1, pointerType: 'mouse', isPrimary: true }));
                        target.dispatchEvent(new MouseEvent('mousemove', { bubbles: true, cancelable: true, view: window, clientX: px, clientY: py, buttons: 1 }));
                    }
                } else {
                    // Hover Logic
                    let target = document.elementFromPoint(px, py) || document;
                    target.dispatchEvent(new PointerEvent('pointermove', { bubbles: true, cancelable: true, view: window, clientX: px, clientY: py, buttons: 0, pointerId: 1, pointerType: 'mouse', isPrimary: true }));
                }
                this.lastX = px; this.lastY = py;
            },

            press: function (x, y, isNorm) {
                this.isDown = true;
                let px = (isNorm !== undefined) ? (isNorm ? x * window.innerWidth : x) : this.lastX;
                let py = (isNorm !== undefined) ? (isNorm ? y * window.innerHeight : y) : this.lastY;
                this.lastX = px; this.lastY = py;
                this.downX = px; this.downY = py;

                if (this.el) this.el.style.display = 'none';
                let el = document.elementFromPoint(px, py);
                if (this.el && this.active) this.el.style.display = 'block';

                if (el) {
                    el.dispatchEvent(new PointerEvent('pointerdown', { bubbles: true, cancelable: true, view: window, clientX: px, clientY: py, buttons: 1, button: 0, pointerId: 1, pointerType: 'mouse', isPrimary: true }));
                    el.dispatchEvent(new MouseEvent('mousedown', { bubbles: true, cancelable: true, view: window, clientX: px, clientY: py, buttons: 1, button: 0 }));

                    const rip = document.createElement('div');
                    rip.className = 'click-rip';
                    rip.style.left = px + 'px';
                    rip.style.top = py + 'px';
                    document.body.appendChild(rip);
                    setTimeout(() => rip.remove(), 600);
                }
            },

            release: function (x, y, isNorm) {
                this.isDown = false;
                let px = (isNorm !== undefined) ? (isNorm ? x * window.innerWidth : x) : this.lastX;
                let py = (isNorm !== undefined) ? (isNorm ? y * window.innerHeight : y) : this.lastY;

                if (this.el) this.el.style.display = 'none';
                let el = document.elementFromPoint(px, py);
                if (this.el && this.active) this.el.style.display = 'block';

                let dx = px - this.downX;
                let dy = py - this.downY;
                let isDrag = Math.hypot(dx, dy) > 5;

                if (isDrag) {
                    let evUp = new MouseEvent('mouseup', { bubbles: true, cancelable: true, view: window, clientX: px, clientY: py, buttons: 0, button: 0 });
                    window.dispatchEvent(evUp);
                    document.dispatchEvent(evUp);
                } else {
                    if (el) {
                        el.dispatchEvent(new MouseEvent('mouseup', { bubbles: true, cancelable: true, view: window, clientX: px, clientY: py, buttons: 0, button: 0 }));
                        el.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true, view: window, clientX: px, clientY: py, buttons: 0, button: 0 }));

                        const now = Date.now();
                        if (this.lastClickTime && (now - this.lastClickTime < 300)) {
                            el.dispatchEvent(new MouseEvent('dblclick', { bubbles: true, cancelable: true, view: window, clientX: px, clientY: py, buttons: 0, button: 0 }));
                            this.lastClickTime = 0;
                        } else {
                            this.lastClickTime = now;
                        }
                    }
                }
                this.downX = 0; this.downY = 0;

                let rip = document.createElement('div');
                rip.classList.add('pointer-click-anim');
                rip.style.position = 'fixed';
                rip.style.left = px + 'px';
                rip.style.top = py + 'px';
                rip.style.pointerEvents = 'none';
                document.body.appendChild(rip);
                setTimeout(() => rip.remove(), 500);
            }
        };

        // --- POINTER MODE SOCKETS ---
        socket.on('pointer_mode_status', function (data) { VirtualPointer.toggle(data.active); });
        socket.on('pointer_update', function (data) { VirtualPointer.update(data.x, data.y, data.norm); });
        socket.on('simulate_pointer_down', function (data) { VirtualPointer.press(data.x, data.y, data.norm); });
        socket.on('simulate_pointer_up', function (data) { VirtualPointer.release(data.x, data.y, data.norm); });

        // Safely Attach Listeners
        if (typeof eventsToBlock !== 'undefined') {
            eventsToBlock.forEach(evt => {
                window.addEventListener(evt, blockRealMouse, true);
            });
        }

        socket.on('tactical', function (packet) {
            if (!packet.data) return;

            // --- FILTER PRE-CHECK ---
            const showAir = document.getElementById('chk-vis-unit-air') ? document.getElementById('chk-vis-unit-air').checked : true;
            const showGround = document.getElementById('chk-vis-unit-ground') ? document.getElementById('chk-vis-unit-ground').checked : true;
            const showNaval = document.getElementById('chk-vis-unit-naval') ? document.getElementById('chk-vis-unit-naval').checked : true;
            const showRed = document.getElementById('chk-vis-unit-red') ? document.getElementById('chk-vis-unit-red').checked : true;
            const showBlue = document.getElementById('chk-vis-unit-blue') ? document.getElementById('chk-vis-unit-blue').checked : true;
            const showNeutral = document.getElementById('chk-vis-unit-neutral') ? document.getElementById('chk-vis-unit-neutral').checked : true;

            for (let id in tacticalUnits) { tacticalUnits[id].updated = false; }

            packet.data.forEach(u => {
                let aff = (u.coa === 1) ? 'H' : (u.coa === 2) ? 'F' : 'N';

                // --- APPLY FILTERS ---
                // 1. Affiliation
                if (aff === 'H' && !showRed) return;
                if (aff === 'F' && !showBlue) return;
                if (aff === 'N' && !showNeutral) return;

                // 2. Type
                let isAir = (u.typ === 'air');
                let isHeli = (u.typ === 'heli');
                let isSea = (u.typ === 'sea');
                // Assume everything else is Ground ??? Or check more specific types if available
                let isGround = (!isAir && !isHeli && !isSea);

                if ((isAir || isHeli) && !showAir) return;
                if (isSea && !showNaval) return;
                if (isGround && !showGround) return;


                let battleDim = 'G';
                let func = 'U-------';
                if (u.typ === 'air') { battleDim = 'A'; func = 'PMF-----'; }
                else if (u.typ === 'heli') { battleDim = 'A'; func = 'PMH-----'; }
                else if (u.typ === 'sea') { battleDim = 'S'; func = 'P-------'; }
                const sidc = `S${aff}${battleDim}P${func}`;

                if (tacticalUnits[u.id]) {
                    tacticalUnits[u.id].marker.setLatLng([u.lat, u.lon]);
                    tacticalUnits[u.id].updated = true;
                } else {
                    let icon;
                    try {
                        if (typeof ms !== 'undefined') {
                            const sym = new ms.Symbol(sidc, { size: 20, colorMode: "Light" }).asCanvas();
                            icon = L.divIcon({ className: 'tac-icon', html: `<img src="${sym.toDataURL()}" style="width:100%; height:100%;">`, iconSize: [28, 28], iconAnchor: [14, 14] });
                        } else { throw new Error("No Milsymbol"); }
                    } catch (e) {
                        icon = L.divIcon({ className: 'tac-icon', html: `<div style="width:10px; height:10px; background:red;"></div>`, iconSize: [10, 10] });
                    }
                    const m = L.marker([u.lat, u.lon], { icon: icon, zIndexOffset: 100 }).addTo(unitLayer).bindTooltip(`Unit ${u.id}`);
                    tacticalUnits[u.id] = { marker: m, updated: true };
                }
            });

            for (let id in tacticalUnits) {
                if (!tacticalUnits[id].updated) {
                    unitLayer.removeLayer(tacticalUnits[id].marker);
                    delete tacticalUnits[id];
                }
            }
        });
        socket.on('apply_settings', (data) => { });

        let activeInputId = null;
        function openKeyboard(inputId, type) { activeInputId = inputId; const kb = document.getElementById('virtual-keyboard'); const container = document.getElementById('kb-keys-container'); container.innerHTML = ''; const numericKeys = [['7', '8', '9'], ['4', '5', '6'], ['1', '2', '3'], ['0', '.', 'BS']]; const fullKeys = [['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'], ['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P'], ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L'], ['Z', 'X', 'C', 'V', 'B', 'N', 'M', '.', 'BS']]; const layout = (type === 'number') ? numericKeys : fullKeys; layout.forEach(row => { const rowDiv = document.createElement('div'); rowDiv.className = 'kb-row'; row.forEach(key => { const btn = document.createElement('button'); btn.className = 'kb-key'; if (key === 'BS') { btn.innerHTML = '<i class="fa-solid fa-delete-left"></i>'; btn.className += ' action'; btn.onclick = () => handleKey('BACKSPACE'); } else { btn.innerText = key; btn.onclick = () => handleKey(key); } rowDiv.appendChild(btn); }); container.appendChild(rowDiv); }); const actionRow = document.createElement('div'); actionRow.className = 'kb-row'; actionRow.style.marginTop = "5px"; const spaceBtn = document.createElement('button'); spaceBtn.className = 'kb-key wide'; spaceBtn.innerText = "SPACE"; spaceBtn.onclick = () => handleKey('SPACE'); if (type !== 'number') actionRow.appendChild(spaceBtn); const entBtn = document.createElement('button'); entBtn.className = 'kb-key enter wide'; entBtn.innerText = "DONE"; entBtn.onclick = closeKeyboard; actionRow.appendChild(entBtn); container.appendChild(actionRow); kb.classList.add('visible'); }
        function closeKeyboard() { document.getElementById('virtual-keyboard').classList.remove('visible'); activeInputId = null; }
        function handleKey(val) { if (!activeInputId) return; const input = document.getElementById(activeInputId); if (val === 'BACKSPACE') input.value = input.value.slice(0, -1); else if (val === 'SPACE') input.value += " "; else input.value += val; input.dispatchEvent(new Event('input')); input.dispatchEvent(new Event('change')); }

        // --- DYNAMIC LAYOUT OBSERVER ---
        const layoutObserver = new ResizeObserver(entries => { for (let entry of entries) { const totalHeight = entry.target.offsetHeight; document.documentElement.style.setProperty('--bottom-bar-height', `${totalHeight}px`); } });
        const bottomBarEl = document.getElementById('bottom-bar'); if (bottomBarEl) layoutObserver.observe(bottomBarEl);

        // --- Data Cartridge  LOGIC ---
        let pendingImportData = null;
        let html5QrcodeScanner = null;

        function closeModal(type) { document.getElementById(`modal-${type}`).style.display = 'none'; if (type === 'import' && html5QrCode && html5QrCode.isScanning) { html5QrCode.stop().then(() => { html5QrCode.clear(); }).catch(err => console.log("Stop failed", err)); } }

        // --- SENDER LOGIC ---
        function openShareModal() {
            const select = document.getElementById('share-mission-select');
            select.innerHTML = "";

            // Populate Missions
            Object.keys(missions).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = key;
                if (key === activeMissionName) opt.selected = true;
                select.appendChild(opt);
            });

            document.getElementById('modal-share').style.display = 'flex';
            document.getElementById('qr-result-area').style.display = 'none';

            updateShareList(); // Populate routes based on selection
        }

        function updateShareList() {
            const missionName = document.getElementById('share-mission-select').value;
            const list = document.getElementById('share-routes-list');
            list.innerHTML = '';

            if (!missions[missionName]) return;

            const mRoutes = missions[missionName].routes || {};
            const mPois = missions[missionName].pois || [];

            // Routes Checkboxes
            if (Object.keys(mRoutes).length === 0) {
                list.innerHTML = '<div style="padding:10px; color:#777; font-style:italic;">No routes in this mission.</div>';
            } else {
                Object.keys(mRoutes).forEach(name => {
                    const row = document.createElement('label');
                    row.className = 'chk-item';
                    row.innerHTML = `<input type="checkbox" value="${name}"> <span>${name}</span>`;
                    list.appendChild(row);
                });
            }

            // POI Checkbox Label Update
            const poiLbl = document.getElementById('share-pois').nextElementSibling;
            if (poiLbl) poiLbl.innerText = `Include POI List (${mPois.length} Targets)`;
        }

        function generateMissionQR() {
            const missionName = document.getElementById('share-mission-select').value;
            const targetMission = missions[missionName];
            if (!targetMission) return;

            const selectedRoutes = {};
            document.querySelectorAll('#share-routes-list input:checked').forEach(chk => {
                selectedRoutes[chk.value] = targetMission.routes[chk.value];
            });

            const includePois = document.getElementById('share-pois').checked;
            const sender = document.getElementById('share-sender').value || "Commander";
            const briefing = document.getElementById('share-briefing').value || ""; // <--- GET BRIEFING

            const payload = {
                protocol: "dcs-mission-v1",
                meta: {
                    sender: sender,
                    info: missionName,
                    briefing: briefing, // <--- ADD TO META
                    ts: Date.now()
                },
                payload: {
                    routes: selectedRoutes,
                    pois: includePois ? (targetMission.pois || []) : []
                }
            };

            // ... existing QR generation logic ...
            const jsonStr = JSON.stringify(payload);
            if (jsonStr.length > 2500) { alert("Data too large for QR."); return; }
            document.getElementById('qr-result-area').style.display = 'block';
            document.getElementById('qr-output').innerHTML = '';
            new QRCode(document.getElementById("qr-output"), {
                text: jsonStr, width: 256, height: 256, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.L
            });
        }

        function downloadQR() {
            const qrContainer = document.getElementById("qr-output");

            // Try to find the image created by qrcode.js
            let img = qrContainer.querySelector("img");
            let url = "";

            if (img) {
                url = img.src;
            } else {
                // Fallback: If the library rendered a Canvas instead
                const canvas = qrContainer.querySelector("canvas");
                if (canvas) {
                    url = canvas.toDataURL("image/png");
                }
            }

            if (url) {
                const link = document.createElement("a");
                link.href = url;
                link.download = "dcs_mission_qr.png";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert("QR Code not generated yet.");
            }
        }

        // --- RECEIVER LOGIC ---
        let html5QrCode; // Global variable for the instance

        function openImportModal() {
            document.getElementById('modal-import').style.display = 'flex';
            document.getElementById('import-step-1').style.display = 'block';
            document.getElementById('import-step-2').style.display = 'none';

            // 1. Initialize the Core Engine (No Default UI)
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }

            // 2. Start Camera Automatically
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            // Prefer back camera ('environment') on mobile
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                .catch(err => {
                    // If camera fails (or on desktop without cam), show specific error
                    console.log("Camera Start Error:", err);
                    document.getElementById('reader').innerHTML =
                        `<div style="padding:20px; color:#e74c3c; font-size:12px;">
                    <i class="fa-solid fa-video-slash" style="font-size:24px; margin-bottom:10px;"></i><br>
                    CAMERA NOT FOUND OR DENIED<br>
                    <span style="color:#777;">Use Drop Zone below</span>
                </div>`;
                });

            // File Input Fallback logic remains the same
            document.getElementById('qr-file-input').onchange = e => {
                if (e.target.files.length == 0) return;
                html5QrCode.scanFile(e.target.files[0], true)
                    .then(onScanSuccess)
                    .catch(err => alert(`Error scanning file: ${err}`));
            };
        }

        function onScanSuccess(decodedText, decodedResult) {
            try {
                const data = JSON.parse(decodedText);
                if (data.protocol !== "dcs-mission-v1") throw new Error("Invalid Protocol");

                // Stop Scanner immediately on success
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => html5QrCode.clear());
                }

                // Pass to the shared processor
                processImportData(data);

            } catch (e) {
                console.error(e);
                alert("Invalid QR Code. Must be a DCS Mission v1 code.");
            }
        }

        function onScanFailure(error) { }

        function processImportData(data) {
            pendingImportData = data;
            const missionName = data.meta.info || "Imported Mission";

            // Check if mission name already exists
            if (missions[missionName]) {
                showImportConflict(missionName);
            } else {
                // Direct import if no name clash (Defaults to 'new' logic)
                finalizeImport('new', missionName);
            }
        }

        function showImportConflict(name) {
            // UI Flip: Show step 2, hide step 1
            document.getElementById('import-step-2').style.display = 'block';
            document.getElementById('import-step-1').style.display = 'none';

            document.getElementById('import-meta-sender').innerText = `CONFLICT: Mission "${name}" exists.`;
            document.getElementById('import-meta-info').innerText = "Select merge or replace strategy:";

            const manifest = document.getElementById('import-manifest');
            manifest.innerHTML = `
            <li style="color:var(--accent)"><b>MERGE:</b> Combine new data with existing file.</li>
            <li style="color:var(--red-for)"><b>REPLACE:</b> Overwrite existing mission entirely.</li>
            <li style="color:#2ecc71"><b>NEW:</b> Save as "${name} [COPY]".</li>
        `;

            // Clear and build dynamic strategy buttons
            const container = document.querySelector('#import-step-2');
            container.querySelectorAll('.dynamic-import-btn').forEach(b => b.remove());

            const btnHtml = `
            <button class="btn-full btn-action dynamic-import-btn" style="margin-top:10px;" onclick="finalizeImport('merge', '${name}')">MERGE INTO EXISTING</button>
            <button class="btn-full btn-danger dynamic-import-btn" style="margin-top:5px;" onclick="finalizeImport('replace', '${name}')">REPLACE EXISTING</button>
            <button class="btn-full btn-success dynamic-import-btn" style="margin-top:5px;" onclick="finalizeImport('new', '${name}')">IMPORT AS NEW (COPY)</button>
        `;
            // Insert before the Discard button
            const discardBtn = container.querySelector('.btn-danger:not(.dynamic-import-btn)');
            discardBtn.insertAdjacentHTML('beforebegin', btnHtml);
        }

        function finalizeImport(mode, name) {
            if (!pendingImportData) return;

            let targetName = name;
            if (mode === 'new') {
                const suffix = " [COPY " + Date.now().toString().slice(-4) + "]";
                targetName = name + suffix;
            }

            if (mode === 'replace' || mode === 'new') {
                missions[targetName] = {
                    imported: "I",
                    map: pendingImportData.meta.map || null,
                    routes: pendingImportData.payload.routes || {},
                    pois: pendingImportData.payload.pois || []
                };
            } else if (mode === 'merge') {
                // 1. Merge Routes (Keys in 'routes' object)
                if (!missions[targetName].routes) missions[targetName].routes = {};
                Object.assign(missions[targetName].routes, pendingImportData.payload.routes);

                // 2. Merge POIs (Append and prevent duplicates by coordinate)
                if (!missions[targetName].pois) missions[targetName].pois = [];
                const existingPois = missions[targetName].pois;
                pendingImportData.payload.pois.forEach(newP => {
                    const exists = existingPois.some(ep => ep.lat === newP.lat && ep.lon === newP.lon);
                    if (!exists) existingPois.push(newP);
                });
                missions[targetName].pois = existingPois;
            }

            saveAllMissions().then(() => {
                showToast(`Import Success: ${targetName}`);
                selectMission(targetName);
                closeModal('import');
                // UI Reset
                document.querySelectorAll('.dynamic-import-btn').forEach(b => b.remove());
            });
        }

        // --- GLOBAL DRAG LISTENERS FOR CONTAINERS ---

        // 1. Route List Container
        const savedListContainer = document.getElementById('saved-list');
        savedListContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            // Uses the generic getDragAfterElement you already have
            const afterElement = getDragAfterElement(savedListContainer, e.clientY, '.saved-route-item');
            const draggable = document.querySelector('.dragging');

            // Safety: ensure we are dragging the right type of item
            if (!draggable || !draggable.classList.contains('saved-route-item')) return;

            if (afterElement == null) savedListContainer.appendChild(draggable);
            else savedListContainer.insertBefore(draggable, afterElement);
        });
        savedListContainer.addEventListener('drop', handleRouteListDrop);

        // 2. Waypoint List Container
        const wpListContainer = document.getElementById('active-route-list');
        wpListContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            const afterElement = getDragAfterElement(wpListContainer, e.clientY, '.route-item');
            const draggable = document.querySelector('.dragging');
            if (!draggable || !draggable.classList.contains('route-item')) return;
            if (afterElement == null) wpListContainer.appendChild(draggable);
            else wpListContainer.insertBefore(draggable, afterElement);
        });

        wpListContainer.addEventListener('drop', handleWpDrop);

        // 3. QR Import Drop Zone
        const dropArea = document.getElementById('drop-area');

        // Prevent default behaviors for the drop zone
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        // Visual Highlight effects
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false);
        });

        // Handle File Drop
        // Search for: dropArea.addEventListener('drop', (e) => {
        // REPLACE the inner logic:

        dropArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                const file = files[0];

                if (file.type === "application/json" || file.name.endsWith('.json')) {
                    // HANDLE DIRECT FILE IMPORT
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.protocol === "dcs-mission-v1") {
                                processImportData(data);
                            } else {
                                alert("Not a valid DCS Mission file.");
                            }
                        } catch (e) { alert("Error reading JSON file."); }
                    };
                    reader.readAsText(file);
                } else {
                    // HANDLE QR IMAGE SCAN
                    const html5QrCode = new Html5Qrcode("reader");
                    html5QrCode.scanFile(file, true)
                        .then(decodedText => {
                            const data = JSON.parse(decodedText);
                            processImportData(data);
                        })
                        .catch(err => alert(`Error scanning image: ${err}`));
                }
            }
        }, false);

        // --- 3-FINGER GESTURE HANDLER ---
        const TouchGestures = {
            active: false,
            startTime: 0,
            timer: null,
            holdTriggered: false,

            init: function () {
                // Use 'passive: false' to ensure we read touches reliably without browser interference
                document.body.addEventListener('touchstart', this.handleStart.bind(this), { passive: true });
                document.body.addEventListener('touchend', this.handleEnd.bind(this));
                document.body.addEventListener('touchcancel', this.reset.bind(this));
            },

            handleStart: function (e) {
                // Strictly detect 3 fingers
                if (e.touches.length === 3) {
                    this.active = true;
                    this.holdTriggered = false;
                    this.startTime = Date.now();

                    // Start the Hold Timer
                    this.timer = setTimeout(() => {
                        if (this.active) {
                            this.holdTriggered = true;

                            // 3-Finger HOLD Action -> Full Screen
                            toggleFullScreen();

                            // Haptic feedback if supported
                            if (navigator.vibrate) navigator.vibrate(50);
                        }
                    }, 800); // 800ms threshold for "Hold"
                } else {
                    // If user puts down 4 fingers or removes one, invalidate
                    if (e.touches.length > 3) this.reset();
                }
            },

            handleEnd: function (e) {
                if (!this.active) return;

                // Calculate how long the fingers were down
                const duration = Date.now() - this.startTime;

                // If fingers are lifted (touches < 3)
                if (e.touches.length < 3) {
                    // Clear the hold timer immediately
                    clearTimeout(this.timer);

                    // 3-Finger TAP Action -> Settings
                    // Condition: Short duration AND Hold wasn't already triggered
                    if (duration < 400 && !this.holdTriggered) {
                        toggleDrawer('settings');
                    }

                    // Reset state now that fingers are lifting
                    this.active = false;
                }
            },

            reset: function () {
                this.active = false;
                this.holdTriggered = false;
                clearTimeout(this.timer);
            }
        };

        // Initialize the listener
        TouchGestures.init();

        // --- SYNC VISIBILITY (Settings <-> Route Manager) ---
        map.on('layeradd', function (e) { if (e.layer === poiLayer) { const chk = document.getElementById('chk-vis-poi'); if (chk) chk.checked = true; const btn = document.getElementById('btn-vis-poi-list'); if (btn) btn.classList.add('active'); } });
        map.on('layerremove', function (e) { if (e.layer === poiLayer) { const chk = document.getElementById('chk-vis-poi'); if (chk) chk.checked = false; const btn = document.getElementById('btn-vis-poi-list'); if (btn) btn.classList.remove('active'); } });

        function exportMissionToFile() {
            const missionName = document.getElementById('share-mission-select').value;
            const targetMission = missions[missionName];
            if (!targetMission) return;

            // Build the same payload structure as QR for compatibility
            const payload = {
                protocol: "dcs-mission-v1",
                meta: {
                    sender: document.getElementById('share-sender').value || "Commander",
                    info: missionName,
                    briefing: document.getElementById('share-briefing').value || "",
                    ts: Date.now(),
                    is_file: true
                },
                payload: {
                    routes: targetMission.routes || {},
                    pois: targetMission.pois || []
                }
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(payload));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", missionName.replace(/\s+/g, '_') + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast("File Exported");
        }

        // Toggle specific POI visibility in modal
        function togglePoiThreatVis() { if (activePoiIndex === -1) return; const current = (allPois[activePoiIndex].threatVisible !== false); allPois[activePoiIndex].threatVisible = !current; updatePoiThreatVisBtn(!current); }

        // --- COALITION TOGGLE LOGIC ---
        function toggleCoalition(side) {
            const btn = document.getElementById(`btn-vis-${side}`);
            const chk = document.getElementById(`chk-vis-unit-${side}`);
            if (btn && chk) {
                chk.checked = !chk.checked;
                btn.classList.toggle('active', chk.checked);
                saveMapSettings();
                renderPois();
            }
        }

        function updatePoiThreatVisBtn(isVisible) {
            const btn = document.getElementById('btn-poi-threat-vis');
            if (isVisible) {
                btn.classList.add('active');
                btn.innerHTML = '<i class="fa-solid fa-eye"></i>';
                btn.style.color = "#78aabc";
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
                btn.style.color = "#555";
            }
        }

        function updateThreatFill(val) { threatFillOpacity = val / 100; renderPois(); }

        loadAirports(); loadMapSettings(); loadSavedRoutes(); loadSavedPois();

    </script>
    <div id="virtual-cursor"></div>
    <div id="scratchpad-layer">
        <div id="sp-text-cursor">SCRATCHPAD MODE</div>
        <canvas id="scratchpad-canvas"></canvas>
    </div>
</body>

</html>